<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MyTrips</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#ffffff;
      --text:#111;
      --muted:#6b7280;
      --border:#e5e7eb;
      --card:#ffffff;
      --shadow: 0 8px 24px rgba(0,0,0,0.06);

      --flight:#2563eb;
      --hotel:#7c3aed;
      --activity:#16a34a;
      --transfer:#f59e0b;
      --other:#64748b;

      --flightBg: rgba(37,99,235,.08);
      --hotelBg: rgba(124,58,237,.08);
      --activityBg: rgba(22,163,74,.08);
      --transferBg: rgba(245,158,11,.10);
      --otherBg: rgba(100,116,139,.08);
    }

    body{
      font-family: Arial, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }

    .container{
      max-width: 980px;
      margin: 0 auto;
      padding: 26px;
    }

    .header{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom: 16px;
    }

    h1{
      margin:0;
      font-size: 34px;
      letter-spacing: -0.4px;
    }

    h2{
      margin: 18px 0 10px;
      font-size: 22px;
    }

    .muted { color: var(--muted); font-size: 13px; }

    /* Trips */
    .trip{
      border: 1px solid var(--border);
      padding: 12px 14px;
      margin-bottom: 10px;
      cursor: pointer;
      border-radius: 10px;
      background: #fff;
      box-shadow: 0 2px 10px rgba(0,0,0,0.03);
      transition: transform .05s ease-in-out;
    }
    .trip:hover{ transform: translateY(-1px); }
    .trip.active{
      border-color: #c7d2fe;
      background: #f5f7ff;
    }

    /* Day header */
    .day-row{
      margin-top: 18px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .day{
      padding: 6px 10px;
      background: #f1f5f9;
      border: 1px solid var(--border);
      border-radius: 999px;
      font-weight: 700;
      display: inline-block;
      font-size: 13px;
    }
    .day-line{ height: 1px; flex:1; background: var(--border); }

    /* Events */
    .event{
      display:flex;
      gap: 12px;
      align-items:flex-start;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--card);
      padding: 12px 12px;
      margin: 10px 0;
      box-shadow: var(--shadow);
    }

    .icon{
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 18px;
      flex: 0 0 auto;
      margin-top: 2px;
    }

    .event-body{ flex:1; min-width: 0; }

    .event-top{
      display:flex;
      justify-content: space-between;
      align-items:baseline;
      gap: 12px;
    }

    .event-title{
      font-weight: 800;
      font-size: 16px;
      margin: 0;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .event-time{
      font-weight: 800;
      font-size: 13px;
      color: var(--muted);
      white-space: nowrap;
    }

    .event-desc{
      margin-top: 6px;
      font-size: 13px;
      color:#333;
      line-height: 1.35;
      white-space: pre-wrap;
    }

    .event-meta{
      margin-top: 8px;
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--muted);
    }

    .badge{
      border: 1px solid var(--border);
      background: #f8fafc;
      padding: 4px 8px;
      border-radius: 999px;
    }

    .empty{
      padding: 12px;
      border: 1px dashed var(--border);
      border-radius: 12px;
      background: #fff;
      margin-top: 10px;
      color: var(--muted);
    }

    /* ‚úÖ NUEVO: badges "PRO" desde metadata */
    .pro-row{
      margin-top: 8px;
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--muted);
    }
    .pro-badge{
      border: 1px solid var(--border);
      background: #ffffff;
      padding: 4px 8px;
      border-radius: 999px;
    }
    .pro-badge strong{ color:#111; font-weight: 700; }
    .pro-badge a{ color: inherit; text-decoration: underline; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div style="font-size:28px;">‚úàÔ∏è</div>
      <h1>MyTrips</h1>
    </div>

    <h2>Mis viajes</h2>
    <div id="trips" class="muted">Cargando viajes...</div>

    <h2>Timeline</h2>
    <div id="events" class="muted">Selecciona un viaje para ver su timeline.</div>
  </div>

  <script>
    const SUPABASE_URL = 'https://lxjaudzhsshyupcgzwla.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_gg_YSsCPShq3Hwr2VtCaYg_6I_p43TT';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let activeTripId = null;

    const TYPE_UI = {
      flight:   { icon:'‚úàÔ∏è', color:'var(--flight)',   bg:'var(--flightBg)',   label:'Vuelo' },
      hotel:    { icon:'üè®', color:'var(--hotel)',    bg:'var(--hotelBg)',    label:'Hotel' },
      activity: { icon:'üéüÔ∏è', color:'var(--activity)', bg:'var(--activityBg)', label:'Actividad' },
      transfer: { icon:'üöó', color:'var(--transfer)', bg:'var(--transferBg)', label:'Traslado' },
      other:    { icon:'üìå', color:'var(--other)',    bg:'var(--otherBg)',    label:'Otro' }
    };

    function toDate(value) {
      if (!value) return null;
      const clean = String(value).replace('Z','');
      const parts = clean.split(/[-T:.]/);

      const d = new Date(
        Number(parts[0]),
        Number(parts[1]) - 1,
        Number(parts[2]),
        Number(parts[3] || 0),
        Number(parts[4] || 0)
      );
      if (isNaN(d.getTime())) return null;
      return d;
    }

    function formatDay(d) {
      return d.toLocaleDateString('es-MX', { dateStyle: 'medium' });
    }

    function formatTime(d) {
      return d.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
    }

    function groupByDay(events) {
      const map = new Map();
      for (const e of events) {
        const d = toDate(e.start_time);
        const key = d
          ? `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`
          : 'sin-fecha';

        if (!map.has(key)) map.set(key, []);
        map.get(key).push(e);
      }
      return map;
    }

    // ‚úÖ helper para escapar texto (evitar HTML accidental)
    function esc(s){
      return String(s ?? '').replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
      }[m]));
    }

    // ‚úÖ NUEVO (D2): genera URL de mapa por coords (si existen) o por location
    function mapsUrlFromMetaOrLocation(meta, location){
      const coords = meta?.coords;
      if (coords?.lat && coords?.lng) {
        return `https://www.google.com/maps?q=${coords.lat},${coords.lng}`;
      }
      if (location) {
        return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(String(location))}`;
      }
      return null;
    }

    // ‚úÖ NUEVO: renderiza "datos PRO" desde metadata (seg√∫n type)
    function renderProBadges(event){
      const meta = event.metadata;
      const badges = [];

      // ‚úÖ D1/D2: location como badge + link a Google Maps (coords o search)
      if (event.location) {
        const url = mapsUrlFromMetaOrLocation(meta, event.location);
        badges.push(
          `<span class="pro-badge">
            <strong>üìç</strong> ${esc(event.location)}
            ${url ? `&nbsp;¬∑&nbsp;<a href="${url}" target="_blank" rel="noopener">Mapa</a>` : ``}
          </span>`
        );
      }

      // source como PRO extra (aunque no est√© en metadata)
      if (event.source) badges.push(`<span class="pro-badge"><strong>source:</strong> ${esc(event.source)}</span>`);

      if (!meta || typeof meta !== 'object') {
        return badges.length ? `<div class="pro-row">${badges.join('')}</div>` : '';
      }

      const type = (event.type || '').toLowerCase();

      if (type === 'flight') {
        if (meta.flight_number) badges.push(`<span class="pro-badge"><strong>Vuelo:</strong> ${esc(meta.flight_number)}</span>`);
        if (meta.airline) badges.push(`<span class="pro-badge"><strong>Aerol√≠nea:</strong> ${esc(meta.airline)}</span>`);
        if (meta.seat) badges.push(`<span class="pro-badge"><strong>Asiento:</strong> ${esc(meta.seat)}</span>`);
        if (Array.isArray(meta.documents) && meta.documents.length) {
          badges.push(`<span class="pro-badge"><strong>Docs:</strong> ${esc(meta.documents.join(', '))}</span>`);
        }
        if (meta.pnr) badges.push(`<span class="pro-badge"><strong>PNR:</strong> ${esc(meta.pnr)}</span>`);

        // ‚úÖ D3: links √∫tiles (opcional)
        if (meta.checkin_url) badges.push(`<span class="pro-badge"><strong>Check-in:</strong> <a href="${esc(meta.checkin_url)}" target="_blank" rel="noopener">abrir</a></span>`);
        if (meta.booking_url) badges.push(`<span class="pro-badge"><strong>Reserva:</strong> <a href="${esc(meta.booking_url)}" target="_blank" rel="noopener">abrir</a></span>`);
      }

      if (type === 'hotel') {
        if (meta.hotel_name) badges.push(`<span class="pro-badge"><strong>Hotel:</strong> ${esc(meta.hotel_name)}</span>`);
        if (meta.check_in) badges.push(`<span class="pro-badge"><strong>Check-in:</strong> ${esc(meta.check_in)}</span>`);
        if (meta.check_out) badges.push(`<span class="pro-badge"><strong>Check-out:</strong> ${esc(meta.check_out)}</span>`);
        if (meta.address) badges.push(`<span class="pro-badge"><strong>Direcci√≥n:</strong> ${esc(meta.address)}</span>`);
        if (meta.reservation) badges.push(`<span class="pro-badge"><strong>Reserva:</strong> ${esc(meta.reservation)}</span>`);
        if (meta.booking_url) badges.push(`<span class="pro-badge"><strong>Reserva:</strong> <a href="${esc(meta.booking_url)}" target="_blank" rel="noopener">abrir</a></span>`);
      }

      if (type === 'activity') {
        if (meta.place) badges.push(`<span class="pro-badge"><strong>Lugar:</strong> ${esc(meta.place)}</span>`);
        if (meta.operator) badges.push(`<span class="pro-badge"><strong>Operador:</strong> ${esc(meta.operator)}</span>`);
        if (meta.ticket_url) badges.push(`<span class="pro-badge"><strong>Link:</strong> <a href="${esc(meta.ticket_url)}" target="_blank" rel="noopener">abrir</a></span>`);
        if (meta.reference) badges.push(`<span class="pro-badge"><strong>Ref:</strong> ${esc(meta.reference)}</span>`);
      }

      if (type === 'transfer') {
        if (meta.pickup) badges.push(`<span class="pro-badge"><strong>Pickup:</strong> ${esc(meta.pickup)}</span>`);
        if (meta.dropoff) badges.push(`<span class="pro-badge"><strong>Dropoff:</strong> ${esc(meta.dropoff)}</span>`);
        if (meta.company) badges.push(`<span class="pro-badge"><strong>Proveedor:</strong> ${esc(meta.company)}</span>`);
        if (meta.reference) badges.push(`<span class="pro-badge"><strong>Ref:</strong> ${esc(meta.reference)}</span>`);
      }

      // Si hay metadata pero no coincide con campos esperados, muestra 1 badge debug
      if (Object.keys(meta).length && badges.length === 0) {
        badges.push(`<span class="pro-badge"><strong>meta:</strong> ${esc(Object.keys(meta).slice(0,4).join(', '))}${Object.keys(meta).length>4 ? '‚Ä¶' : ''}</span>`);
      }

      return badges.length ? `<div class="pro-row">${badges.join('')}</div>` : '';
    }

    async function loadTrips() {
      const tripsDiv = document.getElementById('trips');
      tripsDiv.classList.add('muted');
      tripsDiv.innerHTML = 'Cargando viajes...';

      const { data, error } = await sb.from('trips').select('*').order('start_date', { ascending: true });

      if (error) {
        tripsDiv.innerText = 'Error cargando viajes: ' + error.message;
        return;
      }

      if (!data || data.length === 0) {
        tripsDiv.innerHTML = `<div class="empty">No hay viajes a√∫n.</div>`;
        return;
      }

      tripsDiv.classList.remove('muted');
      tripsDiv.innerHTML = '';

      data.forEach(trip => {
        const div = document.createElement('div');
        div.className = 'trip' + (trip.id === activeTripId ? ' active' : '');
        div.innerHTML = `<strong>${esc(trip.title)}</strong>`;
        div.onclick = () => {
          activeTripId = trip.id;
          [...document.querySelectorAll('.trip')].forEach(x => x.classList.remove('active'));
          div.classList.add('active');
          loadEvents(trip.id);
        };
        tripsDiv.appendChild(div);
      });

      // Auto-cargar el primero si no hay seleccionado
      if (!activeTripId) {
        activeTripId = data[0].id;
        const first = document.querySelector('.trip');
        if (first) first.classList.add('active');
        loadEvents(activeTripId);
      }
    }

    async function loadEvents(tripId) {
      const eventsDiv = document.getElementById('events');
      eventsDiv.classList.remove('muted');
      eventsDiv.innerHTML = 'Cargando timeline...';

      const { data, error } = await sb
        .from('events')
        .select('*')
        .eq('trip_id', tripId)
        // ‚úÖ PRO: orden ‚Äúhumano‚Äù si usas order_index; si no, igual funciona con start_time
        .order('order_index', { ascending: true, nullsFirst: false })
        .order('start_time', { ascending: true });

      if (error) {
        eventsDiv.innerText = 'Error cargando eventos: ' + error.message;
        return;
      }

      if (!data || data.length === 0) {
        eventsDiv.innerHTML = `<div class="empty">Este viaje a√∫n no tiene eventos.</div>`;
        return;
      }

      const grouped = groupByDay(data);
      const dayKeys = Array.from(grouped.keys()).sort((a,b) => {
        if (a === 'sin-fecha') return 1;
        if (b === 'sin-fecha') return -1;
        return a.localeCompare(b);
      });

      eventsDiv.innerHTML = '';

      for (const dayKey of dayKeys) {
        const list = grouped.get(dayKey) || [];

        // Ordenar dentro del d√≠a: primero order_index si existe, luego por hora
        list.sort((a,b) => {
          const ai = (a.order_index ?? null);
          const bi = (b.order_index ?? null);
          if (ai !== null && bi !== null && ai !== bi) return ai - bi;
          if (ai !== null && bi === null) return -1;
          if (ai === null && bi !== null) return 1;

          const da = toDate(a.start_time);
          const db = toDate(b.start_time);
          if (!da && !db) return 0;
          if (!da) return 1;
          if (!db) return -1;
          return da - db;
        });

        // Header del d√≠a
        const dayRow = document.createElement('div');
        dayRow.className = 'day-row';

        const pill = document.createElement('div');
        pill.className = 'day';

        if (dayKey === 'sin-fecha') {
          pill.textContent = 'Sin fecha';
        } else {
          const parts = dayKey.split('-');
          const d = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
          pill.textContent = formatDay(d);
        }

        dayRow.appendChild(pill);
        const line = document.createElement('div');
        line.className = 'day-line';
        dayRow.appendChild(line);
        eventsDiv.appendChild(dayRow);

        // Eventos
        for (const event of list) {
          const type = (event.type || '').toLowerCase();
          const ui = TYPE_UI[type] || TYPE_UI.other;

          const d = toDate(event.start_time);
          const time = d ? formatTime(d) : '--:--';

          // ‚úÖ NUEVO: badges PRO (incluye Mapa + links)
          const proBadgesHtml = renderProBadges(event);

          const card = document.createElement('div');
          card.className = 'event';

          card.innerHTML = `
            <div class="icon" style="background:${ui.bg}; border:1px solid var(--border);">
              <span style="color:${ui.color}">${ui.icon}</span>
            </div>
            <div class="event-body">
              <div class="event-top">
                <p class="event-title">${esc(event.title || '(sin t√≠tulo)')}</p>
                <div class="event-time">${esc(time)}</div>
              </div>
              ${event.description ? `<div class="event-desc">${esc(event.description)}</div>` : ``}
              ${proBadgesHtml}
              <div class="event-meta">
                <span class="badge">${ui.label}</span>
                <span class="badge">tipo: ${esc(event.type || 'unknown')}</span>
              </div>
            </div>
          `;

          eventsDiv.appendChild(card);
        }
      }
    }

    loadTrips();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <!-- ============================================================
    ‚úÖ HEAD / CONFIG B√ÅSICA
    - meta charset + viewport para que se vea bien en m√≥vil
    - t√≠tulo de la pesta√±a
    - supabase-js para leer tu base de datos desde el navegador
  ============================================================ -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MyTrips</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* ============================================================
      ‚úÖ VARIABLES DE TEMA (COLORES)
      - Aqu√≠ defines colores globales y fondos por tipo de evento
      - Si quieres cambiar el look de toda la app, lo haces aqu√≠
    ============================================================ */
    :root{
      --bg:#ffffff;
      --text:#111;
      --muted:#6b7280;
      --border:#e5e7eb;
      --card:#ffffff;
      --shadow: 0 8px 24px rgba(0,0,0,0.06);

      --flight:#2563eb;
      --hotel:#7c3aed;
      --activity:#16a34a;
      --transfer:#f59e0b;
      --other:#64748b;
      --cruise:#0ea5e9;     /* cruise */
      --car:#334155;        /* car */
      --bus:#9333ea;        /* bus */
      --train:#0f766e;      /* train */

      --flightBg: rgba(37,99,235,.08);
      --hotelBg: rgba(124,58,237,.08);
      --activityBg: rgba(22,163,74,.08);
      --transferBg: rgba(245,158,11,.10);
      --otherBg: rgba(100,116,139,.08);
      --cruiseBg: rgba(14,165,233,.10);
      --carBg: rgba(51,65,85,.08);
      --busBg: rgba(147,51,234,.10);
      --trainBg: rgba(15,118,110,.10);
    }

    /* ============================================================
      ‚úÖ ESTILO GENERAL DE P√ÅGINA
    ============================================================ */
    body{
      font-family: Arial, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }

    .container{
      max-width: 980px;
      margin: 0 auto;
      padding: 26px;
    }

    .header{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom: 16px;
    }

    h1{
      margin:0;
      font-size: 34px;
      letter-spacing: -0.4px;
    }

    h2{
      margin: 18px 0 10px;
      font-size: 22px;
    }

    .muted { color: var(--muted); font-size: 13px; }

    /* ============================================================
      ‚úÖ LISTA DE VIAJES (TRIPS)
      - Cada trip se pinta como ‚Äútarjeta clickeable‚Äù
      - .active marca el viaje seleccionado
    ============================================================ */
    .trip{
      border: 1px solid var(--border);
      padding: 12px 14px;
      margin-bottom: 10px;
      cursor: pointer;
      border-radius: 10px;
      background: #fff;
      box-shadow: 0 2px 10px rgba(0,0,0,0.03);
      transition: transform .05s ease-in-out;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }
    .trip:hover{ transform: translateY(-1px); }
    .trip.active{
      border-color: #c7d2fe;
      background: #f5f7ff;
    }
    .trip-actions{
      display:flex;
      gap:8px;
      align-items:center;
      flex: 0 0 auto;
    }
    .icon-btn{
      border: 1px solid var(--border);
      background:#fff;
      border-radius: 10px;
      padding: 6px 8px;
      cursor:pointer;
      font-weight: 700;
      font-size: 12px;
    }

    /* ============================================================
      ‚úÖ ENCABEZADO DE D√çA EN TIMELINE
      - ‚ÄúP√≠ldora‚Äù con fecha y l√≠nea horizontal
      ‚úÖ NUEVO: colapsable (cursor + icono)
    ============================================================ */
    .day-row{
      margin-top: 18px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .day{
      padding: 6px 10px;
      background: #f1f5f9;
      border: 1px solid var(--border);
      border-radius: 999px;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      cursor: pointer;
      user-select: none;
    }
    .day:hover{ filter: brightness(0.98); }
    .day-caret{ font-size: 12px; opacity: .75; }
    .day-line{ height: 1px; flex:1; background: var(--border); }

    /* ‚úÖ NUEVO: wrapper para eventos por d√≠a (para colapsar) */
    .day-events{ margin-top: 6px; }

    /* ‚úÖ NUEVO: cuando est√° colapsado, ocultamos eventos */
    .day-row.is-collapsed + .day-events{ display: none; }

    /* ============================================================
      ‚úÖ TARJETA DE EVENTO
      - Card con √≠cono, t√≠tulo, hora, descripci√≥n, badges y alertas
    ============================================================ */
    .event{
      display:flex;
      gap: 12px;
      align-items:flex-start;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--card);
      padding: 12px 12px;
      margin: 10px 0;
      box-shadow: var(--shadow);
      cursor: pointer;
    }

    .icon{
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 18px;
      flex: 0 0 auto;
      margin-top: 2px;
    }

    .event-body{ flex:1; min-width: 0; }

    .event-top{
      display:flex;
      justify-content: space-between;
      align-items:baseline;
      gap: 12px;
    }

    .event-title{
      font-weight: 800;
      font-size: 16px;
      margin: 0;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .event-time{
      font-weight: 800;
      font-size: 13px;
      color: var(--muted);
      white-space: nowrap;
    }

    /* ============================================================
      ‚úÖ FASE 2.3 (NUEVO): ACCIONES R√ÅPIDAS EN TARJETA
      - botones peque√±os (no abren modal)
    ============================================================ */
    .quick-actions{
      margin-top: 8px;
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .qbtn{
      border: 1px solid var(--border);
      background: #fff;
      padding: 6px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 800;
      font-size: 12px;
      user-select: none;
    }
    .qbtn:active{ transform: translateY(1px); }
    .qbtn:disabled{
      opacity: .55;
      cursor: not-allowed;
    }

    /* ============================================================
      ‚úÖ ALERTAS (UI)
      - Chips como: ‚Äú‚úÖ Check-in disponible‚Äù, ‚Äú‚è∞ Salir al aeropuerto‚Ä¶‚Äù
      - Son solo VISUALES (no notificaci√≥n del navegador)
    ============================================================ */
    .alert-row{
      margin-top: 8px;
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 12px;
    }
    .alert-badge{
      border: 1px solid var(--border);
      background: #fff;
      padding: 4px 8px;
      border-radius: 999px;
      font-weight: 700;
    }
    .alert-badge.warn{ background: rgba(245,158,11,.12); }
    .alert-badge.ok{ background: rgba(22,163,74,.12); }
    .alert-badge.danger{ background: rgba(239,68,68,.10); }

    .event-desc{
      margin-top: 6px;
      font-size: 13px;
      color:#333;
      line-height: 1.35;
      white-space: pre-wrap;
    }

    .event-meta{
      margin-top: 8px;
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--muted);
    }

    .badge{
      border: 1px solid var(--border);
      background: #f8fafc;
      padding: 4px 8px;
      border-radius: 999px;
    }

    .empty{
      padding: 12px;
      border: 1px dashed var(--border);
      border-radius: 12px;
      background: #fff;
      margin-top: 10px;
      color: var(--muted);
    }

    /* ============================================================
      ‚úÖ BADGES "PRO" (metadata)
    ============================================================ */
    .pro-row{
      margin-top: 8px;
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--muted);
    }
    .pro-badge{
      border: 1px solid var(--border);
      background: #ffffff;
      padding: 4px 8px;
      border-radius: 999px;
    }
    .pro-badge strong{ color:#111; font-weight: 700; }
    .pro-badge a{ color: inherit; text-decoration: underline; }

    /* ============================================================
      ‚úÖ TOOLBAR NOTIFICACIONES
    ============================================================ */
    .toolbar{
      display:flex;
      align-items:center;
      gap:10px;
      margin: 6px 0 12px;
      flex-wrap: wrap;
    }
    .btn{
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      cursor: pointer;
      font-weight: 700;
    }
    .btn:disabled{
      opacity: .6;
      cursor: not-allowed;
    }
    .btn.primary{
      background: #111;
      color: #fff;
      border-color: #111;
    }
    .btn.danger{
      border-color: rgba(239,68,68,.55);
    }
    .hint{
      font-size: 12px;
      color: var(--muted);
    }

    /* ============================================================
      ‚úÖ FASE 2.2 (NUEVO): BUSCADOR + FILTROS
      - UI ligera, sin romper estilos existentes
    ============================================================ */
    .filters{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap: wrap;
      margin: 8px 0 14px;
    }
    .filters input, .filters select{
      padding: 10px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 14px;
      outline: none;
    }
    .filters input{
      flex: 1 1 320px;
      min-width: 220px;
    }
    .filters select{
      flex: 0 0 auto;
      min-width: 190px;
      background:#fff;
    }
    .chipbar{
      display:flex;
      gap:8px;
      flex-wrap: wrap;
      margin-top: 6px;
    }
    .chip{
      border: 1px solid var(--border);
      background:#fff;
      padding: 6px 10px;
      border-radius: 999px;
      cursor:pointer;
      font-weight: 800;
      font-size: 12px;
      user-select:none;
    }
    .chip.active{
      border-color:#111;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    }

    /* ============================================================
      ‚úÖ FASE 2.2 (NUEVO): CONTROLES DE VISTA (COLAPSAR/EXPANDIR/ACORDE√ìN)
      - Persistente por viaje en localStorage
    ============================================================ */
    .view-controls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap: wrap;
      margin: 10px 0 12px;
    }
    .toggle{
      display:flex;
      gap:8px;
      align-items:center;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background:#fff;
      cursor:pointer;
      user-select:none;
      font-weight: 800;
      font-size: 12px;
    }
    .toggle input{ transform: translateY(1px); }

    /* ============================================================
      ‚úÖ NUEVO (CRUD): MODAL + FORM
    ============================================================ */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 9999;
    }

    .modal{
      width: min(760px, 100%);
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: 0 20px 60px rgba(0,0,0,.18);
      overflow: hidden;
    }

    .modal-head{
      padding: 12px 14px;
      display:flex;
      justify-content: space-between;
      align-items:center;
      border-bottom: 1px solid var(--border);
    }

    .modal-body{ padding: 14px; }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 720px){
      .grid{ grid-template-columns: 1fr; }
    }

    .field label{
      font-size: 12px;
      color: var(--muted);
      display:block;
      margin-bottom: 4px;
    }
    .field input, .field select, .field textarea{
      width: 100%;
      padding: 10px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      outline: none;
      font-size: 14px;
      box-sizing: border-box;
    }
    .field textarea{
      min-height: 90px;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
    }

    .modal-actions{
      padding: 12px 14px;
      display:flex;
      gap: 10px;
      justify-content: flex-end;
      border-top: 1px solid var(--border);
      flex-wrap: wrap;
    }
    .modal-hint{
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
      line-height: 1.35;
    }
    .hidden{ display:none !important; }

    /* ============================================================
      ‚úÖ FASE 2.4 (NUEVO): TOASTS / POPUPS NO BLOQUEANTES
      - Sustituye alerts molestos y confirma guardado/borrado
    ============================================================ */
    .toast-wrap{
      position: fixed;
      right: 14px;
      bottom: 14px;
      display:flex;
      flex-direction: column;
      gap: 10px;
      z-index: 10000;
      pointer-events: none;
    }
    .toast{
      pointer-events: auto;
      max-width: min(460px, calc(100vw - 28px));
      background:#111;
      color:#fff;
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: 0 18px 50px rgba(0,0,0,.28);
      display:flex;
      gap: 10px;
      align-items:flex-start;
      line-height: 1.25;
    }
    .toast .t-ico{ font-weight: 900; }
    .toast .t-body{ flex:1; }
    .toast .t-title{ font-weight: 900; margin-bottom: 2px; }
    .toast .t-msg{ opacity: .95; font-size: 13px; }
    .toast .t-x{
      border: 1px solid rgba(255,255,255,.22);
      background: transparent;
      color:#fff;
      border-radius: 10px;
      padding: 4px 8px;
      cursor:pointer;
      font-weight: 900;
      pointer-events: auto;
    }
    .toast.info{ background:#111; }
    .toast.ok{ background: #0f172a; }
    .toast.warn{ background: #3b2f07; }
    .toast.err{ background: #3b0a0a; }
  </style>
</head>

<body>
  <!-- ============================================================
    ‚úÖ UI (HTML)
  ============================================================ -->
  <div class="container">
    <div class="header">
      <div style="font-size:28px;">‚úàÔ∏è</div>
      <h1>MyTrips</h1>
    </div>

    <h2>Mis viajes</h2>

    <div class="toolbar">
      <button id="addTripBtn" class="btn">‚ûï Agregar viaje</button>
      <span class="hint">Tip: selecciona un viaje para ver su timeline.</span>
    </div>

    <div id="trips" class="muted">Cargando viajes...</div>

    <h2>Timeline</h2>

    <div class="toolbar">
      <button id="enableNotifs" class="btn">üîî Activar notificaciones</button>
      <span id="notifStatus" class="hint"></span>
    </div>

    <div class="toolbar">
      <button id="addEventBtn" class="btn">‚ûï Agregar evento</button>
      <span class="hint">Tip: click en una tarjeta para editarla.</span>
    </div>

    <!-- ============================================================
      ‚úÖ FASE 2.2 (NUEVO): BUSCADOR + FILTROS + VISTA R√ÅPIDA
    ============================================================ -->
    <div class="filters">
      <input id="searchInput" placeholder="üîé Buscar (t√≠tulo, descripci√≥n, lugar, metadata, etc.)" />
      <select id="typeFilter">
        <option value="">Todos los tipos</option>
        <option value="flight">flight</option>
        <option value="hotel">hotel</option>
        <option value="activity">activity</option>
        <option value="transfer">transfer</option>
        <option value="cruise">cruise</option>
        <option value="car">car</option>
        <option value="bus">bus</option>
        <option value="train">train</option>
        <option value="other">other</option>
      </select>
    </div>

    <div class="chipbar" aria-label="Vista r√°pida">
      <div class="chip active" data-range="all">Todo</div>
      <div class="chip" data-range="today">Hoy</div>
      <div class="chip" data-range="tomorrow">Ma√±ana</div>
      <div class="chip" data-range="next7">Pr√≥ximos 7 d√≠as</div>
    </div>

    <!-- ============================================================
      ‚úÖ FASE 2.2 (NUEVO): CONTROLES DE VISTA
    ============================================================ -->
    <div class="view-controls">
      <button id="expandAllBtn" class="btn">‚ûï Expandir todo</button>
      <button id="collapseAllBtn" class="btn">‚ûñ Colapsar todo</button>

      <label class="toggle" title="Si est√° activo, al abrir un d√≠a se cierran los dem√°s">
        <input id="accordionToggle" type="checkbox" />
        Modo acorde√≥n
      </label>

      <span id="viewHint" class="hint"></span>
    </div>

    <div id="events" class="muted">Selecciona un viaje para ver su timeline.</div>
  </div>

  <!-- ============================================================
    ‚úÖ MODAL √öNICO (EVENTS + TRIPS)
  ============================================================ -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-head">
        <strong id="modalTitle">Agregar</strong>
        <button id="closeModalBtn" class="btn">‚úñ</button>
      </div>

      <div class="modal-body">
        <div id="tripForm" class="hidden">
          <div class="grid">
            <div class="field" style="grid-column: 1 / -1;">
              <label>Nombre del viaje (title)</label>
              <input id="t_title" placeholder="Ej. Viaje a Egipto" />
            </div>

            <div class="field">
              <label>Fecha inicio (start_date)</label>
              <input id="t_start" type="date" />
            </div>

            <div class="field">
              <label>Fecha fin (end_date)</label>
              <input id="t_end" type="date" />
            </div>
          </div>

          <div class="modal-hint">
            - Si no tienes fechas, puedes dejarlas vac√≠as. <br/>
            - Para ordenar tus viajes, se usa start_date (si existe).
          </div>
        </div>

        <div id="eventForm">
          <div class="grid">
            <div class="field">
              <label>T√≠tulo</label>
              <input id="f_title" placeholder="Ej. Vuelo CDMX ‚Üí Par√≠s" />
            </div>

            <div class="field">
              <label>Tipo (type)</label>
              <select id="f_type">
                <option value="flight">flight</option>
                <option value="hotel">hotel</option>
                <option value="activity">activity</option>
                <option value="transfer">transfer</option>
                <option value="cruise">cruise</option>
                <option value="car">car</option>
                <option value="bus">bus</option>
                <option value="train">train</option>
                <option value="other">other</option>
              </select>
            </div>

            <div class="field">
              <label>Fecha/Hora inicio (start_time)</label>
              <input id="f_start" type="datetime-local" />
              <div class="modal-hint">
                - Si tu navegador no guarda la hora, usa ‚ÄúFecha‚Äù + ‚ÄúHora‚Äù abajo.<br/>
                - Si pones solo fecha, se asume una hora por defecto (ej. 09:00).
              </div>
            </div>

            <div class="field">
              <label>Orden (order_index)</label>
              <input id="f_order" type="number" placeholder="Ej. 10" />
            </div>

            <!-- ‚úÖ FASE 2.4 (NUEVO): fallback fecha/hora por separado (sin romper f_start) -->
            <div class="field">
              <label>Fecha (fallback)</label>
              <input id="f_date" type="date" />
            </div>

            <div class="field">
              <label>Hora (fallback)</label>
              <input id="f_time" type="time" />
            </div>

            <div class="field">
              <label>Ubicaci√≥n (location)</label>
              <input id="f_location" placeholder="Ej. Aeropuerto CDMX T1" />
            </div>

            <div class="field">
              <label>Fuente (source)</label>
              <select id="f_source">
                <option value="manual">manual</option>
                <option value="email">email</option>
                <option value="pdf">pdf</option>
                <option value="whatsapp">whatsapp</option>
                <option value="other">other</option>
              </select>
            </div>

            <div class="field" style="grid-column: 1 / -1;">
              <label>Descripci√≥n</label>
              <input id="f_desc" placeholder="Notas r√°pidas, documentos, recomendaciones, etc." />
            </div>

            <div class="field" style="grid-column: 1 / -1;">
              <label>Metadata (JSON)</label>
              <textarea id="f_meta" placeholder='Ej: {"airline":"AirFrance","flight_number":"AF0175","checkin_url":"https://..."}'></textarea>
              <div class="modal-hint">
                - Debe ser JSON v√°lido. <br/>
                - Si lo dejas vac√≠o, se guarda como {}. <br/>
                - Puedes usarlo para: airline, flight_number, seat, documents, checkin_url, booking_url, coords, etc.
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button id="deleteBtn" class="btn danger" style="display:none;">üóëÔ∏è Borrar</button>
        <button id="saveBtn" class="btn primary">üíæ Guardar</button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ FASE 2.4 (NUEVO): contenedor de toasts -->
  <div id="toastWrap" class="toast-wrap" aria-live="polite" aria-atomic="true"></div>

  <script>
    /* ============================================================
      ‚úÖ CONEXI√ìN A SUPABASE
    ============================================================ */
    const SUPABASE_URL = 'https://lxjaudzhsshyupcgzwla.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_gg_YSsCPShq3Hwr2VtCaYg_6I_p43TT';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    /* ============================================================
      ‚úÖ ESTADO DE APP
    ============================================================ */
    let activeTripId = null;

    /* ============================================================
      ‚úÖ FASE 2.4 (NUEVO): VARIABLES DE COMPORTAMIENTO (con descripci√≥n)
      - REFRESH_MS: intervalo de auto-actualizaci√≥n del timeline
      - NOTIF_LOOP_MS: intervalo del loop de reglas de notificaci√≥n (siempre con pesta√±a abierta)
      - CLOSE_ON_BACKDROP_CLICK: evita cierres accidentales del modal al tocar fuera (mobile)
      - DEFAULT_TIME_IF_ONLY_DATE: hora por defecto cuando solo hay fecha
      - CARD_TAP_MAX_MOVE_PX: umbral para diferenciar scroll vs tap en tarjetas (evita ‚Äúclick sensible‚Äù)
      - SHOW_DB_DEBUG: imprime en consola detalles de errores de Supabase (para diagnosticar RLS/policies)
      - SHOW_RLS_HINTS: muestra un toast extra si detectamos bloqueo t√≠pico de RLS/policies
    ============================================================ */
    const REFRESH_MS = 5 * 60 * 1000;          // (5 min) cada cu√°nto refrescamos timeline autom√°ticamente
    const NOTIF_LOOP_MS = 60 * 1000;           // (1 min) cada cu√°nto evaluamos reglas de notificaci√≥n
    const CLOSE_ON_BACKDROP_CLICK = false;     // false = NO cerrar al tocar fondo (evita cierres accidentales)
    const DEFAULT_TIME_IF_ONLY_DATE = "09:00"; // hora por defecto si el usuario solo captura fecha
    const CARD_TAP_MAX_MOVE_PX = 10;           // si el dedo se mueve m√°s, se asume scroll y no abre editar
    const CARD_BLOCK_EDIT_AFTER_QACTION_MS = 450; // ventana para bloquear abrir edici√≥n despu√©s de usar botones r√°pidos (evita que se abra modal al dar click en Link/Copiar/Mapa)
    const SHOW_DB_DEBUG = true;                // true = logs √∫tiles en consola (Network/403/RLS)
    const SHOW_RLS_HINTS = true;               // true = si huele a RLS, avisamos con explicaci√≥n clara

    /* ============================================================
      ‚úÖ D4.3: CACHE + LOOP DE NOTIFICACIONES (sin recargar)
    ============================================================ */
    let LAST_EVENTS = [];
    let NOTIF_TIMER = null;

    function startNotifLoop(){
      if (NOTIF_TIMER) clearInterval(NOTIF_TIMER);
      NOTIF_TIMER = setInterval(() => {
        if (LAST_EVENTS && LAST_EVENTS.length) {
          runNotificationRules(LAST_EVENTS);
        }
      }, NOTIF_LOOP_MS);
    }

    /* ============================================================
      ‚úÖ FASE 2.4 (NUEVO): TOASTS (POPUPS)
    ============================================================ */
    const toastWrap = document.getElementById('toastWrap');

    function showToast(kind, title, msg, ttlMs = 3500){
      try{
        const t = document.createElement('div');
        t.className = `toast ${kind || 'info'}`;

        const ico = document.createElement('div');
        ico.className = 't-ico';
        ico.textContent = (kind === 'ok') ? '‚úÖ' : (kind === 'warn') ? '‚ö†Ô∏è' : (kind === 'err') ? '‚õî' : '‚ÑπÔ∏è';

        const body = document.createElement('div');
        body.className = 't-body';
        body.innerHTML = `<div class="t-title">${esc(title || '')}</div><div class="t-msg">${esc(msg || '')}</div>`;

        const x = document.createElement('button');
        x.className = 't-x';
        x.type = 'button';
        x.textContent = '‚úñ';
        x.onclick = () => { if (t && t.parentNode) t.parentNode.removeChild(t); };

        t.appendChild(ico);
        t.appendChild(body);
        t.appendChild(x);

        toastWrap.appendChild(t);

        setTimeout(() => {
          if (t && t.parentNode) t.parentNode.removeChild(t);
        }, Math.max(1200, ttlMs));
      }catch(e){
        // fallback: si algo falla, usamos alert (para no ‚Äúromper‚Äù flujo)
        try{ alert((title ? title + ': ' : '') + (msg || '')); }catch(_e){}
      }
    }

    /* ============================================================
      ‚úÖ NUEVO: MEJOR DIAGN√ìSTICO DE ERRORES (RLS / policies / 403)
      - No cambia tu UX: solo te dice POR QU√â no guard√≥
    ============================================================ */
    function looksLikeRLS(error){
      const msg = String(error?.message || error || '').toLowerCase();
      return (
        msg.includes('row-level security') ||
        msg.includes('rls') ||
        msg.includes('permission') ||
        msg.includes('not allowed') ||
        msg.includes('violates') ||
        msg.includes('policy') ||
        msg.includes('403') ||
        msg.includes('401')
      );
    }

    function reportDbError(contextTitle, error){
      const msg = String(error?.message || error || 'Error desconocido');
      showToast('err', contextTitle, msg);

      if (SHOW_RLS_HINTS && looksLikeRLS(error)){
        showToast(
          'warn',
          'Posible bloqueo por RLS',
          'Supabase est√° bloqueando UPDATE/DELETE por policies. Revisa RLS en la tabla (trips/events) y agrega policy de UPDATE.'
        );
      }

      if (SHOW_DB_DEBUG){
        console.error(`[MyTrips][DB] ${contextTitle}`, error);
      }
    }

    /* ============================================================
      ‚úÖ FASE 2.1: COLAPSAR / EXPANDIR POR D√çA
    ============================================================ */
    let COLLAPSED_DAYS = new Set();

    function collapsedStorageKey(){
      return `collapsedDays:${activeTripId || 'none'}`;
    }

    function loadCollapsedDays(){
      COLLAPSED_DAYS = new Set();
      if (!activeTripId) return;
      try{
        const raw = localStorage.getItem(collapsedStorageKey());
        if (!raw) return;
        const arr = JSON.parse(raw);
        if (Array.isArray(arr)) arr.forEach(k => COLLAPSED_DAYS.add(String(k)));
      }catch(e){}
    }

    function saveCollapsedDays(){
      if (!activeTripId) return;
      try{
        localStorage.setItem(collapsedStorageKey(), JSON.stringify(Array.from(COLLAPSED_DAYS)));
      }catch(e){}
    }

    function isDayCollapsed(dayKey){
      return COLLAPSED_DAYS.has(dayKey);
    }

    function toggleDayCollapsed(dayKey){
      if (COLLAPSED_DAYS.has(dayKey)) COLLAPSED_DAYS.delete(dayKey);
      else COLLAPSED_DAYS.add(dayKey);
      saveCollapsedDays();
    }

    /* ============================================================
      ‚úÖ UI POR TIPO DE EVENTO
    ============================================================ */
    const TYPE_UI = {
      flight:   { icon:'‚úàÔ∏è', color:'var(--flight)',   bg:'var(--flightBg)',   label:'Vuelo' },
      hotel:    { icon:'üè®', color:'var(--hotel)',    bg:'var(--hotelBg)',    label:'Hotel' },
      activity: { icon:'üéüÔ∏è', color:'var(--activity)', bg:'var(--activityBg)', label:'Actividad' },
      transfer: { icon:'üöó', color:'var(--transfer)', bg:'var(--transferBg)', label:'Traslado' },
      cruise:   { icon:'üõ≥Ô∏è', color:'var(--cruise)', bg:'var(--cruiseBg)', label:'Crucero' },
      car:      { icon:'üöò', color:'var(--car)',    bg:'var(--carBg)',    label:'Auto' },
      bus:      { icon:'üöå', color:'var(--bus)',    bg:'var(--busBg)',    label:'Autob√∫s' },
      train:    { icon:'üöÜ', color:'var(--train)',  bg:'var(--trainBg)',  label:'Tren' },
      other:    { icon:'üìå', color:'var(--other)',  bg:'var(--otherBg)',  label:'Otro' }
    };

    const TYPE_ALIASES = {
      crucero: 'cruise',
      cruceros: 'cruise',
      automovil: 'car',
      auto: 'car',
      coche: 'car',
      autobus: 'bus',
      autobuses: 'bus',
      camion: 'bus',
      camiones: 'bus',
      camioneta: 'car',
      uber: 'transfer',
      taxi: 'transfer',
      traslado: 'transfer',
      transferencia: 'transfer',
      tren: 'train'
    };

    function normalizeType(raw){
      let t = (raw || '').toLowerCase().trim();
      try { t = t.normalize('NFD').replace(/[\u0300-\u036f]/g, ''); } catch(e) {}
      return TYPE_ALIASES[t] || t;
    }

    const ENABLE_DEDUP = true;

    function dedupeEvents(list){
      if (!ENABLE_DEDUP) return list;
      const seen = new Set();
      const out = [];
      for (const e of list) {
        const key = `${String(e.title || '').trim().toLowerCase()}|${String(e.start_time || '')}`;
        if (seen.has(key)) continue;
        seen.add(key);
        out.push(e);
      }
      return out;
    }

    function toDate(value) {
      if (!value) return null;
      const s = String(value).trim();
      const iso = s.replace('Z','');

      if (/^\d{4}-\d{2}-\d{2}T/.test(iso)){
        const parts = iso.split(/[-T:.]/);
        const d = new Date(
          Number(parts[0]),
          Number(parts[1]) - 1,
          Number(parts[2]),
          Number(parts[3] || 0),
          Number(parts[4] || 0)
        );
        return isNaN(d.getTime()) ? null : d;
      }

      if (/^\d{4}-\d{2}-\d{2}$/.test(iso)){
        const parts = iso.split('-');
        const d = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]), 9, 0);
        return isNaN(d.getTime()) ? null : d;
      }

      return null;
    }

    function formatDay(d) {
      return d.toLocaleDateString('es-MX', { dateStyle: 'medium' });
    }

    function formatTime(d) {
      return d.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
    }

    function fromIsoToLocalInput(iso){
      const d = toDate(iso);
      if (!d) return '';
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      return `${y}-${m}-${day}T${hh}:${mm}`;
    }

    function fromLocalInputToIso(localStr){
      if (!localStr) return null;
      const d = new Date(localStr);
      if (isNaN(d.getTime())) return null;
      return d.toISOString();
    }

    function isoFromDateOnly(dateStr, defaultHHMM = DEFAULT_TIME_IF_ONLY_DATE){
      if (!dateStr) return null;
      if (!/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return null;
      const local = `${dateStr}T${defaultHHMM}`;
      return fromLocalInputToIso(local);
    }

    /* ‚úÖ FASE 2.4 (NUEVO): combina fecha + hora (fallback) */
    function isoFromDateAndTime(dateStr, timeStr, defaultHHMM = DEFAULT_TIME_IF_ONLY_DATE){
      if (!dateStr) return null;
      const hhmm = (timeStr && /^\d{2}:\d{2}$/.test(timeStr)) ? timeStr : defaultHHMM;
      const local = `${dateStr}T${hhmm}`;
      return fromLocalInputToIso(local);
    }

    function groupByDay(events) {
      const map = new Map();
      for (const e of events) {
        const d = toDate(e.start_time);
        const key = d
          ? `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`
          : 'sin-fecha';

        if (!map.has(key)) map.set(key, []);
        map.get(key).push(e);
      }
      return map;
    }

    function esc(s){
      return String(s ?? '').replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
      }[m]));
    }

    function mapsUrlFromMetaOrLocation(meta, location){
      const coords = meta?.coords;
      if (coords?.lat && coords?.lng) {
        return `https://www.google.com/maps?q=${coords.lat},${coords.lng}`;
      }
      if (location) {
        return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(String(location))}`;
      }
      return null;
    }

    function msUntil(date){
      if (!date) return null;
      return date.getTime() - Date.now();
    }

    function humanCountdown(ms){
      if (ms === null) return null;
      const totalMin = Math.ceil(ms / (60 * 1000));
      const sign = totalMin < 0 ? -1 : 1;
      const absMin = Math.abs(totalMin);

      const h = Math.floor(absMin / 60);
      const m = absMin % 60;
      const txt = h > 0 ? `${h}h ${m}m` : `${m}m`;
      return sign < 0 ? `hace ${txt}` : `en ${txt}`;
    }

    function canNotify() {
      return ("Notification" in window);
    }

    async function ensureNotifyPermission() {
      if (!canNotify()) return false;
      if (Notification.permission === "granted") return true;
      if (Notification.permission === "denied") return false;
      const res = await Notification.requestPermission();
      return res === "granted";
    }

    function fireNotification(title, body) {
      try { new Notification(title, { body }); }
      catch (e) { console.warn("Notification error:", e); }
    }

    function notifiedKey(eventId, kind) {
      return `notified:${kind}:${eventId}`;
    }
    function hasNotified(eventId, kind) {
      return localStorage.getItem(notifiedKey(eventId, kind)) === "1";
    }
    function markNotified(eventId, kind) {
      localStorage.setItem(notifiedKey(eventId, kind), "1");
    }

    async function runNotificationRules(events){
      if (!canNotify()) return;
      if (Notification.permission !== "granted") return;

      const now = Date.now();

      for (const ev of events) {
        const start = toDate(ev.start_time);
        if (!start) continue;

        const meta = (ev.metadata && typeof ev.metadata === 'object') ? ev.metadata : {};
        const type = normalizeType(ev.type);
        const minsToStart = Math.round((start.getTime() - now) / 60000);

        if (minsToStart <= 120 && minsToStart > 110 && !hasNotified(ev.id, "reminder_2h")) {
          fireNotification("üïë Pr√≥ximo evento (2h)", `${ev.title || 'Evento'} ‚Äî en ~2 horas`);
          markNotified(ev.id, "reminder_2h");
        }

        if (minsToStart <= 30 && minsToStart > 20 && !hasNotified(ev.id, "reminder_30m")) {
          fireNotification("‚è∞ Pr√≥ximo evento (30m)", `${ev.title || 'Evento'} ‚Äî en ~30 minutos`);
          markNotified(ev.id, "reminder_30m");
        }

        if (type === "flight" && meta.checkin_url) {
          const windowHours = Number(meta.checkin_available_window_hours || 48);
          const windowMins = windowHours * 60;

          if (minsToStart <= windowMins && minsToStart > (windowMins - 20) && !hasNotified(ev.id, "checkin_open")) {
            fireNotification("‚úÖ Check-in disponible", `${ev.title || 'Vuelo'} ‚Äî ya puedes hacer check-in`);
            markNotified(ev.id, "checkin_open");
          }
        }
      }
    }

    const btnNotifs = document.getElementById("enableNotifs");
    const notifStatus = document.getElementById("notifStatus");

    function paintNotifStatus(){
      if (!canNotify()){
        notifStatus.textContent = "Tu navegador no soporta notificaciones.";
        btnNotifs.disabled = true;
        return;
      }
      const p = Notification.permission;
      if (p === "granted"){
        notifStatus.textContent = "‚úÖ Notificaciones activadas (deja la pesta√±a abierta).";
        btnNotifs.textContent = "‚úÖ Notificaciones activadas";
      } else if (p === "denied"){
        notifStatus.textContent = "‚ö†Ô∏è Bloqueadas en el navegador (act√≠valas en ajustes del sitio).";
      } else {
        notifStatus.textContent = "Act√≠valas para recibir avisos (2h, 30m, check-in 48h).";
      }
    }

    btnNotifs.onclick = async () => {
      const ok = await ensureNotifyPermission();
      if (!ok){
        notifStatus.textContent = "‚ö†Ô∏è No se pudieron activar (revisa permisos del navegador).";
        showToast('warn', 'Notificaciones', 'No se pudieron activar. Revisa permisos del sitio/navegador.');
      } else {
        showToast('ok', 'Notificaciones', 'Activadas. Deja esta pesta√±a abierta para recibir avisos.');
      }
      paintNotifStatus();
      if (Notification.permission === "granted" && LAST_EVENTS.length) {
        runNotificationRules(LAST_EVENTS);
      }
    };

    paintNotifStatus();

    function renderAlerts(event){
      const type = normalizeType(event.type);
      const meta = event.metadata && typeof event.metadata === 'object' ? event.metadata : {};
      const start = toDate(event.start_time);
      if (!start) return '';

      const alerts = [];

      if (type === 'flight' && meta.checkin_url) {
        const ms = msUntil(start);
        const hoursToStart = ms / (60 * 60 * 1000);
        const windowHours = Number(meta.checkin_available_window_hours || 48);

        if (hoursToStart <= windowHours && hoursToStart > -24) {
          alerts.push(`<span class="alert-badge ok">‚úÖ Check-in disponible</span>`);
        } else if (hoursToStart > windowHours) {
          const msToOpen = ms - (windowHours*60*60*1000);
          alerts.push(`<span class="alert-badge warn">üïí Check-in ${humanCountdown(msToOpen)}</span>`);
        }
      }

      if (type === 'flight') {
        const ms = msUntil(start);
        const hours = ms / (60 * 60 * 1000);
        if (hours <= 3 && hours > 0) {
          alerts.push(`<span class="alert-badge danger">‚è∞ Salir al aeropuerto ${humanCountdown(ms)}</span>`);
        }
      }

      return alerts.length ? `<div class="alert-row">${alerts.join('')}</div>` : '';
    }

    function renderProBadges(event){
      const meta = event.metadata;
      const badges = [];

      if (event.location) {
        const url = mapsUrlFromMetaOrLocation(meta, event.location);
        badges.push(
          `<span class="pro-badge">
            <strong>üìç</strong> ${esc(event.location)}
            ${url ? `&nbsp;¬∑&nbsp;<a href="${url}" target="_blank" rel="noopener">Mapa</a>` : ``}
          </span>`
        );
      }

      if (event.source) badges.push(`<span class="pro-badge"><strong>source:</strong> ${esc(event.source)}</span>`);

      if (!meta || typeof meta !== 'object') {
        return badges.length ? `<div class="pro-row">${badges.join('')}</div>` : '';
      }

      const type = normalizeType(event.type);

      if (type === 'activity' && meta.subtype) {
        badges.push(`<span class="pro-badge"><strong>subtype:</strong> ${esc(meta.subtype)}</span>`);
      }

      if (type === 'flight') {
        if (meta.flight_number) badges.push(`<span class="pro-badge"><strong>Vuelo:</strong> ${esc(meta.flight_number)}</span>`);
        if (meta.airline) badges.push(`<span class="pro-badge"><strong>Aerol√≠nea:</strong> ${esc(meta.airline)}</span>`);
        if (meta.seat) badges.push(`<span class="pro-badge"><strong>Asiento:</strong> ${esc(meta.seat)}</span>`);
        if (Array.isArray(meta.documents) && meta.documents.length) {
          badges.push(`<span class="pro-badge"><strong>Docs:</strong> ${esc(meta.documents.join(', '))}</span>`);
        }
        if (meta.pnr) badges.push(`<span class="pro-badge"><strong>PNR:</strong> ${esc(meta.pnr)}</span>`);

        if (meta.checkin_url) badges.push(`<span class="pro-badge"><strong>Check-in:</strong> <a href="${esc(meta.checkin_url)}" target="_blank" rel="noopener">abrir</a></span>`);
        if (meta.booking_url) badges.push(`<span class="pro-badge"><strong>Reserva:</strong> <a href="${esc(meta.booking_url)}" target="_blank" rel="noopener">abrir</a></span>`);
      }

      if (type === 'hotel') {
        if (meta.hotel_name) badges.push(`<span class="pro-badge"><strong>Hotel:</strong> ${esc(meta.hotel_name)}</span>`);
        if (meta.check_in) badges.push(`<span class="pro-badge"><strong>Check-in:</strong> ${esc(meta.check_in)}</span>`);
        if (meta.check_out) badges.push(`<span class="pro-badge"><strong>Check-out:</strong> ${esc(meta.check_out)}</span>`);
        if (meta.address) badges.push(`<span class="pro-badge"><strong>Direcci√≥n:</strong> ${esc(meta.address)}</span>`);
        if (meta.reservation) badges.push(`<span class="pro-badge"><strong>Reserva:</strong> ${esc(meta.reservation)}</span>`);
        if (meta.booking_url) badges.push(`<span class="pro-badge"><strong>Reserva:</strong> <a href="${esc(meta.booking_url)}" target="_blank" rel="noopener">abrir</a></span>`);
      }

      if (type === 'activity') {
        if (meta.place) badges.push(`<span class="pro-badge"><strong>Lugar:</strong> ${esc(meta.place)}</span>`);
        if (meta.operator) badges.push(`<span class="pro-badge"><strong>Operador:</strong> ${esc(meta.operator)}</span>`);
        if (meta.ticket_url) badges.push(`<span class="pro-badge"><strong>Link:</strong> <a href="${esc(meta.ticket_url)}" target="_blank" rel="noopener">abrir</a></span>`);
        if (meta.reference) badges.push(`<span class="pro-badge"><strong>Ref:</strong> ${esc(meta.reference)}</span>`);
      }

      if (type === 'transfer' || type === 'car' || type === 'bus') {
        if (meta.pickup) badges.push(`<span class="pro-badge"><strong>Pickup:</strong> ${esc(meta.pickup)}</span>`);
        if (meta.dropoff) badges.push(`<span class="pro-badge"><strong>Dropoff:</strong> ${esc(meta.dropoff)}</span>`);
        if (meta.company) badges.push(`<span class="pro-badge"><strong>Proveedor:</strong> ${esc(meta.company)}</span>`);
        if (meta.reference) badges.push(`<span class="pro-badge"><strong>Ref:</strong> ${esc(meta.reference)}</span>`);
      }

      if (type === 'cruise') {
        if (meta.operator) badges.push(`<span class="pro-badge"><strong>Operador:</strong> ${esc(meta.operator)}</span>`);
        if (meta.cabin) badges.push(`<span class="pro-badge"><strong>Cabina:</strong> ${esc(meta.cabin)}</span>`);
        if (meta.reference) badges.push(`<span class="pro-badge"><strong>Ref:</strong> ${esc(meta.reference)}</span>`);
      }

      if (type === 'train') {
        if (meta.company) badges.push(`<span class="pro-badge"><strong>Operador:</strong> ${esc(meta.company)}</span>`);
        if (meta.reference) badges.push(`<span class="pro-badge"><strong>Ref:</strong> ${esc(meta.reference)}</span>`);
      }

      if (Object.keys(meta).length && badges.length === 0) {
        badges.push(`<span class="pro-badge"><strong>meta:</strong> ${esc(Object.keys(meta).slice(0,4).join(', '))}${Object.keys(meta).length>4 ? '‚Ä¶' : ''}</span>`);
      }

      return badges.length ? `<div class="pro-row">${badges.join('')}</div>` : '';
    }

    /* ============================================================
      ‚úÖ FASE 2.3 (NUEVO): ACCIONES R√ÅPIDAS EN TARJETA
      - Mapa (coords/location)
      - Link principal (prioridad: checkin_url > booking_url > ticket_url)
      - Copiar resumen (t√≠tulo, fecha/hora, lugar, meta)
    ============================================================ */
    function primaryUrlFromEvent(event){
      const meta = (event.metadata && typeof event.metadata === 'object') ? event.metadata : {};
      // prioridad: checkin > booking > ticket
      if (meta.checkin_url) return String(meta.checkin_url);
      if (meta.booking_url) return String(meta.booking_url);
      if (meta.ticket_url) return String(meta.ticket_url);
      return null;
    }

    async function copyEventSummary(event){
      const meta = (event.metadata && typeof event.metadata === 'object') ? event.metadata : {};
      const d = toDate(event.start_time);
      const when = d ? `${formatDay(d)} ${formatTime(d)}` : 'Sin fecha';
      let metaTxt = '';
      try{
        const keys = Object.keys(meta || {});
        if (keys.length){
          metaTxt = `\nMeta: ${JSON.stringify(meta)}`;
        }
      }catch(e){}
      const txt =
`MyTrips ‚Äî Evento
T√≠tulo: ${event.title || ''}
Cu√°ndo: ${when}
Lugar: ${event.location || ''}
Tipo: ${event.type || ''}
${event.description ? `Descripci√≥n: ${event.description}` : ''}${metaTxt}`.trim();

      try{
        await navigator.clipboard.writeText(txt);
        showToast('ok', 'Copiar', 'Copiado al portapapeles.');
      }catch(e){
        // fallback
        const ta = document.createElement('textarea');
        ta.value = txt;
        document.body.appendChild(ta);
        ta.select();
        try{
          document.execCommand('copy');
          showToast('ok', 'Copiar', 'Copiado al portapapeles.');
        }catch(_e){
          showToast('err', 'Copiar', 'No se pudo copiar.');
        }
        document.body.removeChild(ta);
      }
    }

    function renderQuickActions(event){
      const meta = (event.metadata && typeof event.metadata === 'object') ? event.metadata : {};
      const mapUrl = mapsUrlFromMetaOrLocation(meta, event.location);
      const mainUrl = primaryUrlFromEvent(event);

      // Nota: los botones se renderizan como HTML y se cablean con delegaci√≥n por dataset-id
      const mapDisabled = mapUrl ? '' : 'disabled';
      const linkDisabled = mainUrl ? '' : 'disabled';

      return `
        <div class="quick-actions">
          <button class="qbtn" data-action="map" ${mapDisabled}>üìç Mapa</button>
          <button class="qbtn" data-action="link" ${linkDisabled}>üîó Link</button>
          <button class="qbtn" data-action="copy">üìã Copiar</button>
        </div>
      `;
    }

    /* ============================================================
      ‚úÖ FASE 2.2 (NUEVO): ESTADO FILTROS
      - No rompe loadEvents: filtramos SOBRE dataClean antes de agrupar
    ============================================================ */
    const searchInput = document.getElementById('searchInput');
    const typeFilter = document.getElementById('typeFilter');
    let RANGE_FILTER = 'all'; // all | today | tomorrow | next7

    function setActiveChip(range){
      RANGE_FILTER = range;
      document.querySelectorAll('.chip').forEach(ch => {
        ch.classList.toggle('active', ch.dataset.range === range);
      });
      if (activeTripId) loadEvents(activeTripId);
    }

    document.querySelectorAll('.chip').forEach(ch => {
      ch.onclick = () => setActiveChip(ch.dataset.range);
    });

    // debounce ligero para no recargar en cada tecla
    let SEARCH_TIMER = null;
    searchInput.addEventListener('input', () => {
      if (SEARCH_TIMER) clearTimeout(SEARCH_TIMER);
      SEARCH_TIMER = setTimeout(() => {
        if (activeTripId) loadEvents(activeTripId);
      }, 250);
    });

    typeFilter.addEventListener('change', () => {
      if (activeTripId) loadEvents(activeTripId);
    });

    function dayKeyFromDate(d){
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }

    function buildSearchText(ev){
      const parts = [];
      parts.push(ev.title || '');
      parts.push(ev.description || '');
      parts.push(ev.location || '');
      parts.push(ev.type || '');
      try{
        const meta = (ev.metadata && typeof ev.metadata === 'object') ? ev.metadata : {};
        parts.push(JSON.stringify(meta));
      }catch(e){}
      return parts.join(' ').toLowerCase();
    }

    function eventMatchesFilters(ev){
      // type filter
      const tf = (typeFilter.value || '').trim();
      if (tf){
        const t = normalizeType(ev.type);
        if (t !== tf) return false;
      }

      // search
      const q = (searchInput.value || '').trim().toLowerCase();
      if (q){
        const hay = buildSearchText(ev);
        if (!hay.includes(q)) return false;
      }

      // range filter
      if (RANGE_FILTER !== 'all'){
        const d = toDate(ev.start_time);
        if (!d) return false; // "sin fecha" no entra en rangos
        const now = new Date();
        const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const startKey = dayKeyFromDate(startOfToday);

        const evKey = dayKeyFromDate(new Date(d.getFullYear(), d.getMonth(), d.getDate()));

        if (RANGE_FILTER === 'today'){
          return evKey === startKey;
        }

        if (RANGE_FILTER === 'tomorrow'){
          const tmr = new Date(startOfToday.getTime() + 24*60*60*1000);
          return evKey === dayKeyFromDate(tmr);
        }

        if (RANGE_FILTER === 'next7'){
          const ms = d.getTime() - startOfToday.getTime();
          const days = Math.floor(ms / (24*60*60*1000));
          return days >= 0 && days <= 6;
        }
      }

      return true;
    }

    /* ============================================================
      ‚úÖ FASE 2.2 (NUEVO): CONTROLES DE VISTA (ACORDE√ìN / EXPAND-COLLAPSE)
      - Persistente por viaje
    ============================================================ */
    const expandAllBtn = document.getElementById('expandAllBtn');
    const collapseAllBtn = document.getElementById('collapseAllBtn');
    const accordionToggle = document.getElementById('accordionToggle');
    const viewHint = document.getElementById('viewHint');

    let DAY_KEYS_CURRENT = [];

    function viewStorageKey(){
      return `viewPrefs:${activeTripId || 'none'}`;
    }

    function loadViewPrefs(){
      if (!activeTripId) return;
      try{
        const raw = localStorage.getItem(viewStorageKey());
        if (!raw) { accordionToggle.checked = false; return; }
        const obj = JSON.parse(raw);
        accordionToggle.checked = !!obj.accordion;
      }catch(e){
        accordionToggle.checked = false;
      }
    }

    function saveViewPrefs(){
      if (!activeTripId) return;
      try{
        localStorage.setItem(viewStorageKey(), JSON.stringify({
          accordion: !!accordionToggle.checked
        }));
      }catch(e){}
    }

    accordionToggle.addEventListener('change', () => {
      saveViewPrefs();
      paintViewHint();
      if (activeTripId) loadEvents(activeTripId);
    });

    function paintViewHint(){
      viewHint.textContent = accordionToggle.checked
        ? "Acorde√≥n activo: solo un d√≠a abierto a la vez."
        : "Acorde√≥n apagado: puedes abrir varios d√≠as.";
    }
    paintViewHint();

    function collapseAllDays(){
      // no colapsamos sin-fecha por default si es el √∫nico grupo
      COLLAPSED_DAYS = new Set(DAY_KEYS_CURRENT.filter(k => k !== 'sin-fecha'));
      saveCollapsedDays();
      if (activeTripId) loadEvents(activeTripId);
    }

    function expandAllDays(){
      COLLAPSED_DAYS = new Set();
      saveCollapsedDays();
      if (activeTripId) loadEvents(activeTripId);
    }

    expandAllBtn.onclick = () => {
      if (!activeTripId) return;
      expandAllDays();
    };

    collapseAllBtn.onclick = () => {
      if (!activeTripId) return;
      collapseAllDays();
    };

    /* ============================================================
      ‚úÖ MODAL / CRUD (TU MISMA ESTRUCTURA)
    ============================================================ */
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalTitle = document.getElementById('modalTitle');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const saveBtn = document.getElementById('saveBtn');
    const deleteBtn = document.getElementById('deleteBtn');

    const tripForm = document.getElementById('tripForm');
    const eventForm = document.getElementById('eventForm');

    const t_title = document.getElementById('t_title');
    const t_start = document.getElementById('t_start');
    const t_end = document.getElementById('t_end');

    const f_title = document.getElementById('f_title');
    const f_type = document.getElementById('f_type');
    const f_start = document.getElementById('f_start');
    const f_order = document.getElementById('f_order');
    const f_location = document.getElementById('f_location');
    const f_source = document.getElementById('f_source');
    const f_desc = document.getElementById('f_desc');
    const f_meta = document.getElementById('f_meta');

    /* ‚úÖ FASE 2.4 (NUEVO): inputs fallback */
    const f_date = document.getElementById('f_date');
    const f_time = document.getElementById('f_time');

    const addEventBtn = document.getElementById('addEventBtn');
    const addTripBtn = document.getElementById('addTripBtn');

    let mode = "event";
    let editingEventId = null;
    let editingTripId = null;

    function openModal(){
      modalBackdrop.style.display = 'flex';
    }
    function closeModal(){
      modalBackdrop.style.display = 'none';
      editingEventId = null;
      editingTripId = null;
      mode = "event";
    }

    closeModalBtn.onclick = closeModal;

    /* ‚úÖ FASE 2.4: evitar cierres accidentales al tocar backdrop (mobile) */
    modalBackdrop.addEventListener('click', (e) => {
      if (e.target === modalBackdrop && CLOSE_ON_BACKDROP_CLICK) closeModal();
    });

    /* ‚úÖ FASE 2.4: permitir cerrar con ESC (m√°s controlado que tocar afuera) */
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modalBackdrop.style.display === 'flex') closeModal();
    });

    function showTripForm(){
      mode = "trip";
      tripForm.classList.remove('hidden');
      eventForm.classList.add('hidden');
    }
    function showEventForm(){
      mode = "event";
      eventForm.classList.remove('hidden');
      tripForm.classList.add('hidden');
    }

    function resetEventForm(){
      f_title.value = '';
      f_type.value = 'activity';
      f_start.value = '';
      f_order.value = '';
      f_location.value = '';
      f_source.value = 'manual';
      f_desc.value = '';
      f_meta.value = '';

      /* ‚úÖ FASE 2.4: reset fallback */
      f_date.value = '';
      f_time.value = '';
    }

    function resetTripForm(){
      t_title.value = '';
      t_start.value = '';
      t_end.value = '';
    }

    addTripBtn.onclick = () => {
      editingTripId = null;
      modalTitle.textContent = 'Agregar viaje';
      deleteBtn.style.display = 'none';
      saveBtn.textContent = 'üíæ Guardar';
      resetTripForm();
      showTripForm();
      openModal();
    };

    addEventBtn.onclick = () => {
      if (!activeTripId) {
        showToast('warn', 'Evento', 'Primero selecciona un viaje.');
        return;
      }
      editingEventId = null;
      modalTitle.textContent = 'Agregar evento';
      deleteBtn.style.display = 'none';
      saveBtn.textContent = 'üíæ Guardar';

      resetEventForm();
      showEventForm();
      openModal();
    };

    function openModalEditEvent(event){
      editingEventId = event.id;

      modalTitle.textContent = 'Editar evento';
      deleteBtn.style.display = 'inline-block';
      saveBtn.textContent = 'üíæ Guardar cambios';

      f_title.value = event.title || '';
      f_type.value = normalizeType(event.type || 'other');
      f_start.value = fromIsoToLocalInput(event.start_time);
      f_order.value = (event.order_index ?? '') === null ? '' : String(event.order_index ?? '');
      f_location.value = event.location || '';
      f_source.value = event.source || 'manual';
      f_desc.value = event.description || '';

      /* ‚úÖ FASE 2.4: poblar fallback date/time desde start_time */
      const d = toDate(event.start_time);
      if (d){
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        const hh = String(d.getHours()).padStart(2,'0');
        const mm = String(d.getMinutes()).padStart(2,'0');
        f_date.value = `${y}-${m}-${dd}`;
        f_time.value = `${hh}:${mm}`;
      } else {
        f_date.value = '';
        f_time.value = '';
      }

      try {
        const meta = (event.metadata && typeof event.metadata === 'object') ? event.metadata : {};
        f_meta.value = JSON.stringify(meta, null, 2);
      } catch(e) {
        f_meta.value = '';
      }

      showEventForm();
      openModal();
    }

    function openModalEditTrip(trip){
      editingTripId = trip.id;

      modalTitle.textContent = 'Editar viaje';
      deleteBtn.style.display = 'inline-block';
      saveBtn.textContent = 'üíæ Guardar cambios';

      t_title.value = trip.title || '';
      t_start.value = trip.start_date ? String(trip.start_date).slice(0,10) : '';
      t_end.value = trip.end_date ? String(trip.end_date).slice(0,10) : '';

      showTripForm();
      openModal();
    }

    saveBtn.onclick = async () => {
      if (mode === "trip") {
        const title = t_title.value.trim();
        if (!title) {
          showToast('warn', 'Viaje', 'El nombre del viaje es obligatorio.');
          return;
        }

        const payload = {
          title,
          start_date: t_start.value || null,
          end_date: t_end.value || null
        };

        if (!editingTripId) {
          const { data, error } = await sb.from('trips').insert(payload).select('*').single();
          if (error) {
            reportDbError('Crear viaje', error);
            return;
          }
          showToast('ok', 'Viaje creado', 'Listo. Ya puedes agregar eventos.');
          closeModal();
          await loadTrips();
          if (data?.id) {
            activeTripId = data.id;
            await loadEvents(activeTripId);
          }
          return;
        }

        /* ============================================================
          ‚úÖ NUEVO: UPDATE con select().single()
          - Evita ‚Äúfallos silenciosos‚Äù
          - Si RLS/policy bloquea, aqu√≠ se ve el error real
        ============================================================ */
        const { data, error } = await sb
          .from('trips')
          .update(payload)
          .eq('id', editingTripId)
          .select('*')
          .single();

        if (error) {
          reportDbError('Guardar viaje', error);
          return;
        }

        // ‚úÖ Si por alg√∫n motivo no regres√≥ data, lo reportamos como aviso
        if (!data) {
          showToast('warn', 'Guardar viaje', 'No se devolvi√≥ el registro actualizado. Revisa RLS/policies.');
        } else {
          showToast('ok', 'Viaje actualizado', 'Cambios guardados.');
        }

        closeModal();
        await loadTrips();
        if (activeTripId) await loadEvents(activeTripId);
        return;
      }

      if (!activeTripId) {
        showToast('warn', 'Evento', 'Primero selecciona un viaje.');
        return;
      }

      const title = f_title.value.trim();
      if (!title) {
        showToast('warn', 'Evento', 'El t√≠tulo es obligatorio.');
        return;
      }

      /* ============================================================
        ‚úÖ FASE 2.4: FIX FECHA SIN HORA
        - Prioridad:
          1) f_start (datetime-local)
          2) f_date + f_time (fallback)
          3) si hay fecha sin hora, usa DEFAULT_TIME_IF_ONLY_DATE
      ============================================================ */
      const rawStart = (f_start.value || '').trim();
      let startIso = null;

      if (rawStart) {
        // datetime-local debe venir como YYYY-MM-DDTHH:MM
        startIso = fromLocalInputToIso(rawStart);
        if (!startIso) startIso = null;
      } else {
        // fallback: si el usuario eligi√≥ fecha (aunque no haya hora)
        const ds = (f_date.value || '').trim();
        const ts = (f_time.value || '').trim();
        if (ds){
          startIso = isoFromDateAndTime(ds, ts, DEFAULT_TIME_IF_ONLY_DATE);
          if (!startIso) startIso = null;
        } else {
          startIso = null;
        }
      }

      const orderIndex = f_order.value === '' ? null : Number(f_order.value);

      let metaObj = {};
      const metaRaw = f_meta.value.trim();
      if (metaRaw) {
        try {
          metaObj = JSON.parse(metaRaw);
        } catch (e) {
          showToast('warn', 'Metadata', 'No es JSON v√°lido. Corr√≠gelo o d√©jalo vac√≠o.');
          return;
        }
      }

      const payload = {
        trip_id: activeTripId,
        title,
        type: f_type.value,
        start_time: startIso,
        order_index: (Number.isFinite(orderIndex) ? orderIndex : null),
        location: f_location.value.trim() || null,
        source: f_source.value || 'manual',
        description: f_desc.value.trim() || null,
        metadata: metaObj
      };

      if (!editingEventId) {
        const { error } = await sb.from('events').insert(payload);
        if (error) {
          reportDbError('Crear evento', error);
          return;
        }
        showToast('ok', 'Evento creado', 'Guardado correctamente.');
        closeModal();
        loadEvents(activeTripId);
        return;
      }

      /* ============================================================
        ‚úÖ NUEVO: UPDATE con select().single()
        - Evita ‚Äúfallos silenciosos‚Äù
        - Si RLS/policy bloquea, aqu√≠ se ve el error real
      ============================================================ */
      const { data, error } = await sb
        .from('events')
        .update(payload)
        .eq('id', editingEventId)
        .select('*')
        .single();

      if (error) {
        reportDbError('Guardar evento', error);
        return;
      }

      if (!data) {
        showToast('warn', 'Guardar evento', 'No se devolvi√≥ el registro actualizado. Revisa RLS/policies.');
      } else {
        showToast('ok', 'Evento actualizado', 'Cambios guardados.');
      }

      closeModal();
      loadEvents(activeTripId);
    };

    deleteBtn.onclick = async () => {
      if (mode === "trip") {
        if (!editingTripId) return;

        const ok = confirm('¬øSeguro que quieres borrar este viaje?');
        if (!ok) return;

        const ok2 = confirm('¬øTambi√©n borrar TODOS los eventos de este viaje? (recomendado si no hay cascade)');
        if (ok2) {
          const delEvents = await sb.from('events').delete().eq('trip_id', editingTripId);
          if (delEvents.error) {
            reportDbError('Borrar eventos', delEvents.error);
            return;
          }
        }

        const { error } = await sb.from('trips').delete().eq('id', editingTripId);
        if (error) {
          reportDbError('Borrar viaje', error);
          return;
        }

        showToast('ok', 'Viaje borrado', 'Se elimin√≥ correctamente.');
        closeModal();
        activeTripId = null;
        await loadTrips();
        document.getElementById('events').innerHTML = `<div class="muted">Selecciona un viaje para ver su timeline.</div>`;
        return;
      }

      if (!editingEventId) return;

      const ok = confirm('¬øSeguro que quieres borrar este evento? Esta acci√≥n no se puede deshacer.');
      if (!ok) return;

      const { error } = await sb.from('events').delete().eq('id', editingEventId);
      if (error) {
        reportDbError('Borrar evento', error);
        return;
      }

      showToast('ok', 'Evento borrado', 'Se elimin√≥ correctamente.');
      closeModal();
      loadEvents(activeTripId);
    };

    async function loadTrips() {
      const tripsDiv = document.getElementById('trips');
      tripsDiv.classList.add('muted');
      tripsDiv.innerHTML = 'Cargando viajes...';

      const { data, error } = await sb.from('trips').select('*').order('start_date', { ascending: true });

      if (error) {
        tripsDiv.innerText = 'Error cargando viajes: ' + error.message;
        reportDbError('Viajes', error);
        return;
      }

      if (!data || data.length === 0) {
        tripsDiv.innerHTML = `<div class="empty">No hay viajes a√∫n.</div>`;
        return;
      }

      tripsDiv.classList.remove('muted');
      tripsDiv.innerHTML = '';

      data.forEach(trip => {
        const div = document.createElement('div');
        div.className = 'trip' + (trip.id === activeTripId ? ' active' : '');

        const left = document.createElement('div');
        left.innerHTML = `<strong>${esc(trip.title)}</strong>`;

        const actions = document.createElement('div');
        actions.className = 'trip-actions';

        const editBtn = document.createElement('button');
        editBtn.className = 'icon-btn';
        editBtn.textContent = '‚úèÔ∏è Editar';
        editBtn.onclick = (e) => {
          e.stopPropagation();
          openModalEditTrip(trip);
        };

        const delBtn = document.createElement('button');
        delBtn.className = 'icon-btn';
        delBtn.textContent = 'üóëÔ∏è Borrar';
        delBtn.onclick = (e) => {
          e.stopPropagation();
          openModalEditTrip(trip);
        };

        actions.appendChild(editBtn);
        actions.appendChild(delBtn);

        div.appendChild(left);
        div.appendChild(actions);

        div.onclick = () => {
          activeTripId = trip.id;
          [...document.querySelectorAll('.trip')].forEach(x => x.classList.remove('active'));
          div.classList.add('active');

          // ‚úÖ FASE 2.2: cargar preferencias por viaje
          loadViewPrefs();
          paintViewHint();

          loadEvents(trip.id);
        };

        tripsDiv.appendChild(div);
      });

      if (!activeTripId) {
        activeTripId = data[0].id;

        // ‚úÖ FASE 2.2: cargar preferencias por viaje
        loadViewPrefs();
        paintViewHint();

        const first = document.querySelector('.trip');
        if (first) first.classList.add('active');
        loadEvents(activeTripId);
      }
    }

    async function loadEvents(tripId) {
      const eventsDiv = document.getElementById('events');
      eventsDiv.classList.remove('muted');
      eventsDiv.innerHTML = 'Cargando timeline...';

      loadCollapsedDays();

      const { data, error } = await sb
        .from('events')
        .select('*')
        .eq('trip_id', tripId)
        .order('order_index', { ascending: true, nullsFirst: false })
        .order('start_time', { ascending: true });

      if (error) {
        eventsDiv.innerText = 'Error cargando eventos: ' + error.message;
        reportDbError('Eventos', error);
        return;
      }

      if (!data || data.length === 0) {
        eventsDiv.innerHTML = `<div class="empty">Este viaje a√∫n no tiene eventos.</div>`;
        return;
      }

      const dataClean = dedupeEvents(data);

      // ‚úÖ FASE 2.2: aplicar filtros sobre dataClean
      const filtered = dataClean.filter(eventMatchesFilters);

      LAST_EVENTS = filtered;
      startNotifLoop();
      await runNotificationRules(filtered);

      if (!filtered.length){
        eventsDiv.innerHTML = `<div class="empty">No hay eventos que coincidan con tus filtros/b√∫squeda.</div>`;
        return;
      }

      const grouped = groupByDay(filtered);
      const dayKeys = Array.from(grouped.keys()).sort((a,b) => {
        if (a === 'sin-fecha') return 1;
        if (b === 'sin-fecha') return -1;
        return a.localeCompare(b);
      });

      // ‚úÖ FASE 2.2: guardar day keys para expand/collapse all
      DAY_KEYS_CURRENT = dayKeys.slice();

      // ‚úÖ FASE 2.2: si NO hay estado guardado y hay acorde√≥n ON, abrimos solo el primer d√≠a
      // (sin forzar si ya existe estado colapsado guardado)
      try{
        const raw = localStorage.getItem(collapsedStorageKey());
        const hasSaved = !!raw;
        if (!hasSaved && accordionToggle.checked){
          // colapsa todo menos el primer d√≠a (si existe)
          const firstDay = dayKeys.find(k => k !== 'sin-fecha') || dayKeys[0];
          const nextSet = new Set();
          dayKeys.forEach(k => { if (k !== firstDay) nextSet.add(k); });
          COLLAPSED_DAYS = nextSet;
          saveCollapsedDays();
        }
      }catch(e){}

      eventsDiv.innerHTML = '';

      for (const dayKey of dayKeys) {
        const list = grouped.get(dayKey) || [];

        list.sort((a,b) => {
          const ai = (a.order_index ?? null);
          const bi = (b.order_index ?? null);
          if (ai !== null && bi !== null && ai !== bi) return ai - bi;
          if (ai !== null && bi === null) return -1;
          if (ai === null && bi !== null) return 1;

          const da = toDate(a.start_time);
          const db = toDate(b.start_time);
          if (!da && !db) return 0;
          if (!da) return 1;
          if (!db) return -1;
          return da - db;
        });

        const dayRow = document.createElement('div');
        dayRow.className = 'day-row';

        const pill = document.createElement('div');
        pill.className = 'day';

        const collapsed = isDayCollapsed(dayKey);
        if (collapsed) dayRow.classList.add('is-collapsed');

        const caret = document.createElement('span');
        caret.className = 'day-caret';
        caret.textContent = collapsed ? '‚ñ∏' : '‚ñæ';

        const label = document.createElement('span');
        if (dayKey === 'sin-fecha') {
          label.textContent = 'Sin fecha';
        } else {
          const parts = dayKey.split('-');
          const d = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
          label.textContent = formatDay(d);
        }

        pill.appendChild(caret);
        pill.appendChild(label);

        pill.onclick = () => {
          // ‚úÖ FASE 2.2: modo acorde√≥n
          if (accordionToggle.checked){
            // si estamos abriendo este d√≠a, colapsa los dem√°s
            const willCollapse = !isDayCollapsed(dayKey) ? true : false; // si est√° abierto -> lo colapsar√°; si est√° colapsado -> lo abrir√°
            if (willCollapse){
              // colapsar este d√≠a (normal)
              toggleDayCollapsed(dayKey);
            } else {
              // abrir este d√≠a y cerrar los dem√°s
              const nextSet = new Set();
              DAY_KEYS_CURRENT.forEach(k => { if (k !== dayKey) nextSet.add(k); });
              COLLAPSED_DAYS = nextSet;
              saveCollapsedDays();
            }
            loadEvents(activeTripId);
            return;
          }

          // modo normal multi-d√≠a
          toggleDayCollapsed(dayKey);
          const nowCollapsed = isDayCollapsed(dayKey);
          caret.textContent = nowCollapsed ? '‚ñ∏' : '‚ñæ';
          dayRow.classList.toggle('is-collapsed', nowCollapsed);
        };

        dayRow.appendChild(pill);
        const line = document.createElement('div');
        line.className = 'day-line';
        dayRow.appendChild(line);

        const dayEventsWrap = document.createElement('div');
        dayEventsWrap.className = 'day-events';

        eventsDiv.appendChild(dayRow);
        eventsDiv.appendChild(dayEventsWrap);

        for (const event of list) {
          const type = normalizeType(event.type);

          const meta = (event.metadata && typeof event.metadata === 'object') ? event.metadata : {};
          const subtype = normalizeType(meta.subtype);

          const ui =
            (type === 'activity' && subtype && TYPE_UI[subtype])
              ? TYPE_UI[subtype]
              : (TYPE_UI[type] || TYPE_UI.other);

          const d = toDate(event.start_time);
          const time = d ? formatTime(d) : '--:--';

          const alertsHtml = renderAlerts(event);
          const proBadgesHtml = renderProBadges(event);
          const quickActionsHtml = renderQuickActions(event);

          const card = document.createElement('div');
          card.className = 'event';

          card.innerHTML = `
            <div class="icon" style="background:${ui.bg}; border:1px solid var(--border);">
              <span style="color:${ui.color}">${ui.icon}</span>
            </div>
            <div class="event-body">
              <div class="event-top">
                <p class="event-title">${esc(event.title || '(sin t√≠tulo)')}</p>
                <div class="event-time">${esc(time)}</div>
              </div>
              ${event.description ? `<div class="event-desc">${esc(event.description)}</div>` : ``}
              ${alertsHtml}
              ${quickActionsHtml}
              ${proBadgesHtml}
              <div class="event-meta">
                <span class="badge">${ui.label}</span>
                <span class="badge">tipo: ${esc(event.type || 'unknown')}</span>
              </div>
            </div>
          `;

          /* ============================================================
            ‚úÖ FASE 2.4: evitar ‚Äútap sensible‚Äù al hacer scroll
            - Solo abre editar si fue un tap (movimiento m√≠nimo)
          ============================================================ */
            let downPt = null;
            let blockEditUntil = 0; // timestamp: si es futuro, NO abrir edici√≥n (se usa cuando presionan botones r√°pidos)
            
            card.addEventListener('pointerdown', (e) => {
              downPt = { x: e.clientX, y: e.clientY };
            });
            
            card.addEventListener('pointerup', (e) => {
              // ‚úÖ si un bot√≥n r√°pido se us√≥ hace poco, NO abrir modal
              if (Date.now() < blockEditUntil) {
                downPt = null;
                return;
              }
            
              if (!downPt) return;
              const dx = Math.abs(e.clientX - downPt.x);
              const dy = Math.abs(e.clientY - downPt.y);
              downPt = null;
            
              if (dx <= CARD_TAP_MAX_MOVE_PX && dy <= CARD_TAP_MAX_MOVE_PX) {
                openModalEditEvent(event);
              }
            });


          // ‚úÖ FASE 2.3: delegaci√≥n botones (no abrir modal)
          card.querySelectorAll('.qbtn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.stopPropagation();
              blockEditUntil = Date.now() + CARD_BLOCK_EDIT_AFTER_QACTION_MS; // ‚úÖ bloquea abrir edici√≥n por un instante

              const action = btn.getAttribute('data-action');
              const meta = (event.metadata && typeof event.metadata === 'object') ? event.metadata : {};
              const mapUrl = mapsUrlFromMetaOrLocation(meta, event.location);
              const mainUrl = primaryUrlFromEvent(event);

              if (action === 'map' && mapUrl){
                window.open(mapUrl, '_blank', 'noopener');
                return;
              }
              if (action === 'link' && mainUrl){
                window.open(mainUrl, '_blank', 'noopener');
                return;
              }
              if (action === 'copy'){
                await copyEventSummary(event);
                return;
              }
            });
          });

          dayEventsWrap.appendChild(card);
        }
      }
    }

    /* ============================================================
      ‚úÖ AUTO-REFRESH TIMELINE (ajustado a 5 min)
    ============================================================ */
    setInterval(() => {
      if (activeTripId) loadEvents(activeTripId);
    }, REFRESH_MS);

    loadTrips();
  </script>
</body>
</html>

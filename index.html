<!DOCTYPE html>
<html lang="es">
<head>
  <!-- ============================================================
    ‚úÖ HEAD / CONFIG B√ÅSICA
    - meta charset + viewport para que se vea bien en m√≥vil
    - t√≠tulo de la pesta√±a
    - supabase-js para leer tu base de datos desde el navegador
  ============================================================ -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MyTrips</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- ============================================================
    ‚úÖ FASE 1 (NUEVO): IMPORTACI√ìN EXCEL
    - SheetJS para leer .xlsx en el navegador
    - No rompe nada si no lo usas
  ============================================================ -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    /* ============================================================
      ‚úÖ VARIABLES DE TEMA (COLORES)
      - Aqu√≠ defines colores globales y fondos por tipo de evento
      - Si quieres cambiar el look de toda la app, lo haces aqu√≠
    ============================================================ */
    :root{
      --bg:#ffffff;
      --text:#111;
      --muted:#6b7280;
      --border:#e5e7eb;
      --card:#ffffff;
      --shadow: 0 8px 24px rgba(0,0,0,0.06);

      --flight:#2563eb;
      --hotel:#7c3aed;
      --activity:#16a34a;
      --transfer:#f59e0b;
      --other:#64748b;
      --cruise:#0ea5e9;     /* cruise */
      --car:#334155;        /* car */
      --bus:#9333ea;        /* bus */
      --train:#0f766e;      /* train */

      --flightBg: rgba(37,99,235,.08);
      --hotelBg: rgba(124,58,237,.08);
      --activityBg: rgba(22,163,74,.08);
      --transferBg: rgba(245,158,11,.10);
      --otherBg: rgba(100,116,139,.08);
      --cruiseBg: rgba(14,165,233,.10);
      --carBg: rgba(51,65,85,.08);
      --busBg: rgba(147,51,234,.10);
      --trainBg: rgba(15,118,110,.10);

      --ui-click-z: 50; /* ‚úÖ NUEVO: z-index base para elementos clicables (anti-overlay) */

      --focus: rgba(37,99,235,.22); /* ‚úÖ NUEVO: color de foco accesible */
    }

    /* ============================================================
      ‚úÖ FIX DEFINITIVO DE CLICKS (NUEVO)
      - Evita overlays / capas que ‚Äúse coman‚Äù clicks
      - Mejora tap en m√≥vil
    ============================================================ */
    button, a, [role="button"], .btn, .clickable, .icon-btn, .qbtn, .chip, .toggle{
      position: relative;
      z-index: var(--ui-click-z);
      pointer-events: auto;
      touch-action: manipulation;
    }

    /* si llegas a agregar elementos decorativos encima, que no intercepten */
    .overlay, .bg, .decor { pointer-events: none; }

    /* ‚úÖ NUEVO: foco visible */
    button:focus-visible, a:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible{
      outline: 3px solid var(--focus);
      outline-offset: 2px;
    }

    /* ============================================================
      ‚úÖ ESTILO GENERAL DE P√ÅGINA
    ============================================================ */
    body{
      font-family: Arial, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }

    .container{
      max-width: 980px;
      margin: 0 auto;
      padding: 26px;
    }

    .header{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom: 16px;
    }

    h1{
      margin:0;
      font-size: 34px;
      letter-spacing: -0.4px;
    }

    h2{
      margin: 18px 0 10px;
      font-size: 22px;
    }

    .muted { color: var(--muted); font-size: 13px; }

    /* ============================================================
      ‚úÖ LISTA DE VIAJES (TRIPS)
      - Cada trip se pinta como ‚Äútarjeta clickeable‚Äù
      - .active marca el viaje seleccionado
    ============================================================ */
    .trip{
      border: 1px solid var(--border);
      padding: 12px 14px;
      margin-bottom: 10px;
      cursor: pointer;
      border-radius: 10px;
      background: #fff;
      box-shadow: 0 2px 10px rgba(0,0,0,0.03);
      transition: transform .05s ease-in-out;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }
    .trip:hover{ transform: translateY(-1px); }
    .trip.active{
      border-color: #c7d2fe;
      background: #f5f7ff;
    }
    .trip-actions{
      display:flex;
      gap:8px;
      align-items:center;
      flex: 0 0 auto;
    }
    .icon-btn{
      border: 1px solid var(--border);
      background:#fff;
      border-radius: 10px;
      padding: 6px 8px;
      cursor:pointer;
      font-weight: 700;
      font-size: 12px;
    }

    /* ============================================================
      ‚úÖ ENCABEZADO DE D√çA EN TIMELINE
      - ‚ÄúP√≠ldora‚Äù con fecha y l√≠nea horizontal
      ‚úÖ NUEVO: colapsable (cursor + icono)
    ============================================================ */
    .day-row{
      margin-top: 18px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .day{
      padding: 6px 10px;
      background: #f1f5f9;
      border: 1px solid var(--border);
      border-radius: 999px;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      cursor: pointer;
      user-select: none;
    }
    .day:hover{ filter: brightness(0.98); }
    .day-caret{ font-size: 12px; opacity: .75; }
    .day-line{ height: 1px; flex:1; background: var(--border); }

    /* ‚úÖ NUEVO: wrapper para eventos por d√≠a (para colapsar) */
    .day-events{ margin-top: 6px; }

    /* ‚úÖ NUEVO: cuando est√° colapsado, ocultamos eventos */
    .day-row.is-collapsed + .day-events{ display: none; }

    /* ============================================================
      ‚úÖ TARJETA DE EVENTO
      - Card con √≠cono, t√≠tulo, hora, descripci√≥n, badges y alertas
    ============================================================ */
    .event{
      display:flex;
      gap: 12px;
      align-items:flex-start;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--card);
      padding: 12px 12px;
      margin: 10px 0;
      box-shadow: var(--shadow);
      cursor: pointer;
    }

    .icon{
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 18px;
      flex: 0 0 auto;
      margin-top: 2px;
    }

    .event-body{ flex:1; min-width: 0; }

    .event-top{
      display:flex;
      justify-content: space-between;
      align-items:baseline;
      gap: 12px;
    }

    .event-title{
      font-weight: 800;
      font-size: 16px;
      margin: 0;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .event-time{
      font-weight: 800;
      font-size: 13px;
      color: var(--muted);
      white-space: nowrap;
    }

    /* ============================================================
      ‚úÖ FASE 2.3 (NUEVO): ACCIONES R√ÅPIDAS EN TARJETA
      - botones peque√±os (no abren modal)
    ============================================================ */
    .quick-actions{
      margin-top: 8px;
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .qbtn{
      border: 1px solid var(--border);
      background: #fff;
      padding: 6px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 800;
      font-size: 12px;
      user-select: none;
    }
    .qbtn:active{ transform: translateY(1px); }
    .qbtn:disabled{
      opacity: .55;
      cursor: not-allowed;
    }

    /* ============================================================
      ‚úÖ ALERTAS (UI)
    ============================================================ */
    .alert-row{
      margin-top: 8px;
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 12px;
    }
    .alert-badge{
      border: 1px solid var(--border);
      background: #fff;
      padding: 4px 8px;
      border-radius: 999px;
      font-weight: 700;
    }
    .alert-badge.warn{ background: rgba(245,158,11,.12); }
    .alert-badge.ok{ background: rgba(22,163,74,.12); }
    .alert-badge.danger{ background: rgba(239,68,68,.10); }

    .event-desc{
      margin-top: 6px;
      font-size: 13px;
      color:#333;
      line-height: 1.35;
      white-space: pre-wrap;
    }

    .event-meta{
      margin-top: 8px;
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--muted);
    }

    .badge{
      border: 1px solid var(--border);
      background: #f8fafc;
      padding: 4px 8px;
      border-radius: 999px;
    }

    .empty{
      padding: 12px;
      border: 1px dashed var(--border);
      border-radius: 12px;
      background: #fff;
      margin-top: 10px;
      color: var(--muted);
    }

    /* ============================================================
      ‚úÖ BADGES "PRO" (metadata)
    ============================================================ */
    .pro-row{
      margin-top: 8px;
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--muted);
    }
    .pro-badge{
      border: 1px solid var(--border);
      background: #ffffff;
      padding: 4px 8px;
      border-radius: 999px;
    }
    .pro-badge strong{ color:#111; font-weight: 700; }
    .pro-badge a{ color: inherit; text-decoration: underline; }

    /* ============================================================
      ‚úÖ TOOLBAR NOTIFICACIONES
    ============================================================ */
    .toolbar{
      display:flex;
      align-items:center;
      gap:10px;
      margin: 6px 0 12px;
      flex-wrap: wrap;
    }
    .btn{
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      cursor: pointer;
      font-weight: 700;
    }
    .btn:disabled{
      opacity: .6;
      cursor: not-allowed;
    }
    .btn.primary{
      background: #111;
      color: #fff;
      border-color: #111;
    }
    .btn.danger{
      border-color: rgba(239,68,68,.55);
    }
    .hint{
      font-size: 12px;
      color: var(--muted);
    }

    /* ============================================================
      ‚úÖ FASE 2.2 (NUEVO): BUSCADOR + FILTROS
    ============================================================ */
    .filters{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap: wrap;
      margin: 8px 0 14px;
    }
    .filters input, .filters select{
      padding: 10px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 14px;
      outline: none;
    }
    .filters input{
      flex: 1 1 320px;
      min-width: 220px;
    }
    .filters select{
      flex: 0 0 auto;
      min-width: 190px;
      background:#fff;
    }
    .chipbar{
      display:flex;
      gap:8px;
      flex-wrap: wrap;
      margin-top: 6px;
    }
    .chip{
      border: 1px solid var(--border);
      background:#fff;
      padding: 6px 10px;
      border-radius: 999px;
      cursor:pointer;
      font-weight: 800;
      font-size: 12px;
      user-select:none;
    }
    .chip.active{
      border-color:#111;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    }

    /* ============================================================
      ‚úÖ FASE 2.2 (NUEVO): CONTROLES DE VISTA
    ============================================================ */
    .view-controls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap: wrap;
      margin: 10px 0 12px;
    }
    .toggle{
      display:flex;
      gap:8px;
      align-items:center;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background:#fff;
      cursor:pointer;
      user-select:none;
      font-weight: 800;
      font-size: 12px;
    }
    .toggle input{ transform: translateY(1px); }

    /* ============================================================
      ‚úÖ NUEVO (CRUD): MODAL + FORM
    ============================================================ */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 9999;
    }

    .modal{
      width: min(760px, 100%);
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: 0 20px 60px rgba(0,0,0,.18);
      overflow: hidden;
    }

    .modal-head{
      padding: 12px 14px;
      display:flex;
      justify-content: space-between;
      align-items:center;
      border-bottom: 1px solid var(--border);
    }

    .modal-body{ padding: 14px; }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 720px){
      .grid{ grid-template-columns: 1fr; }
    }

    .field label{
      font-size: 12px;
      color: var(--muted);
      display:block;
      margin-bottom: 4px;
    }
    .field input, .field select, .field textarea{
      width: 100%;
      padding: 10px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      outline: none;
      font-size: 14px;
      box-sizing: border-box;
    }
    .field textarea{
      min-height: 90px;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
    }

    .modal-actions{
      padding: 12px 14px;
      display:flex;
      gap: 10px;
      justify-content: flex-end;
      border-top: 1px solid var(--border);
      flex-wrap: wrap;
    }
    .modal-hint{
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
      line-height: 1.35;
    }
    .hidden{ display:none !important; }

    /* ============================================================
      ‚úÖ FASE 2.4 (NUEVO): TOASTS / POPUPS NO BLOQUEANTES
    ============================================================ */
    .toast-wrap{
      position: fixed;
      right: 14px;
      bottom: 14px;
      display:flex;
      flex-direction: column;
      gap: 10px;
      z-index: 10000;
      pointer-events: none;
    }
    .toast{
      pointer-events: auto;
      max-width: min(460px, calc(100vw - 28px));
      background:#111;
      color:#fff;
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: 0 18px 50px rgba(0,0,0,.28);
      display:flex;
      gap: 10px;
      align-items:flex-start;
      line-height: 1.25;
    }
    .toast .t-ico{ font-weight: 900; }
    .toast .t-body{ flex:1; }
    .toast .t-title{ font-weight: 900; margin-bottom: 2px; }
    .toast .t-msg{ opacity: .95; font-size: 13px; }
    .toast .t-x{
      border: 1px solid rgba(255,255,255,.22);
      background: transparent;
      color:#fff;
      border-radius: 10px;
      padding: 4px 8px;
      cursor:pointer;
      font-weight: 900;
      pointer-events: auto;
    }
    .toast.info{ background:#111; }
    .toast.ok{ background: #0f172a; }
    .toast.warn{ background: #3b2f07; }
    .toast.err{ background: #3b0a0a; }

    /* ============================================================
      ‚úÖ NUEVO: indicador online/offline (PWA friendly)
    ============================================================ */
    .net-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background:#fff;
      font-size: 12px;
      font-weight: 800;
      user-select:none;
    }
    .dot{
      width:8px;
      height:8px;
      border-radius:999px;
      background:#16a34a;
    }
    .net-pill.offline .dot{ background:#ef4444; }
  </style>
</head>

<body>
  <!-- ============================================================
    ‚úÖ UI (HTML)
  ============================================================ -->
  <div class="container">
    <div class="header">
      <div style="font-size:28px;">‚úàÔ∏è</div>
      <h1>MyTrips</h1>
    </div>

    <h2>Mis viajes</h2>

    <div class="toolbar">
      <button id="addTripBtn" class="btn" data-action="open-add-trip">‚ûï Agregar viaje</button>
      <button id="installPwaBtn" class="btn" data-action="pwa-install" title="Instala la app en tu celular/desktop">üì≤ Instalar</button>
      <button id="clearTripBtn" class="btn" data-action="clear-trip" title="Oculta el timeline hasta seleccionar un viaje">üßπ Ocultar timeline</button>
      <span id="netPill" class="net-pill" title="Estado de conexi√≥n"><span class="dot"></span><span id="netText">Online</span></span>
      <span class="hint">Tip: selecciona un viaje para ver su timeline. (Puedes ‚Äúdeseleccionar‚Äù el viaje con el bot√≥n de Ocultar.)</span>
    </div>

    <div id="trips" class="muted">Cargando viajes...</div>

    <h2>Timeline</h2>

    <div class="toolbar">
      <button id="enableNotifs" class="btn" data-action="enable-notifs">üîî Activar notificaciones</button>
      <button id="exportIcsBtn" class="btn" data-action="export-ics">üìÖ Exportar .ics</button>
      <button id="importBtn" class="btn" data-action="open-import">üì• Importar (Excel/PDF)</button>
      <button id="shareWaBtn" class="btn" data-action="share-whatsapp">üü¢ WhatsApp</button>
      <button id="shareTgBtn" class="btn" data-action="share-telegram">üîµ Telegram</button>
      <span id="notifStatus" class="hint"></span>
    </div>

    <!-- ‚úÖ Import inputs (ocultos): no rompen UI -->
    <input id="excelInput" type="file" accept=".xlsx,.xls" class="hidden" />
    <input id="pdfInput" type="file" accept="application/pdf" multiple class="hidden" />

    <div class="toolbar">
      <button id="addEventBtn" class="btn" data-action="open-add-event">‚ûï Agregar evento</button>
      <span class="hint">Tip: click en una tarjeta para editarla.</span>
    </div>

    <!-- ============================================================
      ‚úÖ FASE 2.2 (NUEVO): BUSCADOR + FILTROS + VISTA R√ÅPIDA
    ============================================================ -->
    <div class="filters">
      <input id="searchInput" placeholder="üîé Buscar (t√≠tulo, descripci√≥n, lugar, metadata, etc.)" />
      <select id="typeFilter">
        <option value="">Todos los tipos</option>
        <option value="flight">flight</option>
        <option value="hotel">hotel</option>
        <option value="activity">activity</option>
        <option value="transfer">transfer</option>
        <option value="cruise">cruise</option>
        <option value="car">car</option>
        <option value="bus">bus</option>
        <option value="train">train</option>
        <option value="other">other</option>
      </select>
    </div>

    <div class="chipbar" aria-label="Vista r√°pida">
      <div class="chip active" data-range="all">Todo</div>
      <div class="chip" data-range="today">Hoy</div>
      <div class="chip" data-range="tomorrow">Ma√±ana</div>
      <div class="chip" data-range="next7">Pr√≥ximos 7 d√≠as</div>
    </div>

    <!-- ============================================================
      ‚úÖ FASE 2.2 (NUEVO): CONTROLES DE VISTA
    ============================================================ -->
    <div class="view-controls">
      <button id="expandAllBtn" class="btn">‚ûï Expandir todo</button>
      <button id="collapseAllBtn" class="btn">‚ûñ Colapsar todo</button>

      <label class="toggle" title="Si est√° activo, al abrir un d√≠a se cierran los dem√°s">
        <input id="accordionToggle" type="checkbox" />
        Modo acorde√≥n
      </label>

      <span id="viewHint" class="hint"></span>
    </div>

    <div id="events" class="muted">Selecciona un viaje para ver su timeline.</div>
  </div>

  <!-- ============================================================
    ‚úÖ MODAL √öNICO (EVENTS + TRIPS)
  ============================================================ -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-head">
        <strong id="modalTitle">Agregar</strong>
        <button id="closeModalBtn" class="btn" type="button">‚úñ</button>
      </div>

      <div class="modal-body">
        <div id="tripForm" class="hidden">
          <div class="grid">
            <div class="field" style="grid-column: 1 / -1;">
              <label>Nombre del viaje (title)</label>
              <input id="t_title" placeholder="Ej. Viaje a Egipto" />
            </div>

            <div class="field">
              <label>Fecha inicio (start_date)</label>
              <input id="t_start" type="date" />
            </div>

            <div class="field">
              <label>Fecha fin (end_date)</label>
              <input id="t_end" type="date" />
            </div>
          </div>

          <div class="modal-hint">
            - Si no tienes fechas, puedes dejarlas vac√≠as. <br/>
            - Para ordenar tus viajes, se usa start_date (si existe).
          </div>
        </div>

        <div id="eventForm">
          <div class="grid">
            <div class="field">
              <label>T√≠tulo</label>
              <input id="f_title" placeholder="Ej. Vuelo CDMX ‚Üí Par√≠s" />
            </div>

            <div class="field">
              <label>Tipo (type)</label>
              <select id="f_type">
                <option value="flight">flight</option>
                <option value="hotel">hotel</option>
                <option value="activity">activity</option>
                <option value="transfer">transfer</option>
                <option value="cruise">cruise</option>
                <option value="car">car</option>
                <option value="bus">bus</option>
                <option value="train">train</option>
                <option value="other">other</option>
              </select>
            </div>

            <div class="field">
              <label>Fecha/Hora inicio (start_time)</label>
              <input id="f_start" type="datetime-local" />
              <div class="modal-hint">
                - Si tu navegador no guarda la hora, usa ‚ÄúFecha‚Äù + ‚ÄúHora‚Äù abajo.<br/>
                - Si pones solo fecha, se asume una hora por defecto (ej. 09:00).
              </div>
            </div>

            <div class="field">
              <label>Orden (order_index)</label>
              <input id="f_order" type="number" placeholder="Ej. 10" />
            </div>

            <!-- ‚úÖ FASE 2.4 (NUEVO): fallback fecha/hora por separado (sin romper f_start) -->
            <div class="field">
              <label>Fecha (fallback)</label>
              <input id="f_date" type="date" />
            </div>

            <div class="field">
              <label>Hora (fallback)</label>
              <input id="f_time" type="time" />
            </div>

            <div class="field">
              <label>Ubicaci√≥n (location)</label>
              <input id="f_location" placeholder="Ej. Aeropuerto CDMX T1" />
            </div>

            <div class="field">
              <label>Fuente (source)</label>
              <select id="f_source">
                <option value="manual">manual</option>
                <option value="email">email</option>
                <option value="pdf">pdf</option>
                <option value="whatsapp">whatsapp</option>
                <option value="other">other</option>
              </select>
            </div>

            <div class="field" style="grid-column: 1 / -1;">
              <label>Descripci√≥n</label>
              <input id="f_desc" placeholder="Notas r√°pidas, documentos, recomendaciones, etc." />
            </div>

            <div class="field" style="grid-column: 1 / -1;">
              <label>Metadata (JSON)</label>
              <textarea id="f_meta" placeholder='Ej: {"airline":"AirFrance","flight_number":"AF0175","checkin_url":"https://..."}'></textarea>
              <div class="modal-hint">
                - Debe ser JSON v√°lido. <br/>
                - Si lo dejas vac√≠o, se guarda como {}. <br/>
                - Puedes usarlo para: airline, flight_number, seat, documents, checkin_url, booking_url, coords, etc.
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button id="deleteBtn" class="btn danger" style="display:none;" type="button">üóëÔ∏è Borrar</button>
        <button id="saveBtn" class="btn primary" type="button">üíæ Guardar</button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ FASE 2.4 (NUEVO): contenedor de toasts -->
  <div id="toastWrap" class="toast-wrap" aria-live="polite" aria-atomic="true"></div>

  <script>
    /* ============================================================
      ‚úÖ CONEXI√ìN A SUPABASE
      ‚ö†Ô∏è NOTA: esto es una key publishable; aun as√≠, usa RLS/policies.
    ============================================================ */
    const SUPABASE_URL = 'https://lxjaudzhsshyupcgzwla.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_gg_YSsCPShq3Hwr2VtCaYg_6I_p43TT';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    /* ============================================================
      ‚úÖ ESTADO DE APP
    ============================================================ */
    let activeTripId = null;

    /* ============================================================
      ‚úÖ FASE 2.4 (NUEVO): VARIABLES DE COMPORTAMIENTO (con descripci√≥n)
      (Regla tuya: cada variable nueva lleva comentario)
    ============================================================ */
    const REFRESH_MS = 5 * 60 * 1000;             // (5 min) cada cu√°nto refrescamos timeline autom√°ticamente
    const NOTIF_LOOP_MS = 60 * 1000;              // (1 min) cada cu√°nto evaluamos reglas de notificaci√≥n
    const CLOSE_ON_BACKDROP_CLICK = false;        // false = NO cerrar al tocar fondo (evita cierres accidentales)
    const DEFAULT_TIME_IF_ONLY_DATE = "09:00";    // hora por defecto si el usuario solo captura fecha
    const CARD_TAP_MAX_MOVE_PX = 10;              // si el dedo se mueve m√°s, se asume scroll y no abre editar
    const CARD_BLOCK_EDIT_AFTER_QACTION_MS = 700; // ventana para bloquear abrir edici√≥n despu√©s de usar botones r√°pidos
    const SHOW_DB_DEBUG = true;                   // true = logs √∫tiles en consola (Network/403/RLS)
    const SHOW_RLS_HINTS = true;                  // true = si huele a RLS, avisamos con explicaci√≥n clara
    const LAST_TRIP_STORAGE_KEY = 'mytrips:lastActiveTripId'; // recuerda selecci√≥n (o ausencia) del viaje
    const AUTO_SELECT_FIRST_TRIP = true;          // si no hay viaje guardado, selecciona el primero autom√°ticamente
    const ONLINE_PING_TOAST = false;              // muestra toast al volver a estar online (√∫til si importas offline)

    const TOGGLE_TRIP_ON_SECOND_CLICK = true;     // ‚úÖ NUEVO: si clicas el MISMO viaje seleccionado, lo contrae (deselecciona)
    const TRIP_TOGGLE_MATCH_BY = 'id';            // ‚úÖ NUEVO: criterio para comparar (id). (Se deja fijo por claridad)

    const ICS_OPEN_INSTEAD_OF_DOWNLOAD = true;    // ‚úÖ NUEVO: true = intenta ABRIR el .ics para que el sistema muestre ‚ÄúAgregar al Calendario‚Äù
    const ICS_FALLBACK_TO_DOWNLOAD = true;        // ‚úÖ NUEVO: true = si falla abrir el .ics, lo descarga como plan B

    const ICS_POPUP_BLOCK_TOAST = true;           // ‚úÖ NUEVO: si el navegador bloquea window.open(), muestra toast con instrucci√≥n
    const ICS_REVOKE_URL_MS = 8000;               // ‚úÖ NUEVO: ms para liberar el blob URL (deja tiempo a iOS/Android de leerlo)

    /* ============================================================
      ‚úÖ NUEVO: PWA INSTALL (B√ÅSICO)
      - Para push real con service worker: siguiente paso (archivo sw.js)
    ============================================================ */
    let PWA_DEFERRED_PROMPT = null; // guarda el evento beforeinstallprompt para mostrarlo cuando quieras

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      PWA_DEFERRED_PROMPT = e;
    });

    /* ============================================================
      ‚úÖ D4.3: CACHE + LOOP DE NOTIFICACIONES (sin recargar)
    ============================================================ */
    let LAST_EVENTS = [];
    let NOTIF_TIMER = null;

    function startNotifLoop(){
      if (NOTIF_TIMER) clearInterval(NOTIF_TIMER);
      NOTIF_TIMER = setInterval(() => {
        if (LAST_EVENTS && LAST_EVENTS.length) {
          runNotificationRules(LAST_EVENTS);
        }
      }, NOTIF_LOOP_MS);
    }

    function stopNotifLoop(){
      if (NOTIF_TIMER) clearInterval(NOTIF_TIMER);
      NOTIF_TIMER = null;
    }

    /* ============================================================
      ‚úÖ FASE 2.4 (NUEVO): TOASTS (POPUPS)
    ============================================================ */
    const toastWrap = document.getElementById('toastWrap');

    function esc(s){
      return String(s ?? '').replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
      }[m]));
    }

    function showToast(kind, title, msg, ttlMs = 3500){
      try{
        const t = document.createElement('div');
        t.className = `toast ${kind || 'info'}`;

        const ico = document.createElement('div');
        ico.className = 't-ico';
        ico.textContent = (kind === 'ok') ? '‚úÖ' : (kind === 'warn') ? '‚ö†Ô∏è' : (kind === 'err') ? '‚õî' : '‚ÑπÔ∏è';

        const body = document.createElement('div');
        body.className = 't-body';
        body.innerHTML = `<div class="t-title">${esc(title || '')}</div><div class="t-msg">${esc(msg || '')}</div>`;

        const x = document.createElement('button');
        x.className = 't-x';
        x.type = 'button';
        x.textContent = '‚úñ';
        x.onclick = () => { if (t && t.parentNode) t.parentNode.removeChild(t); };

        t.appendChild(ico);
        t.appendChild(body);
        t.appendChild(x);

        toastWrap.appendChild(t);

        setTimeout(() => {
          if (t && t.parentNode) t.parentNode.removeChild(t);
        }, Math.max(1200, ttlMs));
      }catch(e){
        try{ alert((title ? title + ': ' : '') + (msg || '')); }catch(_e){}
      }
    }

    /* ============================================================
      ‚úÖ NUEVO: ESTADO ONLINE/OFFLINE (sin romper estructura)
    ============================================================ */
    const netPill = document.getElementById('netPill');
    const netText = document.getElementById('netText');

    function paintNet(){
      const online = navigator.onLine;
      if (!netPill || !netText) return;
      netPill.classList.toggle('offline', !online);
      netText.textContent = online ? 'Online' : 'Offline';
    }
    window.addEventListener('online', () => { paintNet(); if (ONLINE_PING_TOAST) showToast('ok','Conexi√≥n','Volviste a estar online.'); });
    window.addEventListener('offline', () => { paintNet(); showToast('warn','Conexi√≥n','Est√°s offline. Algunas acciones pueden fallar.'); });
    paintNet();

    /* ============================================================
      ‚úÖ NUEVO: MEJOR DIAGN√ìSTICO DE ERRORES (RLS / policies / 403)
    ============================================================ */
    function looksLikeRLS(error){
      const msg = String(error?.message || error || '').toLowerCase();
      return (
        msg.includes('row-level security') ||
        msg.includes('rls') ||
        msg.includes('permission') ||
        msg.includes('not allowed') ||
        msg.includes('violates') ||
        msg.includes('policy') ||
        msg.includes('403') ||
        msg.includes('401')
      );
    }

    function reportDbError(contextTitle, error){
      const msg = String(error?.message || error || 'Error desconocido');
      showToast('err', contextTitle, msg);

      if (SHOW_RLS_HINTS && looksLikeRLS(error)){
        showToast(
          'warn',
          'Posible bloqueo por RLS',
          'Supabase podr√≠a estar bloqueando UPDATE/DELETE por policies. Revisa RLS en la tabla (trips/events) y agrega policy de UPDATE/DELETE.'
        );
      }

      if (SHOW_DB_DEBUG){
        console.error(`[MyTrips][DB] ${contextTitle}`, error);
      }
    }

    /* ============================================================
      ‚úÖ FIX CR√çTICO: CLICK ROUTER (ARREGLADO)
      - Maneja acciones de TOOLBAR/HEADER (botones .btn)
      - No interfiere con quick-actions dentro de tarjetas
    ============================================================ */
    document.addEventListener('click', async (e) => {
      const el = e.target.closest('[data-action]');
      if (!el) return;

      // ‚úÖ Evitar capturar los botones r√°pidos dentro de tarjetas
      if (el.closest('.quick-actions')) return;

      const action = String(el.getAttribute('data-action') || '').trim();
      if (!action) return;

      e.preventDefault();
      e.stopPropagation();

      switch (action) {
        case 'open-add-trip':
          handleOpenAddTrip();
          break;

        case 'open-add-event':
          handleOpenAddEvent();
          break;

        case 'enable-notifs':
          await handleEnableNotifs();
          break;

        case 'export-ics':
          exportIcsForActiveTrip();
          break;

        case 'open-import':
          openImportFlow();
          break;

        case 'pwa-install':
          await tryInstallPwa();
          break;

        case 'share-whatsapp':
          shareViaWhatsApp();
          break;

        case 'share-telegram':
          shareViaTelegram();
          break;

        case 'clear-trip':
          clearActiveTripSelection(true);
          break;

        default:
          console.warn('Acci√≥n no mapeada:', action);
      }
    }, true);

    /* ============================================================
      ‚úÖ FASE 1 (NUEVO): IMPORTACI√ìN R√ÅPIDA (Excel + PDFs)
    ============================================================ */
    const excelInput = document.getElementById('excelInput');
    const pdfInput = document.getElementById('pdfInput');

    function openImportFlow(){
      if (!activeTripId){
        showToast('warn', 'Importar', 'Primero selecciona un viaje.');
        return;
      }
      excelInput.value = '';
      pdfInput.value = '';
      excelInput.click();
    }

    function normalizeType(raw){
      let t = (raw || '').toLowerCase().trim();
      try { t = t.normalize('NFD').replace(/[\u0300-\u036f]/g, ''); } catch(e) {}
      return TYPE_ALIASES[t] || t;
    }

    function guessEventTypeFromText(s){
      const t = String(s || '').toLowerCase();
      if (t.includes('vuelo') || t.includes('flight') || t.includes('af') || t.includes('am ')) return 'flight';
      if (t.includes('hotel') || t.includes('check-in') || t.includes('check in')) return 'hotel';
      if (t.includes('traslado') || t.includes('transfer') || t.includes('uber') || t.includes('taxi')) return 'transfer';
      if (t.includes('crucero') || t.includes('cruise')) return 'cruise';
      if (t.includes('bus') || t.includes('autob')) return 'bus';
      if (t.includes('tren') || t.includes('train')) return 'train';
      return 'activity';
    }

    function parsePossibleDateTime(row){
      const get = (k) => row[k] ?? row[k?.toUpperCase?.()] ?? row[k?.toLowerCase?.()] ?? null;

      const dt = get('start_time') || get('datetime') || get('fecha_hora') || null;
      if (dt){
        const d = new Date(dt);
        if (!isNaN(d.getTime())) return d.toISOString();
      }

      const date = get('date') || get('fecha') || null;
      const time = get('time') || get('hora') || null;

      if (date){
        const ds = String(date).slice(0,10);
        const ts = time ? String(time).slice(0,5) : DEFAULT_TIME_IF_ONLY_DATE;
        const local = `${ds}T${ts}`;
        const d = new Date(local);
        if (!isNaN(d.getTime())) return d.toISOString();
      }

      return null;
    }

    async function importExcelFile(file){
      if (!file) return;
      if (typeof XLSX === 'undefined'){
        showToast('err', 'Importar Excel', 'No se carg√≥ la librer√≠a XLSX.');
        return;
      }

      showToast('info', 'Importar Excel', 'Leyendo archivo...');
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf, { type: 'array' });
      const sheetName = wb.SheetNames[0];
      const ws = wb.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });

      if (!rows.length){
        showToast('warn', 'Importar Excel', 'El Excel no tiene filas.');
        return;
      }

      const created = [];
      for (const r of rows){
        const title = (r.title || r.titulo || r.T√≠tulo || r.TITULO || r.Titulo || '').toString().trim()
          || (r.event || r.Evento || r.EVENTO || '').toString().trim();

        if (!title) continue;

        const start_time = parsePossibleDateTime(r);
        const location = (r.location || r.ubicacion || r.Ubicaci√≥n || r.Lugar || r.lugar || '').toString().trim() || null;
        const description = (r.description || r.descripcion || r.Descripci√≥n || r.Notas || r.notas || '').toString().trim() || null;

        const rawType = (r.type || r.tipo || r.Tipo || '').toString().trim();
        const type = rawType ? normalizeType(rawType) : guessEventTypeFromText(title + ' ' + (description || ''));

        const order_index_raw = r.order_index ?? r.orden ?? r.Orden ?? '';
        const order_index = (order_index_raw === '' || order_index_raw === null || order_index_raw === undefined)
          ? null : Number(order_index_raw);

        const meta = {
          imported_from: 'excel',
          original_row: r,
        };

        const payload = {
          trip_id: activeTripId,
          title,
          type,
          start_time: start_time,
          order_index: (Number.isFinite(order_index) ? order_index : null),
          location,
          source: 'other',
          description,
          metadata: meta
        };

        const { error } = await sb.from('events').insert(payload);
        if (error){
          reportDbError('Importar Excel (insert event)', error);
        } else {
          created.push(title);
        }
      }

      showToast('ok', 'Importar Excel', `Listo. Importados: ${created.length} evento(s). Ahora selecciona PDFs (si aplica).`);
      pdfInput.click();
    }

    async function importPdfFiles(files){
      const list = Array.from(files || []);
      if (!list.length){
        showToast('info', 'PDFs', 'No seleccionaste PDFs.');
        if (activeTripId) loadEvents(activeTripId);
        return;
      }

      const names = list.map(f => ({ name: f.name, size: f.size }));
      const key = `pdfStaging:${activeTripId}`;
      try{
        localStorage.setItem(key, JSON.stringify(names));
      }catch(e){}

      showToast('ok', 'PDFs', `Registrados ${names.length} PDF(s). (OCR/auto-eventos: siguiente paso)`);
      if (activeTripId) loadEvents(activeTripId);
    }

    excelInput.addEventListener('change', async () => {
      const f = excelInput.files && excelInput.files[0];
      if (!f) return;
      await importExcelFile(f);
    });

    pdfInput.addEventListener('change', async () => {
      await importPdfFiles(pdfInput.files);
    });

    /* ============================================================
      ‚úÖ FASE 1 (NUEVO): EXPORT .ICS (calendario)
    ============================================================ */
    function pad2(n){ return String(n).padStart(2,'0'); }
    function icsDateUTC(d){
      const dt = new Date(d);
      return `${dt.getUTCFullYear()}${pad2(dt.getUTCMonth()+1)}${pad2(dt.getUTCDate())}T${pad2(dt.getUTCHours())}${pad2(dt.getUTCMinutes())}${pad2(dt.getUTCSeconds())}Z`;
    }
    function icsEsc(s){
      return String(s || '')
        .replace(/\\/g,'\\\\')
        .replace(/\n/g,'\\n')
        .replace(/;/g,'\\;')
        .replace(/,/g,'\\,');
    }

    function downloadTextFile(filename, mimeType, content){
      const blob = new Blob([content], { type: `${mimeType};charset=utf-8` });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    /* ============================================================
      ‚úÖ NUEVO: ABRIR .ICS EN VEZ DE SOLO DESCARGAR (para que el SO pregunte "Agregar al Calendario")
      - Detecta popup bloqueado y muestra toast
      - Mejora iOS: usa click program√°tico en <a> (m√°s confiable que window.open en Safari)
    ============================================================ */
    function isIOS(){
      // ‚úÖ iOS real (incluye iPadOS en modo "Macintosh" con touch)
      const ua = navigator.userAgent || '';
      const isAppleTouchMac = ua.includes('Mac') && ('ontouchend' in document);
      return /iPad|iPhone|iPod/i.test(ua) || isAppleTouchMac;
    }

    function openViaAnchor(url){
      try{
        const a = document.createElement('a');
        a.href = url;
        a.target = '_blank';
        a.rel = 'noopener';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        return true;
      }catch(e){
        return false;
      }
    }

    function openIcsFile(filename, content){
      try{
        const blob = new Blob([content], { type: 'text/calendar;charset=utf-8' });
        const url = URL.createObjectURL(blob);

        let opened = false;
        let blocked = false;

        if (isIOS()){
          // iOS: anchor click suele ser m√°s confiable que window.open(blob)
          opened = openViaAnchor(url);
          blocked = !opened;
        } else {
          const w = window.open(url, '_blank', 'noopener');
          blocked = !w;
          opened = !!w;
        }

        // Limpieza (damos tiempo a que el SO lo lea)
        setTimeout(() => {
          try{ URL.revokeObjectURL(url); }catch(e){}
        }, ICS_REVOKE_URL_MS);

        return { opened, blocked };
      }catch(e){
        return { opened:false, blocked:false, error:e };
      }
    }

    function saveIcsToDevice(filename, content){
      // Decide si abrir o descargar
      if (ICS_OPEN_INSTEAD_OF_DOWNLOAD){
        const res = openIcsFile(filename, content);

        // ‚úÖ NUEVO: popup bloqueado -> toast ‚Äúpro‚Äù
        if (ICS_POPUP_BLOCK_TOAST && res?.blocked){
          showToast(
            'warn',
            'Calendario',
            'Si no se abri√≥, revisa tu bloqueador o abre el archivo desde Descargas.'
          );
        }

        if (res?.opened) return { opened:true, downloaded:false, blocked:false };
        if (!ICS_FALLBACK_TO_DOWNLOAD) return { opened:false, downloaded:false, blocked:!!res?.blocked };
      }

      // fallback
      downloadTextFile(filename, 'text/calendar', content);
      return { opened:false, downloaded:true, blocked:false };
    }

    function toDate(value) {
      if (!value) return null;
      if (value instanceof Date) return isNaN(value.getTime()) ? null : value;

      const s = String(value).trim();
      if (!s) return null;

      if (/^\d{4}-\d{2}-\d{2}T/.test(s)){
        let d = new Date(s);
        if (!isNaN(d.getTime())) return d;
        try{
          const s2 = s.replace(' ', 'T');
          d = new Date(s2);
          return isNaN(d.getTime()) ? null : d;
        }catch(e){ return null; }
      }

      if (/^\d{4}-\d{2}-\d{2}$/.test(s)){
        const [y,m,dd] = s.split('-').map(Number);
        const hhmm = DEFAULT_TIME_IF_ONLY_DATE.split(':');
        const hh = Number(hhmm[0] || 9);
        const mm = Number(hhmm[1] || 0);
        const d = new Date(y, m-1, dd, hh, mm, 0);
        return isNaN(d.getTime()) ? null : d;
      }

      const d = new Date(s);
      return isNaN(d.getTime()) ? null : d;
    }

    function icsForSingleEvent(ev){
      const start = toDate(ev.start_time);
      if (!start) return null;

      const end = new Date(start.getTime() + 60*60*1000);
      const nowStamp = icsDateUTC(new Date());
      const uid = `${ev.id || Math.random().toString(16).slice(2)}@mytrips`;

      const lines = [];
      lines.push('BEGIN:VCALENDAR');
      lines.push('VERSION:2.0');
      lines.push('PRODID:-//MyTrips//EN');
      lines.push('CALSCALE:GREGORIAN');
      lines.push('METHOD:PUBLISH');

      lines.push('BEGIN:VEVENT');
      lines.push(`UID:${uid}`);
      lines.push(`DTSTAMP:${nowStamp}`);
      lines.push(`DTSTART:${icsDateUTC(start)}`);
      lines.push(`DTEND:${icsDateUTC(end)}`);
      lines.push(`SUMMARY:${icsEsc(ev.title || 'Evento')}`);
      if (ev.description) lines.push(`DESCRIPTION:${icsEsc(ev.description)}`);
      if (ev.location) lines.push(`LOCATION:${icsEsc(ev.location)}`);
      lines.push('END:VEVENT');

      lines.push('END:VCALENDAR');
      return lines.join('\r\n');
    }

    async function exportIcsForActiveTrip(){
      if (!activeTripId){
        showToast('warn', 'Export .ics', 'Primero selecciona un viaje.');
        return;
      }

      let eventsToExport = (LAST_EVENTS && LAST_EVENTS.length) ? LAST_EVENTS : null;
      if (!eventsToExport){
        const { data, error } = await sb
          .from('events')
          .select('*')
          .eq('trip_id', activeTripId)
          .order('order_index', { ascending: true, nullsFirst: false })
          .order('start_time', { ascending: true });

        if (error){
          reportDbError('Export .ics (load)', error);
          return;
        }
        eventsToExport = (data || []).filter(Boolean);
      }

      const nowStamp = icsDateUTC(new Date());
      const lines = [];
      lines.push('BEGIN:VCALENDAR');
      lines.push('VERSION:2.0');
      lines.push('PRODID:-//MyTrips//EN');
      lines.push('CALSCALE:GREGORIAN');
      lines.push('METHOD:PUBLISH');

      for (const ev of eventsToExport){
        const start = toDate(ev.start_time);
        if (!start) continue;
        const end = new Date(start.getTime() + 60*60*1000);

        const uid = `${ev.id || Math.random().toString(16).slice(2)}@mytrips`;
        const summary = icsEsc(ev.title || 'Evento');
        const desc = icsEsc(ev.description || '');
        const loc = icsEsc(ev.location || '');

        lines.push('BEGIN:VEVENT');
        lines.push(`UID:${uid}`);
        lines.push(`DTSTAMP:${nowStamp}`);
        lines.push(`DTSTART:${icsDateUTC(start)}`);
        lines.push(`DTEND:${icsDateUTC(end)}`);
        lines.push(`SUMMARY:${summary}`);
        if (desc) lines.push(`DESCRIPTION:${desc}`);
        if (loc) lines.push(`LOCATION:${loc}`);
        lines.push('END:VEVENT');
      }

      lines.push('END:VCALENDAR');

      const result = saveIcsToDevice(`mytrips_${activeTripId}.ics`, lines.join('\r\n'));

      if (result?.opened){
        showToast('ok', 'Export .ics', 'Listo. Se abri√≥ el .ics: el sistema deber√≠a preguntarte si deseas agregarlo al Calendario.');
      } else if (result?.downloaded){
        showToast('warn', 'Export .ics', 'Se descarg√≥ el .ics. √Åbrelo desde Descargas/Archivos para agregarlo al Calendario.');
      } else {
        showToast('warn', 'Export .ics', 'No se pudo abrir/descargar el .ics. Revisa permisos/bloqueador del navegador.');
      }
    }

    /* ============================================================
      ‚úÖ SHARE WhatsApp/Telegram (B√ÅSICO)
    ============================================================ */
    function formatDay(d) {
      return d.toLocaleDateString('es-MX', { dateStyle: 'medium' });
    }

    function formatTime(d) {
      return d.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
    }

    function buildTripShareText(){
      const title = document.querySelector('.trip.active strong')?.textContent || 'Mi viaje';
      const evs = (LAST_EVENTS || []).slice(0, 12);
      const lines = [];
      lines.push(`MyTrips ‚Äî ${title}`);
      if (!activeTripId) lines.push('(Selecciona un viaje para ver eventos)');
      if (!evs.length) return lines.join('\n');

      for (const ev of evs){
        const d = toDate(ev.start_time);
        const when = d ? `${formatDay(d)} ${formatTime(d)}` : 'Sin fecha';
        lines.push(`‚Ä¢ ${when} ‚Äî ${ev.title || 'Evento'}${ev.location ? ` (${ev.location})` : ''}`);
      }
      if ((LAST_EVENTS || []).length > evs.length) lines.push('‚Ä¶ (m√°s en MyTrips)');
      return lines.join('\n');
    }

    function shareViaWhatsApp(){
      const txt = buildTripShareText();
      const url = `https://wa.me/?text=${encodeURIComponent(txt)}`;
      window.open(url, '_blank', 'noopener');
    }

    function shareViaTelegram(){
      const txt = buildTripShareText();
      const url = `https://t.me/share/url?url=&text=${encodeURIComponent(txt)}`;
      window.open(url, '_blank', 'noopener');
    }

    async function tryInstallPwa(){
      if (!PWA_DEFERRED_PROMPT){
        showToast('info', 'Instalar', 'Si est√°s en m√≥vil, usa ‚ÄúAgregar a pantalla de inicio‚Äù en el men√∫ del navegador.');
        return;
      }
      PWA_DEFERRED_PROMPT.prompt();
      const choice = await PWA_DEFERRED_PROMPT.userChoice;
      if (choice?.outcome === 'accepted'){
        showToast('ok', 'Instalar', 'Instalaci√≥n iniciada.');
      } else {
        showToast('warn', 'Instalar', 'Instalaci√≥n cancelada.');
      }
      PWA_DEFERRED_PROMPT = null;
    }

    /* ============================================================
      ‚úÖ FASE 2.1: COLAPSAR / EXPANDIR POR D√çA
    ============================================================ */
    let COLLAPSED_DAYS = new Set();

    function collapsedStorageKey(){
      return `collapsedDays:${activeTripId || 'none'}`;
    }

    function loadCollapsedDays(){
      COLLAPSED_DAYS = new Set();
      if (!activeTripId) return;
      try{
        const raw = localStorage.getItem(collapsedStorageKey());
        if (!raw) return;
        const arr = JSON.parse(raw);
        if (Array.isArray(arr)) arr.forEach(k => COLLAPSED_DAYS.add(String(k)));
      }catch(e){}
    }

    function saveCollapsedDays(){
      if (!activeTripId) return;
      try{
        localStorage.setItem(collapsedStorageKey(), JSON.stringify(Array.from(COLLAPSED_DAYS)));
      }catch(e){}
    }

    function isDayCollapsed(dayKey){
      return COLLAPSED_DAYS.has(dayKey);
    }

    function toggleDayCollapsed(dayKey){
      if (COLLAPSED_DAYS.has(dayKey)) COLLAPSED_DAYS.delete(dayKey);
      else COLLAPSED_DAYS.add(dayKey);
      saveCollapsedDays();
    }

    /* ============================================================
      ‚úÖ UI POR TIPO DE EVENTO
    ============================================================ */
    const TYPE_UI = {
      flight:   { icon:'‚úàÔ∏è', color:'var(--flight)',   bg:'var(--flightBg)',   label:'Vuelo' },
      hotel:    { icon:'üè®', color:'var(--hotel)',    bg:'var(--hotelBg)',    label:'Hotel' },
      activity: { icon:'üéüÔ∏è', color:'var(--activity)', bg:'var(--activityBg)', label:'Actividad' },
      transfer: { icon:'üöó', color:'var(--transfer)', bg:'var(--transferBg)', label:'Traslado' },
      cruise:   { icon:'üõ≥Ô∏è', color:'var(--cruise)', bg:'var(--cruiseBg)', label:'Crucero' },
      car:      { icon:'üöò', color:'var(--car)',    bg:'var(--carBg)',    label:'Auto' },
      bus:      { icon:'üöå', color:'var(--bus)',    bg:'var(--busBg)',    label:'Autob√∫s' },
      train:    { icon:'üöÜ', color:'var(--train)',  bg:'var(--trainBg)',  label:'Tren' },
      other:    { icon:'üìå', color:'var(--other)',  bg:'var(--otherBg)',  label:'Otro' }
    };

    const TYPE_ALIASES = {
      crucero: 'cruise',
      cruceros: 'cruise',
      automovil: 'car',
      auto: 'car',
      coche: 'car',
      autobus: 'bus',
      autobuses: 'bus',
      camion: 'bus',
      camiones: 'bus',
      camioneta: 'car',
      uber: 'transfer',
      taxi: 'transfer',
      traslado: 'transfer',
      transferencia: 'transfer',
      tren: 'train'
    };

    const ENABLE_DEDUP = true; // evita duplicados exactos (title + start_time)

    function dedupeEvents(list){
      if (!ENABLE_DEDUP) return list;
      const seen = new Set();
      const out = [];
      for (const e of list) {
        const key = `${String(e.title || '').trim().toLowerCase()}|${String(e.start_time || '')}`;
        if (seen.has(key)) continue;
        seen.add(key);
        out.push(e);
      }
      return out;
    }

    function fromIsoToLocalInput(iso){
      const d = toDate(iso);
      if (!d) return '';
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      return `${y}-${m}-${day}T${hh}:${mm}`;
    }

    function fromLocalInputToIso(localStr){
      if (!localStr) return null;
      const d = new Date(localStr);
      if (isNaN(d.getTime())) return null;
      return d.toISOString();
    }

    function isoFromDateAndTime(dateStr, timeStr, defaultHHMM = DEFAULT_TIME_IF_ONLY_DATE){
      if (!dateStr) return null;
      const hhmm = (timeStr && /^\d{2}:\d{2}$/.test(timeStr)) ? timeStr : defaultHHMM;
      const local = `${dateStr}T${hhmm}`;
      return fromLocalInputToIso(local);
    }

    function groupByDay(events) {
      const map = new Map();
      for (const e of events) {
        const d = toDate(e.start_time);
        const key = d
          ? `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`
          : 'sin-fecha';

        if (!map.has(key)) map.set(key, []);
        map.get(key).push(e);
      }
      return map;
    }

    function mapsUrlFromMetaOrLocation(meta, location){
      const coords = meta?.coords;
      if (coords?.lat && coords?.lng) {
        return `https://www.google.com/maps?q=${coords.lat},${coords.lng}`;
      }
      if (location) {
        return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(String(location))}`;
      }
      return null;
    }

    function msUntil(date){
      if (!date) return null;
      return date.getTime() - Date.now();
    }

    function humanCountdown(ms){
      if (ms === null) return null;
      const totalMin = Math.ceil(ms / (60 * 1000));
      const sign = totalMin < 0 ? -1 : 1;
      const absMin = Math.abs(totalMin);

      const h = Math.floor(absMin / 60);
      const m = absMin % 60;
      const txt = h > 0 ? `${h}h ${m}m` : `${m}m`;
      return sign < 0 ? `hace ${txt}` : `en ${txt}`;
    }

    /* ============================================================
      ‚úÖ NOTIFICACIONES (browser-only)
      - Requiere pesta√±a abierta
      - Push real: siguiente fase con service worker
    ============================================================ */
    function canNotify() {
      return ("Notification" in window);
    }

    async function ensureNotifyPermission() {
      if (!canNotify()) return false;
      if (Notification.permission === "granted") return true;
      if (Notification.permission === "denied") return false;
      const res = await Notification.requestPermission();
      return res === "granted";
    }

    function fireNotification(title, body) {
      try { new Notification(title, { body }); }
      catch (e) { console.warn("Notification error:", e); }
    }

    function notifiedKey(eventId, kind) {
      return `notified:${kind}:${eventId}`;
    }
    function hasNotified(eventId, kind) {
      return localStorage.getItem(notifiedKey(eventId, kind)) === "1";
    }
    function markNotified(eventId, kind) {
      localStorage.setItem(notifiedKey(eventId, kind), "1");
    }

    async function runNotificationRules(events){
      if (!canNotify()) return;
      if (Notification.permission !== "granted") return;

      const now = Date.now();

      for (const ev of events) {
        const start = toDate(ev.start_time);
        if (!start) continue;

        const meta = (ev.metadata && typeof ev.metadata === 'object') ? ev.metadata : {};
        const type = normalizeType(ev.type);
        const minsToStart = Math.round((start.getTime() - now) / 60000);

        if (minsToStart <= 120 && minsToStart > 110 && !hasNotified(ev.id, "reminder_2h")) {
          fireNotification("üïë Pr√≥ximo evento (2h)", `${ev.title || 'Evento'} ‚Äî en ~2 horas`);
          markNotified(ev.id, "reminder_2h");
        }

        if (minsToStart <= 30 && minsToStart > 20 && !hasNotified(ev.id, "reminder_30m")) {
          fireNotification("‚è∞ Pr√≥ximo evento (30m)", `${ev.title || 'Evento'} ‚Äî en ~30 minutos`);
          markNotified(ev.id, "reminder_30m");
        }

        if (type === "flight" && meta.checkin_url) {
          const windowHours = Number(meta.checkin_available_window_hours || 48);
          const windowMins = windowHours * 60;

          if (minsToStart <= windowMins && minsToStart > (windowMins - 20) && !hasNotified(ev.id, "checkin_open")) {
            fireNotification("‚úÖ Check-in disponible", `${ev.title || 'Vuelo'} ‚Äî ya puedes hacer check-in`);
            markNotified(ev.id, "checkin_open");
          }
        }
      }
    }

    const btnNotifs = document.getElementById("enableNotifs");
    const notifStatus = document.getElementById("notifStatus");

    function paintNotifStatus(){
      if (!canNotify()){
        notifStatus.textContent = "Tu navegador no soporta notificaciones.";
        btnNotifs.disabled = true;
        return;
      }
      const p = Notification.permission;
      if (p === "granted"){
        notifStatus.textContent = "‚úÖ Notificaciones activadas (deja la pesta√±a abierta).";
        btnNotifs.textContent = "‚úÖ Notificaciones activadas";
      } else if (p === "denied"){
        notifStatus.textContent = "‚ö†Ô∏è Bloqueadas en el navegador (act√≠valas en ajustes del sitio).";
      } else {
        notifStatus.textContent = "Act√≠valas para recibir avisos (2h, 30m, check-in 48h).";
      }
    }

    async function handleEnableNotifs(){
      const ok = await ensureNotifyPermission();
      if (!ok){
        notifStatus.textContent = "‚ö†Ô∏è No se pudieron activar (revisa permisos del navegador).";
        showToast('warn', 'Notificaciones', 'No se pudieron activar. Revisa permisos del sitio/navegador.');
      } else {
        showToast('ok', 'Notificaciones', 'Activadas. Deja esta pesta√±a abierta para recibir avisos.');
      }
      paintNotifStatus();

      if (Notification.permission === "granted") {
        startNotifLoop();
        if (LAST_EVENTS.length) runNotificationRules(LAST_EVENTS);
      }
    }

    // ‚úÖ Router global ya maneja el data-action, pero dejamos onClick por compatibilidad segura
    btnNotifs.onclick = handleEnableNotifs;
    paintNotifStatus();

    /* ============================================================
      ‚úÖ ALERTAS + PRO BADGES + QUICK ACTIONS
    ============================================================ */
    function renderAlerts(event){
      const type = normalizeType(event.type);
      const meta = event.metadata && typeof event.metadata === 'object' ? event.metadata : {};
      const start = toDate(event.start_time);
      if (!start) return '';

      const alerts = [];

      if (type === 'flight' && meta.checkin_url) {
        const ms = msUntil(start);
        const hoursToStart = ms / (60 * 60 * 1000);
        const windowHours = Number(meta.checkin_available_window_hours || 48);

        if (hoursToStart <= windowHours && hoursToStart > -24) {
          alerts.push(`<span class="alert-badge ok">‚úÖ Check-in disponible</span>`);
        } else if (hoursToStart > windowHours) {
          const msToOpen = ms - (windowHours*60*60*1000);
          alerts.push(`<span class="alert-badge warn">üïí Check-in ${humanCountdown(msToOpen)}</span>`);
        }
      }

      if (type === 'flight') {
        const ms = msUntil(start);
        const hours = ms / (60 * 60 * 1000);
        if (hours <= 3 && hours > 0) {
          alerts.push(`<span class="alert-badge danger">‚è∞ Salir al aeropuerto ${humanCountdown(ms)}</span>`);
        }
      }

      return alerts.length ? `<div class="alert-row">${alerts.join('')}</div>` : '';
    }

    function renderProBadges(event){
      const meta = event.metadata;
      const badges = [];

      if (event.location) {
        const url = mapsUrlFromMetaOrLocation(meta, event.location);
        badges.push(
          `<span class="pro-badge">
            <strong>üìç</strong> ${esc(event.location)}
            ${url ? `&nbsp;¬∑&nbsp;<a href="${url}" target="_blank" rel="noopener">Mapa</a>` : ``}
          </span>`
        );
      }

      if (event.source) badges.push(`<span class="pro-badge"><strong>source:</strong> ${esc(event.source)}</span>`);

      if (!meta || typeof meta !== 'object') {
        return badges.length ? `<div class="pro-row">${badges.join('')}</div>` : '';
      }

      const type = normalizeType(event.type);

      if (type === 'activity' && meta.subtype) {
        const st = normalizeType(meta.subtype);
        badges.push(`<span class="pro-badge"><strong>subtype:</strong> ${esc(st)}</span>`);
      }

      if (type === 'flight') {
        if (meta.flight_number) badges.push(`<span class="pro-badge"><strong>Vuelo:</strong> ${esc(meta.flight_number)}</span>`);
        if (meta.airline) badges.push(`<span class="pro-badge"><strong>Aerol√≠nea:</strong> ${esc(meta.airline)}</span>`);
        if (meta.seat) badges.push(`<span class="pro-badge"><strong>Asiento:</strong> ${esc(meta.seat)}</span>`);
        if (Array.isArray(meta.documents) && meta.documents.length) {
          badges.push(`<span class="pro-badge"><strong>Docs:</strong> ${esc(meta.documents.join(', '))}</span>`);
        }
        if (meta.pnr) badges.push(`<span class="pro-badge"><strong>PNR:</strong> ${esc(meta.pnr)}</span>`);

        if (meta.checkin_url) badges.push(`<span class="pro-badge"><strong>Check-in:</strong> <a href="${esc(meta.checkin_url)}" target="_blank" rel="noopener">abrir</a></span>`);
        if (meta.booking_url) badges.push(`<span class="pro-badge"><strong>Reserva:</strong> <a href="${esc(meta.booking_url)}" target="_blank" rel="noopener">abrir</a></span>`);
      }

      if (type === 'hotel') {
        if (meta.hotel_name) badges.push(`<span class="pro-badge"><strong>Hotel:</strong> ${esc(meta.hotel_name)}</span>`);
        if (meta.check_in) badges.push(`<span class="pro-badge"><strong>Check-in:</strong> ${esc(meta.check_in)}</span>`);
        if (meta.check_out) badges.push(`<span class="pro-badge"><strong>Check-out:</strong> ${esc(meta.check_out)}</span>`);
        if (meta.address) badges.push(`<span class="pro-badge"><strong>Direcci√≥n:</strong> ${esc(meta.address)}</span>`);
        if (meta.reservation) badges.push(`<span class="pro-badge"><strong>Reserva:</strong> ${esc(meta.reservation)}</span>`);
        if (meta.booking_url) badges.push(`<span class="pro-badge"><strong>Reserva:</strong> <a href="${esc(meta.booking_url)}" target="_blank" rel="noopener">abrir</a></span>`);
      }

      if (type === 'activity') {
        if (meta.place) badges.push(`<span class="pro-badge"><strong>Lugar:</strong> ${esc(meta.place)}</span>`);
        if (meta.operator) badges.push(`<span class="pro-badge"><strong>Operador:</strong> ${esc(meta.operator)}</span>`);
        if (meta.ticket_url) badges.push(`<span class="pro-badge"><strong>Link:</strong> <a href="${esc(meta.ticket_url)}" target="_blank" rel="noopener">abrir</a></span>`);
        if (meta.reference) badges.push(`<span class="pro-badge"><strong>Ref:</strong> ${esc(meta.reference)}</span>`);
      }

      if (type === 'transfer' || type === 'car' || type === 'bus') {
        if (meta.pickup) badges.push(`<span class="pro-badge"><strong>Pickup:</strong> ${esc(meta.pickup)}</span>`);
        if (meta.dropoff) badges.push(`<span class="pro-badge"><strong>Dropoff:</strong> ${esc(meta.dropoff)}</span>`);
        if (meta.company) badges.push(`<span class="pro-badge"><strong>Proveedor:</strong> ${esc(meta.company)}</span>`);
        if (meta.reference) badges.push(`<span class="pro-badge"><strong>Ref:</strong> ${esc(meta.reference)}</span>`);
      }

      if (type === 'cruise') {
        if (meta.operator) badges.push(`<span class="pro-badge"><strong>Operador:</strong> ${esc(meta.operator)}</span>`);
        if (meta.cabin) badges.push(`<span class="pro-badge"><strong>Cabina:</strong> ${esc(meta.cabin)}</span>`);
        if (meta.reference) badges.push(`<span class="pro-badge"><strong>Ref:</strong> ${esc(meta.reference)}</span>`);
      }

      if (type === 'train') {
        if (meta.company) badges.push(`<span class="pro-badge"><strong>Operador:</strong> ${esc(meta.company)}</span>`);
        if (meta.reference) badges.push(`<span class="pro-badge"><strong>Ref:</strong> ${esc(meta.reference)}</span>`);
      }

      if (Object.keys(meta).length && badges.length === 0) {
        badges.push(`<span class="pro-badge"><strong>meta:</strong> ${esc(Object.keys(meta).slice(0,4).join(', '))}${Object.keys(meta).length>4 ? '‚Ä¶' : ''}</span>`);
      }

      return badges.length ? `<div class="pro-row">${badges.join('')}</div>` : '';
    }

    function primaryUrlFromEvent(event){
      const meta = (event.metadata && typeof event.metadata === 'object') ? event.metadata : {};
      if (meta.checkin_url) return String(meta.checkin_url);
      if (meta.booking_url) return String(meta.booking_url);
      if (meta.ticket_url) return String(meta.ticket_url);
      return null;
    }

    async function copyEventSummary(event){
      const meta = (event.metadata && typeof event.metadata === 'object') ? event.metadata : {};
      const d = toDate(event.start_time);
      const when = d ? `${formatDay(d)} ${formatTime(d)}` : 'Sin fecha';
      let metaTxt = '';
      try{
        const keys = Object.keys(meta || {});
        if (keys.length){
          metaTxt = `\nMeta: ${JSON.stringify(meta)}`;
        }
      }catch(e){}
      const txt =
`MyTrips ‚Äî Evento
T√≠tulo: ${event.title || ''}
Cu√°ndo: ${when}
Lugar: ${event.location || ''}
Tipo: ${event.type || ''}
${event.description ? `Descripci√≥n: ${event.description}` : ''}${metaTxt}`.trim();

      try{
        await navigator.clipboard.writeText(txt);
        showToast('ok', 'Copiar', 'Copiado al portapapeles.');
      }catch(e){
        const ta = document.createElement('textarea');
        ta.value = txt;
        document.body.appendChild(ta);
        ta.select();
        try{
          document.execCommand('copy');
          showToast('ok', 'Copiar', 'Copiado al portapapeles.');
        }catch(_e){
          showToast('err', 'Copiar', 'No se pudo copiar.');
        }
        document.body.removeChild(ta);
      }
    }

    function renderQuickActions(event){
      const meta = (event.metadata && typeof event.metadata === 'object') ? event.metadata : {};
      const mapUrl = mapsUrlFromMetaOrLocation(meta, event.location);
      const mainUrl = primaryUrlFromEvent(event);

      const mapDisabled = mapUrl ? '' : 'disabled';
      const linkDisabled = mainUrl ? '' : 'disabled';

      return `
        <div class="quick-actions">
          <button class="qbtn" type="button" data-qaction="map" ${mapDisabled}>üìç Mapa</button>
          <button class="qbtn" type="button" data-qaction="link" ${linkDisabled}>üîó Link</button>
          <button class="qbtn" type="button" data-qaction="copy">üìã Copiar</button>
          <button class="qbtn" type="button" data-qaction="cal">üìÖ Calendario</button>
        </div>
      `;
    }

    /* ============================================================
      ‚úÖ FASE 2.2 (NUEVO): ESTADO FILTROS
    ============================================================ */
    const searchInput = document.getElementById('searchInput');
    const typeFilter = document.getElementById('typeFilter');
    let RANGE_FILTER = 'all';

    function setActiveChip(range){
      RANGE_FILTER = range;
      document.querySelectorAll('.chip').forEach(ch => {
        ch.classList.toggle('active', ch.dataset.range === range);
      });
      if (activeTripId) loadEvents(activeTripId);
    }

    document.querySelectorAll('.chip').forEach(ch => {
      ch.onclick = () => setActiveChip(ch.dataset.range);
    });

    let SEARCH_TIMER = null;
    searchInput.addEventListener('input', () => {
      if (SEARCH_TIMER) clearTimeout(SEARCH_TIMER);
      SEARCH_TIMER = setTimeout(() => {
        if (activeTripId) loadEvents(activeTripId);
      }, 250);
    });

    typeFilter.addEventListener('change', () => {
      if (activeTripId) loadEvents(activeTripId);
    });

    function dayKeyFromDate(d){
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }

    function buildSearchText(ev){
      const parts = [];
      parts.push(ev.title || '');
      parts.push(ev.description || '');
      parts.push(ev.location || '');
      parts.push(ev.type || '');
      try{
        const meta = (ev.metadata && typeof ev.metadata === 'object') ? ev.metadata : {};
        parts.push(JSON.stringify(meta));
      }catch(e){}
      return parts.join(' ').toLowerCase();
    }

    function eventMatchesFilters(ev){
      const tf = (typeFilter.value || '').trim();
      if (tf){
        const t = normalizeType(ev.type);
        if (t !== tf) return false;
      }

      const q = (searchInput.value || '').trim().toLowerCase();
      if (q){
        const hay = buildSearchText(ev);
        if (!hay.includes(q)) return false;
      }

      if (RANGE_FILTER !== 'all'){
        const d = toDate(ev.start_time);
        if (!d) return false;
        const now = new Date();
        const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const startKey = dayKeyFromDate(startOfToday);

        const evKey = dayKeyFromDate(new Date(d.getFullYear(), d.getMonth(), d.getDate()));

        if (RANGE_FILTER === 'today'){
          return evKey === startKey;
        }

        if (RANGE_FILTER === 'tomorrow'){
          const tmr = new Date(startOfToday.getTime() + 24*60*60*1000);
          return evKey === dayKeyFromDate(tmr);
        }

        if (RANGE_FILTER === 'next7'){
          const ms = d.getTime() - startOfToday.getTime();
          const days = Math.floor(ms / (24*60*60*1000));
          return days >= 0 && days <= 6;
        }
      }

      return true;
    }

    /* ============================================================
      ‚úÖ FASE 2.2 (NUEVO): CONTROLES DE VISTA
    ============================================================ */
    const expandAllBtn = document.getElementById('expandAllBtn');
    const collapseAllBtn = document.getElementById('collapseAllBtn');
    const accordionToggle = document.getElementById('accordionToggle');
    const viewHint = document.getElementById('viewHint');

    let DAY_KEYS_CURRENT = [];

    function viewStorageKey(){
      return `viewPrefs:${activeTripId || 'none'}`;
    }

    function loadViewPrefs(){
      if (!activeTripId) return;
      try{
        const raw = localStorage.getItem(viewStorageKey());
        if (!raw) { accordionToggle.checked = false; return; }
        const obj = JSON.parse(raw);
        accordionToggle.checked = !!obj.accordion;
      }catch(e){
        accordionToggle.checked = false;
      }
    }

    function saveViewPrefs(){
      if (!activeTripId) return;
      try{
        localStorage.setItem(viewStorageKey(), JSON.stringify({
          accordion: !!accordionToggle.checked
        }));
      }catch(e){}
    }

    accordionToggle.addEventListener('change', () => {
      saveViewPrefs();
      paintViewHint();
      if (activeTripId) loadEvents(activeTripId);
    });

    function paintViewHint(){
      viewHint.textContent = accordionToggle.checked
        ? "Acorde√≥n activo: solo un d√≠a abierto a la vez."
        : "Acorde√≥n apagado: puedes abrir varios d√≠as.";
    }
    paintViewHint();

    function collapseAllDays(){
      COLLAPSED_DAYS = new Set(DAY_KEYS_CURRENT.filter(k => k !== 'sin-fecha'));
      saveCollapsedDays();
      if (activeTripId) loadEvents(activeTripId);
    }

    function expandAllDays(){
      COLLAPSED_DAYS = new Set();
      saveCollapsedDays();
      if (activeTripId) loadEvents(activeTripId);
    }

    expandAllBtn.onclick = () => {
      if (!activeTripId) return;
      expandAllDays();
    };

    collapseAllBtn.onclick = () => {
      if (!activeTripId) return;
      collapseAllDays();
    };

    /* ============================================================
      ‚úÖ MODAL / CRUD
    ============================================================ */
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalTitle = document.getElementById('modalTitle');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const saveBtn = document.getElementById('saveBtn');
    const deleteBtn = document.getElementById('deleteBtn');

    const tripForm = document.getElementById('tripForm');
    const eventForm = document.getElementById('eventForm');

    const t_title = document.getElementById('t_title');
    const t_start = document.getElementById('t_start');
    const t_end = document.getElementById('t_end');

    const f_title = document.getElementById('f_title');
    const f_type = document.getElementById('f_type');
    const f_start = document.getElementById('f_start');
    const f_order = document.getElementById('f_order');
    const f_location = document.getElementById('f_location');
    const f_source = document.getElementById('f_source');
    const f_desc = document.getElementById('f_desc');
    const f_meta = document.getElementById('f_meta');

    const f_date = document.getElementById('f_date');
    const f_time = document.getElementById('f_time');

    const addEventBtn = document.getElementById('addEventBtn');
    const addTripBtn = document.getElementById('addTripBtn');

    let mode = "event";
    let editingEventId = null;
    let editingTripId = null;

    function openModal(){
      modalBackdrop.style.display = 'flex';
      // ‚úÖ NUEVO: enfoque en el primer input visible
      setTimeout(() => {
        try{
          const first = modalBackdrop.querySelector('.modal-body input:not(.hidden), .modal-body textarea:not(.hidden), .modal-body select:not(.hidden)');
          if (first && first.focus) first.focus();
        }catch(e){}
      }, 0);
    }
    function closeModal(){
      modalBackdrop.style.display = 'none';
      editingEventId = null;
      editingTripId = null;
      mode = "event";
    }

    closeModalBtn.onclick = closeModal;

    modalBackdrop.addEventListener('click', (e) => {
      if (e.target === modalBackdrop && CLOSE_ON_BACKDROP_CLICK) closeModal();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modalBackdrop.style.display === 'flex') closeModal();
    });

    function showTripForm(){
      mode = "trip";
      tripForm.classList.remove('hidden');
      eventForm.classList.add('hidden');
    }
    function showEventForm(){
      mode = "event";
      eventForm.classList.remove('hidden');
      tripForm.classList.add('hidden');
    }

    function resetEventForm(){
      f_title.value = '';
      f_type.value = 'activity';
      f_start.value = '';
      f_order.value = '';
      f_location.value = '';
      f_source.value = 'manual';
      f_desc.value = '';
      f_meta.value = '';

      f_date.value = '';
      f_time.value = '';
    }

    function resetTripForm(){
      t_title.value = '';
      t_start.value = '';
      t_end.value = '';
    }

    function handleOpenAddTrip(){
      editingTripId = null;
      modalTitle.textContent = 'Agregar viaje';
      deleteBtn.style.display = 'none';
      saveBtn.textContent = 'üíæ Guardar';
      resetTripForm();
      showTripForm();
      openModal();
    }

    function handleOpenAddEvent(){
      if (!activeTripId) {
        showToast('warn', 'Evento', 'Primero selecciona un viaje.');
        return;
      }
      editingEventId = null;
      modalTitle.textContent = 'Agregar evento';
      deleteBtn.style.display = 'none';
      saveBtn.textContent = 'üíæ Guardar';

      resetEventForm();
      showEventForm();
      openModal();
    }

    // ‚úÖ Router global ya maneja data-action. Mantener por compatibilidad (no rompe).
    addTripBtn.onclick = handleOpenAddTrip;
    addEventBtn.onclick = handleOpenAddEvent;

    function openModalEditEvent(event){
      editingEventId = event.id;

      modalTitle.textContent = 'Editar evento';
      deleteBtn.style.display = 'inline-block';
      saveBtn.textContent = 'üíæ Guardar cambios';

      f_title.value = event.title || '';
      f_type.value = normalizeType(event.type || 'other');
      f_start.value = fromIsoToLocalInput(event.start_time);
      f_order.value = (event.order_index ?? '') === null ? '' : String(event.order_index ?? '');
      f_location.value = event.location || '';
      f_source.value = event.source || 'manual';
      f_desc.value = event.description || '';

      const d = toDate(event.start_time);
      if (d){
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        const hh = String(d.getHours()).padStart(2,'0');
        const mm = String(d.getMinutes()).padStart(2,'0');
        f_date.value = `${y}-${m}-${dd}`;
        f_time.value = `${hh}:${mm}`;
      } else {
        f_date.value = '';
        f_time.value = '';
      }

      try {
        const meta = (event.metadata && typeof event.metadata === 'object') ? event.metadata : {};
        f_meta.value = JSON.stringify(meta, null, 2);
      } catch(e) {
        f_meta.value = '';
      }

      showEventForm();
      openModal();
    }

    function openModalEditTrip(trip){
      editingTripId = trip.id;

      modalTitle.textContent = 'Editar viaje';
      deleteBtn.style.display = 'inline-block';
      saveBtn.textContent = 'üíæ Guardar cambios';

      t_title.value = trip.title || '';
      t_start.value = trip.start_date ? String(trip.start_date).slice(0,10) : '';
      t_end.value = trip.end_date ? String(trip.end_date).slice(0,10) : '';

      showTripForm();
      openModal();
    }

    saveBtn.onclick = async () => {
      if (mode === "trip") {
        const title = t_title.value.trim();
        if (!title) {
          showToast('warn', 'Viaje', 'El nombre del viaje es obligatorio.');
          return;
        }

        const payload = {
          title,
          start_date: t_start.value || null,
          end_date: t_end.value || null
        };

        if (!editingTripId) {
          const { data, error } = await sb.from('trips').insert(payload).select('*').single();
          if (error) {
            reportDbError('Crear viaje', error);
            return;
          }
          showToast('ok', 'Viaje creado', 'Listo. Ya puedes agregar eventos.');
          closeModal();
          await loadTrips();
          if (data?.id) {
            setActiveTrip(data.id, true);
          }
          return;
        }

        const { data, error } = await sb
          .from('trips')
          .update(payload)
          .eq('id', editingTripId)
          .select('*')
          .single();

        if (error) {
          reportDbError('Guardar viaje', error);
          return;
        }

        if (!data) {
          showToast('warn', 'Guardar viaje', 'No se devolvi√≥ el registro actualizado. Revisa RLS/policies.');
        } else {
          showToast('ok', 'Viaje actualizado', 'Cambios guardados.');
        }

        closeModal();
        await loadTrips();
        if (activeTripId) await loadEvents(activeTripId);
        return;
      }

      if (!activeTripId) {
        showToast('warn', 'Evento', 'Primero selecciona un viaje.');
        return;
      }

      const title = f_title.value.trim();
      if (!title) {
        showToast('warn', 'Evento', 'El t√≠tulo es obligatorio.');
        return;
      }

      const rawStart = (f_start.value || '').trim();
      let startIso = null;

      if (rawStart) {
        startIso = fromLocalInputToIso(rawStart);
        if (!startIso) startIso = null;
      } else {
        const ds = (f_date.value || '').trim();
        const ts = (f_time.value || '').trim();
        if (ds){
          startIso = isoFromDateAndTime(ds, ts, DEFAULT_TIME_IF_ONLY_DATE);
          if (!startIso) startIso = null;
        } else {
          startIso = null;
        }
      }

      const orderIndex = f_order.value === '' ? null : Number(f_order.value);

      let metaObj = {};
      const metaRaw = f_meta.value.trim();
      if (metaRaw) {
        try {
          metaObj = JSON.parse(metaRaw);
        } catch (e) {
          showToast('warn', 'Metadata', 'No es JSON v√°lido. Corr√≠gelo o d√©jalo vac√≠o.');
          return;
        }
      }

      const payload = {
        trip_id: activeTripId,
        title,
        type: f_type.value,
        start_time: startIso,
        order_index: (Number.isFinite(orderIndex) ? orderIndex : null),
        location: f_location.value.trim() || null,
        source: f_source.value || 'manual',
        description: f_desc.value.trim() || null,
        metadata: metaObj
      };

      if (!editingEventId) {
        const { error } = await sb.from('events').insert(payload);
        if (error) {
          reportDbError('Crear evento', error);
          return;
        }
        showToast('ok', 'Evento creado', 'Guardado correctamente.');
        closeModal();
        loadEvents(activeTripId);
        return;
      }

      const { data, error } = await sb
        .from('events')
        .update(payload)
        .eq('id', editingEventId)
        .select('*')
        .single();

      if (error) {
        reportDbError('Guardar evento', error);
        return;
      }

      if (!data) {
        showToast('warn', 'Guardar evento', 'No se devolvi√≥ el registro actualizado. Revisa RLS/policies.');
      } else {
        showToast('ok', 'Evento actualizado', 'Cambios guardados.');
      }

      closeModal();
      loadEvents(activeTripId);
    };

    async function deleteTripById(tripId){
      const ok = confirm('¬øSeguro que quieres borrar este viaje?');
      if (!ok) return;

      const ok2 = confirm('¬øTambi√©n borrar TODOS los eventos de este viaje? (recomendado si no hay cascade)');
      if (ok2) {
        const delEvents = await sb.from('events').delete().eq('trip_id', tripId);
        if (delEvents.error) {
          reportDbError('Borrar eventos', delEvents.error);
          return;
        }
      }

      const { error } = await sb.from('trips').delete().eq('id', tripId);
      if (error) {
        reportDbError('Borrar viaje', error);
        return;
      }

      showToast('ok', 'Viaje borrado', 'Se elimin√≥ correctamente.');

      if (activeTripId === String(tripId)) {
        clearActiveTripSelection(false);
      }

      await loadTrips();
    }

    deleteBtn.onclick = async () => {
      if (mode === "trip") {
        if (!editingTripId) return;
        await deleteTripById(editingTripId);
        closeModal();
        return;
      }

      if (!editingEventId) return;

      const ok = confirm('¬øSeguro que quieres borrar este evento? Esta acci√≥n no se puede deshacer.');
      if (!ok) return;

      const { error } = await sb.from('events').delete().eq('id', editingEventId);
      if (error) {
        reportDbError('Borrar evento', error);
        return;
      }

      showToast('ok', 'Evento borrado', 'Se elimin√≥ correctamente.');
      closeModal();
      loadEvents(activeTripId);
    };

    /* ============================================================
      ‚úÖ NUEVO: SELECCI√ìN / DESELECCI√ìN DE VIAJE
      - Bot√≥n ‚ÄúOcultar timeline‚Äù limpia selecci√≥n
      ‚úÖ FIX: clic al MISMO viaje = contraer / deseleccionar
    ============================================================ */
    function persistActiveTripId(){
      try{
        if (!activeTripId) localStorage.removeItem(LAST_TRIP_STORAGE_KEY);
        else localStorage.setItem(LAST_TRIP_STORAGE_KEY, String(activeTripId));
      }catch(e){}
    }

    function readPersistedTripId(){
      try{
        const v = localStorage.getItem(LAST_TRIP_STORAGE_KEY);
        return v ? String(v) : null;
      }catch(e){
        return null;
      }
    }

    function clearActiveTripSelection(showToastMsg = true){
      activeTripId = null;
      persistActiveTripId();

      document.querySelectorAll('.trip').forEach(x => x.classList.remove('active'));

      const eventsDiv = document.getElementById('events');
      eventsDiv.classList.add('muted');
      eventsDiv.innerHTML = `<div class="muted">Selecciona un viaje para ver su timeline.</div>`;

      LAST_EVENTS = [];
      stopNotifLoop();

      if (showToastMsg) showToast('info', 'Timeline', 'Timeline oculto. Selecciona un viaje para verlo.');
    }

    async function setActiveTrip(tripId, userInitiated = false){
      activeTripId = tripId ? String(tripId) : null;
      persistActiveTripId();

      document.querySelectorAll('.trip').forEach(x => {
        x.classList.toggle('active', x.getAttribute('data-trip-id') === String(activeTripId));
      });

      if (!activeTripId){
        clearActiveTripSelection(false);
        return;
      }

      loadViewPrefs();
      paintViewHint();
      await loadEvents(activeTripId);

      if (userInitiated) showToast('ok', 'Viaje', 'Seleccionado.');
    }

    async function loadTrips() {
      const tripsDiv = document.getElementById('trips');
      tripsDiv.classList.add('muted');
      tripsDiv.innerHTML = 'Cargando viajes...';

      const { data, error } = await sb.from('trips').select('*').order('start_date', { ascending: true });

      if (error) {
        tripsDiv.innerText = 'Error cargando viajes: ' + error.message;
        reportDbError('Viajes', error);
        return;
      }

      if (!data || data.length === 0) {
        tripsDiv.innerHTML = `<div class="empty">No hay viajes a√∫n.</div>`;
        clearActiveTripSelection(false);
        return;
      }

      tripsDiv.classList.remove('muted');
      tripsDiv.innerHTML = '';

      data.forEach(trip => {
        const div = document.createElement('div');
        div.className = 'trip';
        div.setAttribute('data-trip-id', String(trip.id));

        const left = document.createElement('div');
        left.innerHTML = `<strong>${esc(trip.title)}</strong>`;

        const actions = document.createElement('div');
        actions.className = 'trip-actions';

        const editBtn = document.createElement('button');
        editBtn.className = 'icon-btn';
        editBtn.type = 'button';
        editBtn.textContent = '‚úèÔ∏è Editar';
        editBtn.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          openModalEditTrip(trip);
        };

        const delBtn = document.createElement('button');
        delBtn.className = 'icon-btn';
        delBtn.type = 'button';
        delBtn.textContent = 'üóëÔ∏è Borrar';
        delBtn.onclick = async (e) => {
          e.preventDefault();
          e.stopPropagation();
          await deleteTripById(trip.id);
        };

        actions.appendChild(editBtn);
        actions.appendChild(delBtn);

        div.appendChild(left);
        div.appendChild(actions);

        // ‚úÖ FIX: si clicas el mismo viaje, se contrae (deselecciona)
        div.onclick = async () => {
          const clickedId = String(trip.id);
          const currentId = activeTripId ? String(activeTripId) : null;

          if (TOGGLE_TRIP_ON_SECOND_CLICK && currentId && clickedId === currentId){
            clearActiveTripSelection(true);
            return;
          }

          await setActiveTrip(clickedId, true);
        };

        tripsDiv.appendChild(div);
      });

      const persisted = readPersistedTripId();
      const exists = persisted && data.some(t => String(t.id) === String(persisted));

      if (exists){
        await setActiveTrip(persisted, false);
      } else if (AUTO_SELECT_FIRST_TRIP){
        await setActiveTrip(data[0].id, false);
      } else {
        clearActiveTripSelection(false);
      }
    }

    /* ============================================================
      ‚úÖ FASE 2.2 + 2.3: RENDER TIMELINE
      ‚úÖ FIX adicional: evita ‚Äústale render‚Äù si cambias de viaje r√°pido
    ============================================================ */
    let EVENTS_RENDER_TOKEN = 0; // ‚úÖ NUEVO: token anti-carrera (si cambias de viaje mientras carga)

    async function loadEvents(tripId) {
      const eventsDiv = document.getElementById('events');
      const token = ++EVENTS_RENDER_TOKEN;

      if (!tripId){
        eventsDiv.classList.add('muted');
        eventsDiv.innerHTML = `<div class="muted">Selecciona un viaje para ver su timeline.</div>`;
        return;
      }

      eventsDiv.classList.remove('muted');
      eventsDiv.innerHTML = 'Cargando timeline...';

      loadCollapsedDays();

      const { data, error } = await sb
        .from('events')
        .select('*')
        .eq('trip_id', tripId)
        .order('order_index', { ascending: true, nullsFirst: false })
        .order('start_time', { ascending: true });

      // ‚úÖ Si ya cambiaste de viaje, aborta render
      if (token !== EVENTS_RENDER_TOKEN) return;

      if (error) {
        eventsDiv.innerText = 'Error cargando eventos: ' + error.message;
        reportDbError('Eventos', error);
        return;
      }

      if (!data || data.length === 0) {
        eventsDiv.innerHTML = `<div class="empty">Este viaje a√∫n no tiene eventos.</div>`;
        LAST_EVENTS = [];
        return;
      }

      const dataClean = dedupeEvents(data);
      const filtered = dataClean.filter(eventMatchesFilters);

      LAST_EVENTS = filtered;

      if (canNotify() && Notification.permission === 'granted') startNotifLoop();
      await runNotificationRules(filtered);

      if (!filtered.length){
        eventsDiv.innerHTML = `<div class="empty">No hay eventos que coincidan con tus filtros/b√∫squeda.</div>`;
        return;
      }

      const grouped = groupByDay(filtered);
      const dayKeys = Array.from(grouped.keys()).sort((a,b) => {
        if (a === 'sin-fecha') return 1;
        if (b === 'sin-fecha') return -1;
        return a.localeCompare(b);
      });

      DAY_KEYS_CURRENT = dayKeys.slice();

      // ‚úÖ Si acorde√≥n activo y no hay preferencias guardadas, abre el primer d√≠a
      try{
        const raw = localStorage.getItem(collapsedStorageKey());
        const hasSaved = !!raw;
        if (!hasSaved && accordionToggle.checked){
          const firstDay = dayKeys.find(k => k !== 'sin-fecha') || dayKeys[0];
          const nextSet = new Set();
          dayKeys.forEach(k => { if (k !== firstDay) nextSet.add(k); });
          COLLAPSED_DAYS = nextSet;
          saveCollapsedDays();
        }
      }catch(e){}

      eventsDiv.innerHTML = '';

      for (const dayKey of dayKeys) {
        const list = grouped.get(dayKey) || [];

        list.sort((a,b) => {
          const ai = (a.order_index ?? null);
          const bi = (b.order_index ?? null);
          if (ai !== null && bi !== null && ai !== bi) return ai - bi;
          if (ai !== null && bi === null) return -1;
          if (ai === null && bi !== null) return 1;

          const da = toDate(a.start_time);
          const db = toDate(b.start_time);
          if (!da && !db) return 0;
          if (!da) return 1;
          if (!db) return -1;
          return da - db;
        });

        const dayRow = document.createElement('div');
        dayRow.className = 'day-row';

        const pill = document.createElement('div');
        pill.className = 'day';

        const collapsed = isDayCollapsed(dayKey);
        if (collapsed) dayRow.classList.add('is-collapsed');

        const caret = document.createElement('span');
        caret.className = 'day-caret';
        caret.textContent = collapsed ? '‚ñ∏' : '‚ñæ';

        const label = document.createElement('span');
        if (dayKey === 'sin-fecha') {
          label.textContent = 'Sin fecha';
        } else {
          const parts = dayKey.split('-');
          const d = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
          label.textContent = formatDay(d);
        }

        pill.appendChild(caret);
        pill.appendChild(label);

        pill.onclick = () => {
          if (accordionToggle.checked){
            const wasCollapsed = isDayCollapsed(dayKey);

            if (!wasCollapsed){
              toggleDayCollapsed(dayKey);
            } else {
              const nextSet = new Set();
              DAY_KEYS_CURRENT.forEach(k => { if (k !== dayKey) nextSet.add(k); });
              COLLAPSED_DAYS = nextSet;
              saveCollapsedDays();
            }

            loadEvents(activeTripId);
            return;
          }

          toggleDayCollapsed(dayKey);
          const nowCollapsed = isDayCollapsed(dayKey);
          caret.textContent = nowCollapsed ? '‚ñ∏' : '‚ñæ';
          dayRow.classList.toggle('is-collapsed', nowCollapsed);
        };

        dayRow.appendChild(pill);
        const line = document.createElement('div');
        line.className = 'day-line';
        dayRow.appendChild(line);

        const dayEventsWrap = document.createElement('div');
        dayEventsWrap.className = 'day-events';

        eventsDiv.appendChild(dayRow);
        eventsDiv.appendChild(dayEventsWrap);

        for (const event of list) {
          const type = normalizeType(event.type);

          const meta = (event.metadata && typeof event.metadata === 'object') ? event.metadata : {};
          const subtype = normalizeType(meta.subtype);

          const ui =
            (type === 'activity' && subtype && TYPE_UI[subtype])
              ? TYPE_UI[subtype]
              : (TYPE_UI[type] || TYPE_UI.other);

          const d = toDate(event.start_time);
          const time = d ? formatTime(d) : '--:--';

          const alertsHtml = renderAlerts(event);
          const proBadgesHtml = renderProBadges(event);
          const quickActionsHtml = renderQuickActions(event);

          const card = document.createElement('div');
          card.className = 'event';

          card.innerHTML = `
            <div class="icon" style="background:${ui.bg}; border:1px solid var(--border);">
              <span style="color:${ui.color}">${ui.icon}</span>
            </div>
            <div class="event-body">
              <div class="event-top">
                <p class="event-title">${esc(event.title || '(sin t√≠tulo)')}</p>
                <div class="event-time">${esc(time)}</div>
              </div>
              ${event.description ? `<div class="event-desc">${esc(event.description)}</div>` : ``}
              ${alertsHtml}
              ${quickActionsHtml}
              ${proBadgesHtml}
              <div class="event-meta">
                <span class="badge">${ui.label}</span>
                <span class="badge">tipo: ${esc(event.type || 'unknown')}</span>
              </div>
            </div>
          `;

          /* ============================================================
            ‚úÖ TAP vs SCROLL + BLOQUEO REAL EN BOTONES
          ============================================================ */
          function isQuickActionTarget(el){
            try{ return !!(el && el.closest && el.closest('.qbtn')); }catch(e){ return false; }
          }

          let downPt = null;
          let blockEditUntil = 0;

          card.addEventListener('pointerdown', (e) => {
            if (isQuickActionTarget(e.target)) { downPt = null; return; }
            downPt = { x: e.clientX, y: e.clientY };
          });

          card.addEventListener('pointerup', (e) => {
            if (isQuickActionTarget(e.target)) { downPt = null; return; }
            if (Date.now() < blockEditUntil) { downPt = null; return; }

            if (!downPt) return;
            const dx = Math.abs(e.clientX - downPt.x);
            const dy = Math.abs(e.clientY - downPt.y);
            downPt = null;

            if (dx <= CARD_TAP_MAX_MOVE_PX && dy <= CARD_TAP_MAX_MOVE_PX) {
              openModalEditEvent(event);
            }
          });

          card.querySelectorAll('.qbtn').forEach(btn => {
            const armBlock = (e) => {
              try{
                blockEditUntil = Date.now() + CARD_BLOCK_EDIT_AFTER_QACTION_MS;
                downPt = null;
                e.preventDefault();
                e.stopPropagation();
                if (e.stopImmediatePropagation) e.stopImmediatePropagation();
              }catch(_e){}
            };

            btn.addEventListener('pointerdown', armBlock, { capture: true });
            btn.addEventListener('touchstart', armBlock, { capture: true, passive: false });

            btn.addEventListener('click', async (e) => {
              e.preventDefault();
              e.stopPropagation();
              if (e.stopImmediatePropagation) e.stopImmediatePropagation();
              blockEditUntil = Date.now() + CARD_BLOCK_EDIT_AFTER_QACTION_MS;

              const qaction = btn.getAttribute('data-qaction');
              const meta = (event.metadata && typeof event.metadata === 'object') ? event.metadata : {};
              const mapUrl = mapsUrlFromMetaOrLocation(meta, event.location);
              const mainUrl = primaryUrlFromEvent(event);

              if (qaction === 'map' && mapUrl){
                window.open(mapUrl, '_blank', 'noopener');
                return;
              }
              if (qaction === 'link' && mainUrl){
                window.open(mainUrl, '_blank', 'noopener');
                return;
              }
              if (qaction === 'copy'){
                await copyEventSummary(event);
                return;
              }
              if (qaction === 'cal'){
                const ics = icsForSingleEvent(event);
                if (!ics){
                  showToast('warn', 'Calendario', 'Este evento no tiene fecha/hora v√°lida.');
                  return;
                }
                const r = saveIcsToDevice(`mytrips_event_${event.id || 'x'}.ics`, ics);

                if (r?.opened){
                  showToast('ok', 'Calendario', 'Listo. Se abri√≥ el .ics: el sistema deber√≠a preguntarte si deseas agregarlo al Calendario.');
                } else if (r?.downloaded){
                  showToast('warn', 'Calendario', 'Se descarg√≥ el .ics. √Åbrelo desde Descargas/Archivos para agregarlo al Calendario.');
                } else {
                  showToast('warn', 'Calendario', 'No se pudo abrir/descargar el .ics. Revisa permisos/bloqueador del navegador.');
                }
                return;
              }
            });
          });

          dayEventsWrap.appendChild(card);
        }
      }
    }

    /* ============================================================
      ‚úÖ VIEW PREFS: hint
    ============================================================ */
    function paintViewHint(){
      viewHint.textContent = accordionToggle.checked
        ? "Acorde√≥n activo: solo un d√≠a abierto a la vez."
        : "Acorde√≥n apagado: puedes abrir varios d√≠as.";
    }
    paintViewHint();

    /* ============================================================
      ‚úÖ AUTO-REFRESH TIMELINE
    ============================================================ */
    setInterval(() => {
      if (activeTripId) loadEvents(activeTripId);
    }, REFRESH_MS);

    /* ============================================================
      ‚úÖ INIT
    ============================================================ */
    (async () => {
      try{
        await loadTrips();
      }catch(e){
        console.error(e);
        showToast('err','Init','Error inicializando MyTrips.');
      }
    })();
  </script>
</body>
</html>

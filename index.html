<!DOCTYPE html>
<html lang="es">
<head>
  <!-- ============================================================
    ‚úÖ HEAD / CONFIG B√ÅSICA
    - meta charset + viewport para que se vea bien en m√≥vil
    - t√≠tulo de la pesta√±a
    - supabase-js para leer tu base de datos desde el navegador
  ============================================================ -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MyTrips</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* ============================================================
      ‚úÖ VARIABLES DE TEMA (COLORES)
      - Aqu√≠ defines colores globales y fondos por tipo de evento
      - Si quieres cambiar el look de toda la app, lo haces aqu√≠
    ============================================================ */
    :root{
      --bg:#ffffff;
      --text:#111;
      --muted:#6b7280;
      --border:#e5e7eb;
      --card:#ffffff;
      --shadow: 0 8px 24px rgba(0,0,0,0.06);

      --flight:#2563eb;
      --hotel:#7c3aed;
      --activity:#16a34a;
      --transfer:#f59e0b;
      --other:#64748b;
      --cruise:#0ea5e9;     /* cruise */
      --car:#334155;        /* car */
      --bus:#9333ea;        /* bus */
      --train:#0f766e;      /* train */

      --flightBg: rgba(37,99,235,.08);
      --hotelBg: rgba(124,58,237,.08);
      --activityBg: rgba(22,163,74,.08);
      --transferBg: rgba(245,158,11,.10);
      --otherBg: rgba(100,116,139,.08);
      --cruiseBg: rgba(14,165,233,.10);
      --carBg: rgba(51,65,85,.08);
      --busBg: rgba(147,51,234,.10);
      --trainBg: rgba(15,118,110,.10);
    }

    /* ============================================================
      ‚úÖ ESTILO GENERAL DE P√ÅGINA
    ============================================================ */
    body{
      font-family: Arial, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }

    .container{
      max-width: 980px;
      margin: 0 auto;
      padding: 26px;
    }

    .header{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom: 16px;
    }

    h1{
      margin:0;
      font-size: 34px;
      letter-spacing: -0.4px;
    }

    h2{
      margin: 18px 0 10px;
      font-size: 22px;
    }

    .muted { color: var(--muted); font-size: 13px; }

    /* ============================================================
      ‚úÖ LISTA DE VIAJES (TRIPS)
      - Cada trip se pinta como ‚Äútarjeta clickeable‚Äù
      - .active marca el viaje seleccionado
    ============================================================ */
    .trip{
      border: 1px solid var(--border);
      padding: 12px 14px;
      margin-bottom: 10px;
      cursor: pointer;
      border-radius: 10px;
      background: #fff;
      box-shadow: 0 2px 10px rgba(0,0,0,0.03);
      transition: transform .05s ease-in-out;
    }
    .trip:hover{ transform: translateY(-1px); }
    .trip.active{
      border-color: #c7d2fe;
      background: #f5f7ff;
    }

    /* ============================================================
      ‚úÖ ENCABEZADO DE D√çA EN TIMELINE
      - ‚ÄúP√≠ldora‚Äù con fecha y l√≠nea horizontal
    ============================================================ */
    .day-row{
      margin-top: 18px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .day{
      padding: 6px 10px;
      background: #f1f5f9;
      border: 1px solid var(--border);
      border-radius: 999px;
      font-weight: 700;
      display: inline-block;
      font-size: 13px;
    }
    .day-line{ height: 1px; flex:1; background: var(--border); }

    /* ============================================================
      ‚úÖ TARJETA DE EVENTO
      - Card con √≠cono, t√≠tulo, hora, descripci√≥n, badges y alertas
    ============================================================ */
    .event{
      display:flex;
      gap: 12px;
      align-items:flex-start;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--card);
      padding: 12px 12px;
      margin: 10px 0;
      box-shadow: var(--shadow);
    }

    .icon{
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 18px;
      flex: 0 0 auto;
      margin-top: 2px;
    }

    .event-body{ flex:1; min-width: 0; }

    .event-top{
      display:flex;
      justify-content: space-between;
      align-items:baseline;
      gap: 12px;
    }

    .event-title{
      font-weight: 800;
      font-size: 16px;
      margin: 0;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .event-time{
      font-weight: 800;
      font-size: 13px;
      color: var(--muted);
      white-space: nowrap;
    }

    /* ============================================================
      ‚úÖ ALERTAS (UI)
      - Chips como: ‚Äú‚úÖ Check-in disponible‚Äù, ‚Äú‚è∞ Salir al aeropuerto‚Ä¶‚Äù
      - Son solo VISUALES (no notificaci√≥n del navegador)
    ============================================================ */
    .alert-row{
      margin-top: 8px;
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 12px;
    }
    .alert-badge{
      border: 1px solid var(--border);
      background: #fff;
      padding: 4px 8px;
      border-radius: 999px;
      font-weight: 700;
    }
    .alert-badge.warn{ background: rgba(245,158,11,.12); }
    .alert-badge.ok{ background: rgba(22,163,74,.12); }
    .alert-badge.danger{ background: rgba(239,68,68,.10); }

    .event-desc{
      margin-top: 6px;
      font-size: 13px;
      color:#333;
      line-height: 1.35;
      white-space: pre-wrap;
    }

    .event-meta{
      margin-top: 8px;
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--muted);
    }

    .badge{
      border: 1px solid var(--border);
      background: #f8fafc;
      padding: 4px 8px;
      border-radius: 999px;
    }

    .empty{
      padding: 12px;
      border: 1px dashed var(--border);
      border-radius: 12px;
      background: #fff;
      margin-top: 10px;
      color: var(--muted);
    }

    /* ============================================================
      ‚úÖ BADGES "PRO" (metadata)
      - Aqu√≠ salen los datos adicionales: airline, flight_number,
        checkin_url, hotel_name, operator, etc.
      - Tambi√©n el link "Mapa" usando location o coords
    ============================================================ */
    .pro-row{
      margin-top: 8px;
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--muted);
    }
    .pro-badge{
      border: 1px solid var(--border);
      background: #ffffff;
      padding: 4px 8px;
      border-radius: 999px;
    }
    .pro-badge strong{ color:#111; font-weight: 700; }
    .pro-badge a{ color: inherit; text-decoration: underline; }

    /* ============================================================
      ‚úÖ TOOLBAR NOTIFICACIONES
      - Bot√≥n ‚ÄúActivar notificaciones‚Äù
      - Texto de estado (si est√°n activadas/bloqueadas/no soportadas)
    ============================================================ */
    .toolbar{
      display:flex;
      align-items:center;
      gap:10px;
      margin: 6px 0 12px;
      flex-wrap: wrap;
    }
    .btn{
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      cursor: pointer;
      font-weight: 700;
    }
    .btn:disabled{
      opacity: .6;
      cursor: not-allowed;
    }
    .hint{
      font-size: 12px;
      color: var(--muted);
    }
  </style>
</head>

<body>
  <!-- ============================================================
    ‚úÖ UI (HTML)
    - trips: lista de viajes
    - toolbar: activar notificaciones
    - events: timeline agrupado por d√≠a
  ============================================================ -->
  <div class="container">
    <div class="header">
      <div style="font-size:28px;">‚úàÔ∏è</div>
      <h1>MyTrips</h1>
    </div>

    <h2>Mis viajes</h2>
    <div id="trips" class="muted">Cargando viajes...</div>

    <h2>Timeline</h2>

    <div class="toolbar">
      <button id="enableNotifs" class="btn">üîî Activar notificaciones</button>
      <span id="notifStatus" class="hint"></span>
    </div>

    <div id="events" class="muted">Selecciona un viaje para ver su timeline.</div>
  </div>

  <script>
    /* ============================================================
      ‚úÖ CONEXI√ìN A SUPABASE
      - createClient() permite leer tablas "trips" y "events"
      - OJO: este key es p√∫blico (publishable). Est√° bien para lectura
        si tu RLS lo permite. Nunca pongas un service_role aqu√≠.
    ============================================================ */
    const SUPABASE_URL = 'https://lxjaudzhsshyupcgzwla.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_gg_YSsCPShq3Hwr2VtCaYg_6I_p43TT';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    /* ============================================================
      ‚úÖ ESTADO DE APP
      - activeTripId: qu√© viaje est√° seleccionado
    ============================================================ */
    let activeTripId = null;

    /* ============================================================
      ‚úÖ D4.3: CACHE + LOOP DE NOTIFICACIONES (sin recargar)
      - LAST_EVENTS: guarda los eventos del viaje activo (√∫ltima carga)
      - NOTIF_TIMER: interval para reevaluar reglas cada minuto
      - startNotifLoop(): inicia o reinicia el loop sin duplicarlo
    ============================================================ */
    let LAST_EVENTS = [];
    let NOTIF_TIMER = null;

    function startNotifLoop(){
      // Evita tener 2 loops corriendo a la vez
      if (NOTIF_TIMER) clearInterval(NOTIF_TIMER);

      // Cada 60s reevaluamos reglas (2h, 30m, checkin 48h)
      // IMPORTANTE: solo sirve si la pesta√±a sigue abierta.
      NOTIF_TIMER = setInterval(() => {
        if (LAST_EVENTS && LAST_EVENTS.length) {
          runNotificationRules(LAST_EVENTS);
        }
      }, 60 * 1000);
    }

    /* ============================================================
      ‚úÖ UI POR TIPO DE EVENTO
      - icon/color/bg/label define c√≥mo se ve cada tipo
      ‚úÖ BD NORMALIZADA: cruise / car / bus / train
    ============================================================ */
    const TYPE_UI = {
      flight:   { icon:'‚úàÔ∏è', color:'var(--flight)',   bg:'var(--flightBg)',   label:'Vuelo' },
      hotel:    { icon:'üè®', color:'var(--hotel)',    bg:'var(--hotelBg)',    label:'Hotel' },
      activity: { icon:'üéüÔ∏è', color:'var(--activity)', bg:'var(--activityBg)', label:'Actividad' },
      transfer: { icon:'üöó', color:'var(--transfer)', bg:'var(--transferBg)', label:'Traslado' },
      cruise:   { icon:'üõ≥Ô∏è', color:'var(--cruise)', bg:'var(--cruiseBg)', label:'Crucero' },
      car:      { icon:'üöò', color:'var(--car)',    bg:'var(--carBg)',    label:'Auto' },
      bus:      { icon:'üöå', color:'var(--bus)',    bg:'var(--busBg)',    label:'Autob√∫s' },
      train:    { icon:'üöÜ', color:'var(--train)',  bg:'var(--trainBg)',  label:'Tren' },
      other:    { icon:'üìå', color:'var(--other)',  bg:'var(--otherBg)',  label:'Otro' }
    };

    /* ============================================================
      ‚úÖ NUEVO (mejora agrupada #1): Normalizaci√≥n ES ‚Üí EN
      - Para que si en BD viene "crucero/automovil/autobus" tambi√©n matchee
      - Incluye soporte de acentos (autob√∫s/autom√≥vil)
    ============================================================ */
    const TYPE_ALIASES = {
      crucero: 'cruise',
      cruceros: 'cruise',
      automovil: 'car',
      auto: 'car',
      coche: 'car',
      autobus: 'bus',
      autobuses: 'bus',
      camion: 'bus',
      camiones: 'bus',
      camioneta: 'car',
      uber: 'transfer',
      taxi: 'transfer',
      traslado: 'transfer',
      transferencia: 'transfer'
      tren: 'train'
      
    };

    function normalizeType(raw){
      let t = (raw || '').toLowerCase().trim();

      // Quita acentos: "autob√∫s" -> "autobus", "autom√≥vil" -> "automovil"
      try {
        t = t.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      } catch(e) {}

      return TYPE_ALIASES[t] || t;
    }

    /* ============================================================
      ‚úÖ NUEVO (mejora agrupada #2): Anti-duplicados opcional
      - Si lo quieres apagar: pon false
    ============================================================ */
    const ENABLE_DEDUP = true;

    function dedupeEvents(list){
      if (!ENABLE_DEDUP) return list;
      const seen = new Set();
      const out = [];
      for (const e of list) {
        const key = `${String(e.title || '').trim().toLowerCase()}|${String(e.start_time || '')}`;
        if (seen.has(key)) continue;
        seen.add(key);
        out.push(e);
      }
      return out;
    }

    /* ============================================================
      ‚úÖ HELPERS DE FECHA/HORA
      - toDate(): convierte timestamps de Supabase a Date()
      - formatDay(): formatea fecha en espa√±ol
      - formatTime(): formatea hora HH:MM
    ============================================================ */
    function toDate(value) {
      if (!value) return null;
      const clean = String(value).replace('Z','');
      const parts = clean.split(/[-T:.]/);

      const d = new Date(
        Number(parts[0]),
        Number(parts[1]) - 1,
        Number(parts[2]),
        Number(parts[3] || 0),
        Number(parts[4] || 0)
      );
      if (isNaN(d.getTime())) return null;
      return d;
    }

    function formatDay(d) {
      return d.toLocaleDateString('es-MX', { dateStyle: 'medium' });
    }

    function formatTime(d) {
      return d.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
    }

    /* ============================================================
      ‚úÖ AGRUPAR EVENTOS POR D√çA
      - groupByDay(): crea un Map donde la key es YYYY-MM-DD
      - si no hay start_time => "sin-fecha"
    ============================================================ */
    function groupByDay(events) {
      const map = new Map();
      for (const e of events) {
        const d = toDate(e.start_time);
        const key = d
          ? `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`
          : 'sin-fecha';

        if (!map.has(key)) map.set(key, []);
        map.get(key).push(e);
      }
      return map;
    }

    /* ============================================================
      ‚úÖ ESCAPAR TEXTO (seguridad / evitar HTML accidental)
      - esc(): evita que un title/description con "<script>" se ejecute
    ============================================================ */
    function esc(s){
      return String(s ?? '').replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
      }[m]));
    }

    /* ============================================================
      ‚úÖ GOOGLE MAPS LINK
      - Si metadata.coords existe => link directo a lat,lng
      - Si no => usa "location" como b√∫squeda (Opci√≥n A)
    ============================================================ */
    function mapsUrlFromMetaOrLocation(meta, location){
      const coords = meta?.coords;
      if (coords?.lat && coords?.lng) {
        return `https://www.google.com/maps?q=${coords.lat},${coords.lng}`;
      }
      if (location) {
        return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(String(location))}`;
      }
      return null;
    }

    /* ============================================================
      ‚úÖ HELPERS DE TIEMPO RELATIVO (para alertas)
      - msUntil(): ms faltantes para el evento
      - humanCountdown(): ‚Äúen 2h 10m‚Äù o ‚Äúhace 5m‚Äù
    ============================================================ */
    function msUntil(date){
      if (!date) return null;
      return date.getTime() - Date.now();
    }

    function humanCountdown(ms){
      if (ms === null) return null;
      const totalMin = Math.ceil(ms / (60 * 1000));
      const sign = totalMin < 0 ? -1 : 1;
      const absMin = Math.abs(totalMin);

      const h = Math.floor(absMin / 60);
      const m = absMin % 60;
      const txt = h > 0 ? `${h}h ${m}m` : `${m}m`;
      return sign < 0 ? `hace ${txt}` : `en ${txt}`;
    }

    /* ============================================================
      ‚úÖ NOTIFICACIONES DEL NAVEGADOR (D4.2)
      - canNotify(): el navegador soporta Notification API?
      - ensureNotifyPermission(): pide permiso
      - fireNotification(): dispara notificaci√≥n
      - hasNotified()/markNotified(): evita duplicados
      - runNotificationRules(): reglas (2h, 30m, check-in 48h)
    ============================================================ */
    function canNotify() {
      return ("Notification" in window);
    }

    async function ensureNotifyPermission() {
      if (!canNotify()) return false;
      if (Notification.permission === "granted") return true;
      if (Notification.permission === "denied") return false;
      const res = await Notification.requestPermission();
      return res === "granted";
    }

    function fireNotification(title, body) {
      try {
        new Notification(title, { body });
      } catch (e) {
        console.warn("Notification error:", e);
      }
    }

    function notifiedKey(eventId, kind) {
      return `notified:${kind}:${eventId}`;
    }
    function hasNotified(eventId, kind) {
      return localStorage.getItem(notifiedKey(eventId, kind)) === "1";
    }
    function markNotified(eventId, kind) {
      localStorage.setItem(notifiedKey(eventId, kind), "1");
    }

    async function runNotificationRules(events){
      // Si el navegador no soporta, no hacemos nada
      if (!canNotify()) return;

      // Solo notificamos si el usuario ya dio permiso
      if (Notification.permission !== "granted") return;

      const now = Date.now();

      for (const ev of events) {
        const start = toDate(ev.start_time);
        if (!start) continue;

        const meta = (ev.metadata && typeof ev.metadata === 'object') ? ev.metadata : {};

        // ‚úÖ NUEVO: normaliza type para que "crucero/autob√∫s" no rompa reglas
        const type = normalizeType(ev.type);

        const minsToStart = Math.round((start.getTime() - now) / 60000);

        // (1) Notificaci√≥n ~2h antes (ventana 10 min)
        if (minsToStart <= 120 && minsToStart > 110 && !hasNotified(ev.id, "reminder_2h")) {
          fireNotification("üïë Pr√≥ximo evento (2h)", `${ev.title || 'Evento'} ‚Äî en ~2 horas`);
          markNotified(ev.id, "reminder_2h");
        }

        // (2) Notificaci√≥n ~30 min antes (ventana 10 min)
        if (minsToStart <= 30 && minsToStart > 20 && !hasNotified(ev.id, "reminder_30m")) {
          fireNotification("‚è∞ Pr√≥ximo evento (30m)", `${ev.title || 'Evento'} ‚Äî en ~30 minutos`);
          markNotified(ev.id, "reminder_30m");
        }

        // (3) Notificaci√≥n cuando abre check-in (ventana configurable, default 48h)
        if (type === "flight" && meta.checkin_url) {
          const windowHours = Number(meta.checkin_available_window_hours || 48);
          const windowMins = windowHours * 60;

          // Ventana 20 min para capturarlo con un loop de 1 min
          if (minsToStart <= windowMins && minsToStart > (windowMins - 20) && !hasNotified(ev.id, "checkin_open")) {
            fireNotification("‚úÖ Check-in disponible", `${ev.title || 'Vuelo'} ‚Äî ya puedes hacer check-in`);
            markNotified(ev.id, "checkin_open");
          }
        }
      }
    }

    /* ============================================================
      ‚úÖ UI: BOT√ìN ACTIVAR NOTIFICACIONES
      - paintNotifStatus(): actualiza texto/estado del bot√≥n
      - onclick(): pide permiso y, si se activa, corre reglas ‚Äúya‚Äù
    ============================================================ */
    const btnNotifs = document.getElementById("enableNotifs");
    const notifStatus = document.getElementById("notifStatus");

    function paintNotifStatus(){
      if (!canNotify()){
        notifStatus.textContent = "Tu navegador no soporta notificaciones.";
        btnNotifs.disabled = true;
        return;
      }
      const p = Notification.permission;
      if (p === "granted"){
        notifStatus.textContent = "‚úÖ Notificaciones activadas (deja la pesta√±a abierta).";
        btnNotifs.textContent = "‚úÖ Notificaciones activadas";
      } else if (p === "denied"){
        notifStatus.textContent = "‚ö†Ô∏è Bloqueadas en el navegador (act√≠valas en ajustes del sitio).";
      } else {
        notifStatus.textContent = "Act√≠valas para recibir avisos (2h, 30m, check-in 48h).";
      }
    }

    btnNotifs.onclick = async () => {
      const ok = await ensureNotifyPermission();
      if (!ok){
        notifStatus.textContent = "‚ö†Ô∏è No se pudieron activar (revisa permisos del navegador).";
      }
      paintNotifStatus();

      // Si ya hay eventos cargados y ya hay permiso, dispara reglas ahora
      if (Notification.permission === "granted" && LAST_EVENTS.length) {
        runNotificationRules(LAST_EVENTS);
      }
    };

    paintNotifStatus();

    /* ============================================================
      ‚úÖ ALERTAS EN UI (D4.1) ‚Äî chips dentro de la tarjeta
      - Check-in disponible si faltan <= ventana (default 48h)
      - Aviso ‚ÄúSalir al aeropuerto‚Äù si faltan <= 3h
      (Estas son VISUALES, no notificaci√≥n)
    ============================================================ */
    function renderAlerts(event){
      // ‚úÖ NUEVO: normaliza type para ES/acentos
      const type = normalizeType(event.type);

      const meta = event.metadata && typeof event.metadata === 'object' ? event.metadata : {};
      const start = toDate(event.start_time);
      if (!start) return '';

      const alerts = [];

      if (type === 'flight' && meta.checkin_url) {
        const ms = msUntil(start);
        const hoursToStart = ms / (60 * 60 * 1000);
        const windowHours = Number(meta.checkin_available_window_hours || 48);

        if (hoursToStart <= windowHours && hoursToStart > -24) {
          alerts.push(`<span class="alert-badge ok">‚úÖ Check-in disponible</span>`);
        } else if (hoursToStart > windowHours) {
          const msToOpen = ms - (windowHours*60*60*1000);
          alerts.push(`<span class="alert-badge warn">üïí Check-in ${humanCountdown(msToOpen)}</span>`);
        }
      }

      if (type === 'flight') {
        const ms = msUntil(start);
        const hours = ms / (60 * 60 * 1000);
        if (hours <= 3 && hours > 0) {
          alerts.push(`<span class="alert-badge danger">‚è∞ Salir al aeropuerto ${humanCountdown(ms)}</span>`);
        }
      }

      return alerts.length ? `<div class="alert-row">${alerts.join('')}</div>` : '';
    }

    /* ============================================================
      ‚úÖ BADGES PRO (metadata)
      - Pinta info de metadata por tipo (flight/hotel/activity/transfer)
      - Tambi√©n agrega el badge de üìç location con link a Google Maps
      ‚úÖ NUEVO:
        - car/bus usan pickup/dropoff/company igual que transfer
        - cruise muestra operator/cabin/reference si existen
        - train (opcional) muestra company/reference si existen
    ============================================================ */
    function renderProBadges(event){
      const meta = event.metadata;
      const badges = [];

      // Location + link ‚ÄúMapa‚Äù
      if (event.location) {
        const url = mapsUrlFromMetaOrLocation(meta, event.location);
        badges.push(
          `<span class="pro-badge">
            <strong>üìç</strong> ${esc(event.location)}
            ${url ? `&nbsp;¬∑&nbsp;<a href="${url}" target="_blank" rel="noopener">Mapa</a>` : ``}
          </span>`
        );
      }

      // source como badge
      if (event.source) badges.push(`<span class="pro-badge"><strong>source:</strong> ${esc(event.source)}</span>`);

      if (!meta || typeof meta !== 'object') {
        return badges.length ? `<div class="pro-row">${badges.join('')}</div>` : '';
      }

      // OJO: aqu√≠ dejamos tu l√≥gica como estaba (type sin normalizar),
      // porque tus ifs est√°n en ingl√©s y tu BD idealmente igual.
      // Si quieres hacerlo 100% robusto, lo normalizo tambi√©n.
      const type = normalizeType(event.type);

      /* ‚úÖ OPCIONAL (si guardas ‚Äúsubtype‚Äù en metadata):
         - Si type === activity y meta.subtype existe, lo mostramos como badge.
      */
      if (type === 'activity' && meta.subtype) {
        badges.push(`<span class="pro-badge"><strong>subtype:</strong> ${esc(meta.subtype)}</span>`);
      }

      if (type === 'flight') {
        if (meta.flight_number) badges.push(`<span class="pro-badge"><strong>Vuelo:</strong> ${esc(meta.flight_number)}</span>`);
        if (meta.airline) badges.push(`<span class="pro-badge"><strong>Aerol√≠nea:</strong> ${esc(meta.airline)}</span>`);
        if (meta.seat) badges.push(`<span class="pro-badge"><strong>Asiento:</strong> ${esc(meta.seat)}</span>`);
        if (Array.isArray(meta.documents) && meta.documents.length) {
          badges.push(`<span class="pro-badge"><strong>Docs:</strong> ${esc(meta.documents.join(', '))}</span>`);
        }
        if (meta.pnr) badges.push(`<span class="pro-badge"><strong>PNR:</strong> ${esc(meta.pnr)}</span>`);

        if (meta.checkin_url) badges.push(`<span class="pro-badge"><strong>Check-in:</strong> <a href="${esc(meta.checkin_url)}" target="_blank" rel="noopener">abrir</a></span>`);
        if (meta.booking_url) badges.push(`<span class="pro-badge"><strong>Reserva:</strong> <a href="${esc(meta.booking_url)}" target="_blank" rel="noopener">abrir</a></span>`);
      }

      if (type === 'hotel') {
        if (meta.hotel_name) badges.push(`<span class="pro-badge"><strong>Hotel:</strong> ${esc(meta.hotel_name)}</span>`);
        if (meta.check_in) badges.push(`<span class="pro-badge"><strong>Check-in:</strong> ${esc(meta.check_in)}</span>`);
        if (meta.check_out) badges.push(`<span class="pro-badge"><strong>Check-out:</strong> ${esc(meta.check_out)}</span>`);
        if (meta.address) badges.push(`<span class="pro-badge"><strong>Direcci√≥n:</strong> ${esc(meta.address)}</span>`);
        if (meta.reservation) badges.push(`<span class="pro-badge"><strong>Reserva:</strong> ${esc(meta.reservation)}</span>`);
        if (meta.booking_url) badges.push(`<span class="pro-badge"><strong>Reserva:</strong> <a href="${esc(meta.booking_url)}" target="_blank" rel="noopener">abrir</a></span>`);
      }

      if (type === 'activity') {
        if (meta.place) badges.push(`<span class="pro-badge"><strong>Lugar:</strong> ${esc(meta.place)}</span>`);
        if (meta.operator) badges.push(`<span class="pro-badge"><strong>Operador:</strong> ${esc(meta.operator)}</span>`);
        if (meta.ticket_url) badges.push(`<span class="pro-badge"><strong>Link:</strong> <a href="${esc(meta.ticket_url)}" target="_blank" rel="noopener">abrir</a></span>`);
        if (meta.reference) badges.push(`<span class="pro-badge"><strong>Ref:</strong> ${esc(meta.reference)}</span>`);
      }

      // ‚úÖ transfer + car + bus comparten l√≥gica de traslado
      if (type === 'transfer' || type === 'car' || type === 'bus') {
        if (meta.pickup) badges.push(`<span class="pro-badge"><strong>Pickup:</strong> ${esc(meta.pickup)}</span>`);
        if (meta.dropoff) badges.push(`<span class="pro-badge"><strong>Dropoff:</strong> ${esc(meta.dropoff)}</span>`);
        if (meta.company) badges.push(`<span class="pro-badge"><strong>Proveedor:</strong> ${esc(meta.company)}</span>`);
        if (meta.reference) badges.push(`<span class="pro-badge"><strong>Ref:</strong> ${esc(meta.reference)}</span>`);
      }

      // ‚úÖ cruise: campos t√≠picos (si los guardas en metadata)
      if (type === 'cruise') {
        if (meta.operator) badges.push(`<span class="pro-badge"><strong>Operador:</strong> ${esc(meta.operator)}</span>`);
        if (meta.cabin) badges.push(`<span class="pro-badge"><strong>Cabina:</strong> ${esc(meta.cabin)}</span>`);
        if (meta.reference) badges.push(`<span class="pro-badge"><strong>Ref:</strong> ${esc(meta.reference)}</span>`);
      }

      // ‚úÖ train (si guardas datos en metadata)
      if (type === 'train') {
        if (meta.company) badges.push(`<span class="pro-badge"><strong>Operador:</strong> ${esc(meta.company)}</span>`);
        if (meta.reference) badges.push(`<span class="pro-badge"><strong>Ref:</strong> ${esc(meta.reference)}</span>`);
      }

      // Si hay metadata pero no coincide con campos esperados
      if (Object.keys(meta).length && badges.length === 0) {
        badges.push(`<span class="pro-badge"><strong>meta:</strong> ${esc(Object.keys(meta).slice(0,4).join(', '))}${Object.keys(meta).length>4 ? '‚Ä¶' : ''}</span>`);
      }

      return badges.length ? `<div class="pro-row">${badges.join('')}</div>` : '';
    }

    async function loadTrips() {
      const tripsDiv = document.getElementById('trips');
      tripsDiv.classList.add('muted');
      tripsDiv.innerHTML = 'Cargando viajes...';

      const { data, error } = await sb.from('trips').select('*').order('start_date', { ascending: true });

      if (error) {
        tripsDiv.innerText = 'Error cargando viajes: ' + error.message;
        return;
      }

      if (!data || data.length === 0) {
        tripsDiv.innerHTML = `<div class="empty">No hay viajes a√∫n.</div>`;
        return;
      }

      tripsDiv.classList.remove('muted');
      tripsDiv.innerHTML = '';

      data.forEach(trip => {
        const div = document.createElement('div');
        div.className = 'trip' + (trip.id === activeTripId ? ' active' : '');
        div.innerHTML = `<strong>${esc(trip.title)}</strong>`;

        div.onclick = () => {
          activeTripId = trip.id;
          [...document.querySelectorAll('.trip')].forEach(x => x.classList.remove('active'));
          div.classList.add('active');
          loadEvents(trip.id);
        };

        tripsDiv.appendChild(div);
      });

      if (!activeTripId) {
        activeTripId = data[0].id;
        const first = document.querySelector('.trip');
        if (first) first.classList.add('active');
        loadEvents(activeTripId);
      }
    }

    async function loadEvents(tripId) {
      const eventsDiv = document.getElementById('events');
      eventsDiv.classList.remove('muted');
      eventsDiv.innerHTML = 'Cargando timeline...';

      const { data, error } = await sb
        .from('events')
        .select('*')
        .eq('trip_id', tripId)
        .order('order_index', { ascending: true, nullsFirst: false })
        .order('start_time', { ascending: true });

      if (error) {
        eventsDiv.innerText = 'Error cargando eventos: ' + error.message;
        return;
      }

      if (!data || data.length === 0) {
        eventsDiv.innerHTML = `<div class="empty">Este viaje a√∫n no tiene eventos.</div>`;
        return;
      }

      // ‚úÖ NUEVO: opcional anti-duplicados (si hubo carga doble)
      const dataClean = dedupeEvents(data);

      LAST_EVENTS = dataClean;
      startNotifLoop();

      await runNotificationRules(dataClean);

      const grouped = groupByDay(dataClean);
      const dayKeys = Array.from(grouped.keys()).sort((a,b) => {
        if (a === 'sin-fecha') return 1;
        if (b === 'sin-fecha') return -1;
        return a.localeCompare(b);
      });

      eventsDiv.innerHTML = '';

      for (const dayKey of dayKeys) {
        const list = grouped.get(dayKey) || [];

        list.sort((a,b) => {
          const ai = (a.order_index ?? null);
          const bi = (b.order_index ?? null);
          if (ai !== null && bi !== null && ai !== bi) return ai - bi;
          if (ai !== null && bi === null) return -1;
          if (ai === null && bi !== null) return 1;

          const da = toDate(a.start_time);
          const db = toDate(b.start_time);
          if (!da && !db) return 0;
          if (!da) return 1;
          if (!db) return -1;
          return da - db;
        });

        const dayRow = document.createElement('div');
        dayRow.className = 'day-row';

        const pill = document.createElement('div');
        pill.className = 'day';

        if (dayKey === 'sin-fecha') {
          pill.textContent = 'Sin fecha';
        } else {
          const parts = dayKey.split('-');
          const d = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
          pill.textContent = formatDay(d);
        }

        dayRow.appendChild(pill);
        const line = document.createElement('div');
        line.className = 'day-line';
        dayRow.appendChild(line);
        eventsDiv.appendChild(dayRow);

        for (const event of list) {
          // ‚úÖ NUEVO: normalizaci√≥n aplicada aqu√≠ tambi√©n
          const type = normalizeType(event.type);

          const meta = (event.metadata && typeof event.metadata === 'object') ? event.metadata : {};
          const subtype = normalizeType(meta.subtype);

          const ui =
            (type === 'activity' && subtype && TYPE_UI[subtype])
              ? TYPE_UI[subtype]
              : (TYPE_UI[type] || TYPE_UI.other);

          const d = toDate(event.start_time);
          const time = d ? formatTime(d) : '--:--';

          const alertsHtml = renderAlerts(event);
          const proBadgesHtml = renderProBadges(event);

          const card = document.createElement('div');
          card.className = 'event';

          card.innerHTML = `
            <div class="icon" style="background:${ui.bg}; border:1px solid var(--border);">
              <span style="color:${ui.color}">${ui.icon}</span>
            </div>
            <div class="event-body">
              <div class="event-top">
                <p class="event-title">${esc(event.title || '(sin t√≠tulo)')}</p>
                <div class="event-time">${esc(time)}</div>
              </div>
              ${event.description ? `<div class="event-desc">${esc(event.description)}</div>` : ``}
              ${alertsHtml}
              ${proBadgesHtml}
              <div class="event-meta">
                <span class="badge">${ui.label}</span>
                <span class="badge">tipo: ${esc(event.type || 'unknown')}</span>
              </div>
            </div>
          `;

          eventsDiv.appendChild(card);
        }
      }
    }

    setInterval(() => {
      if (activeTripId) loadEvents(activeTripId);
    }, 2 * 60 * 1000);

    loadTrips();
  </script>
</body>
</html>
